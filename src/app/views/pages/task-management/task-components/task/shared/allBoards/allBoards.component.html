<div
  class="tw-bg-gradient-to-br tw-from-slate-50 tw-to-blue-50 tw-p-6"
  (click)="onDocumentClick()"
>
  <!-- Header Section -->
  <div class=" tw-mx-auto tw-mb-8">
    <div class="tw-flex tw-justify-between tw-items-center tw-mb-6">
      <div>
        <h1 class="tw-text-3xl tw-font-bold tw-text-gray-900 tw-mb-2">
          Project Boards
        </h1>
        <p class="tw-text-gray-600">
          Manage and organize your team's project boards
        </p>
      </div>

      <!-- Search Bar -->
      <div class="tw-relative">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          placeholder="Search boards..."
          class="tw-w-80 tw-pl-10 tw-pr-4 tw-py-3 tw-border tw-border-gray-200 tw-rounded-xl tw-focus:outline-none tw-focus:ring-2 tw-focus:ring-blue-500 tw-focus:border-transparent tw-bg-white tw-shadow-sm tw-transition-all tw-duration-200"
        />
        <svg
          class="tw-absolute tw-left-3 tw-top-3.5 tw-h-5 tw-w-5 tw-text-gray-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
          ></path>
        </svg>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div
    *ngIf="loading"
    class="tw-flex tw-justify-center tw-items-center tw-py-16"
  >
    <div
      class="tw-animate-spin tw-rounded-full tw-h-12 tw-w-12 tw-border-b-2 tw-border-blue-600"
    ></div>
  </div>

  <!-- Boards Grid -->
  <div class="tw-mx-auto">
    <div class="tw-flex tw-flex-wrap tw-gap-6">
      <!-- Add New Board Card -->
      <div
        *ngIf="!loading && taskPermissionsService.getCurrentUserRoleRank() >= 4"
        (click)="onCreateNewBoard()"
        class="tw-group tw-bg-white tw-rounded-2xl tw-shadow-sm tw-border-2 tw-border-dashed tw-border-gray-200 tw-p-8 tw-cursor-pointer tw-transition-all tw-duration-300 hover:tw-border-blue-400 hover:tw-shadow-lg hover:tw-scale-105 tw-flex tw-flex-col tw-items-center tw-justify-center tw-min-h-[300px] tw-min-w-[300px] tw-max-h-[300px] tw-max-w-[300px]"
      >
        <div
          class="tw-w-16 tw-h-16 tw-bg-blue-100 tw-rounded-full tw-flex tw-items-center tw-justify-center tw-mb-4 tw-transition-all tw-duration-300 group-hover:tw-bg-blue-200 group-hover:tw-scale-110"
        >
          <svg
            class="tw-w-8 tw-h-8 tw-text-blue-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 4v16m8-8H4"
            ></path>
          </svg>
        </div>
        <h3
          class="tw-text-lg tw-font-semibold tw-text-gray-700 tw-mb-2 group-hover:tw-text-blue-600 tw-transition-colors tw-duration-300"
        >
          Create New Board
        </h3>
        <p class="tw-text-sm tw-text-gray-500 tw-text-center">
          Start a new project board to organize your team's work
        </p>
      </div>

      <!-- Board Cards -->
      <div
        *ngFor="let board of filteredBoards()"
        class="tw-group tw-bg-white tw-rounded-2xl tw-shadow-sm tw-border tw-border-gray-100 tw-cursor-pointer tw-transition-all tw-duration-300 hover:tw-shadow-xl hover:tw-scale-105 tw-relative tw-min-h-[300px] tw-min-w-[300px] tw-max-h-[300px] tw-max-w-[300px] tw-overflow-x-auto tw-select-none"
        [class.tw-ring-2]="selectedBoard()?._id === board._id"
        [class.tw-ring-blue-500]="selectedBoard()?._id === board._id"
        [class.tw-animate-pulse]="expandingBoardId() === board._id"
        (dblclick)="onOpenBoard(board)"
        (click)="onBoardClick(board, $event)"
      >
        <!-- Board Header -->
        <div class="tw-p-6 tw-pb-4">
          <div class="tw-flex tw-justify-between tw-items-start tw-mb-3">
            <h3
              class="tw-text-xl tw-font-bold tw-text-gray-900 tw-leading-tight tw-line-clamp-2 tw-overflow-hidden tw-text-ellipsis hover:tw-cursor-pointer"
              title="{{ board.name }}"
            >
              {{ board.name }}
            </h3>

            <!-- Categories Icon -->
            <button
              (click)="onShowCategories(board, $event)"
              *ngIf="!taskPermissionsService.isManagementLevelPermission()"
              class="tw-p-2 tw-rounded-lg tw-text-gray-400 hover:tw-text-blue-600 hover:tw-bg-blue-50 tw-transition-all tw-duration-200"
              title="Manage Categories"
            >
              <svg
                class="tw-w-5 tw-h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.99 1.99 0 013 12V7a4 4 0 014-4z"
                ></path>
              </svg>
            </button>

            <!-- Action Dropdown -->
            <div class="tw-relative" (click)="$event.stopPropagation()" *ngIf="taskPermissionsService.isManagementLevelPermission()">
              <button
                (click)="toggleActionDropdown(board._id)"
                class="tw-p-2 tw-rounded-lg tw-text-gray-400 hover:tw-text-blue-600 hover:tw-bg-blue-50 tw-transition-all tw-duration-200"
                title="Board Actions"
              >
                <svg
                  class="tw-w-5 tw-h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zM12 13a1 1 0 110-2 1 1 0 010 2zM12 20a1 1 0 110-2 1 1 0 010 2z"
                  ></path>
                </svg>
              </button>

              <!-- Dropdown Menu -->
              <div
                *ngIf="showActionDropdown() === board._id"
                class="tw-absolute tw-right-0 tw-top-full tw-mt-2 tw-w-48 tw-bg-white tw-rounded-lg tw-shadow-lg tw-border tw-border-gray-200 tw-py-2 tw-z-50"
              >
                <button
                  (click)="onShowCategories(board, $event)"
                  class="tw-w-full tw-px-4 tw-py-2 tw-text-left tw-text-sm tw-text-gray-700 hover:tw-bg-gray-100 tw-flex tw-items-center tw-gap-3"
                >
                  <svg
                    class="tw-w-4 tw-h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.99 1.99 0 013 12V7a4 4 0 014-4z"
                    ></path>
                  </svg>
                  Categories
                </button>

                <button
                  *ngIf="taskPermissionsService.getCurrentUserRoleRank() >= 4"
                  (click)="onEditBoard(board, $event)"
                  class="tw-w-full tw-px-4 tw-py-2 tw-text-left tw-text-sm tw-text-gray-700 hover:tw-bg-gray-100 tw-flex tw-items-center tw-gap-3"
                >
                  <svg
                    class="tw-w-4 tw-h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                    ></path>
                  </svg>
                  Edit Board
                </button>

                <button
                  *ngIf="taskPermissionsService.getCurrentUserRoleRank() >= 4"
                  (click)="onDeleteBoard(board, $event)"
                  class="tw-w-full tw-px-4 tw-py-2 tw-text-left tw-text-sm tw-text-red-600 hover:tw-bg-red-50 tw-flex tw-items-center tw-gap-3"
                >
                  <svg
                    class="tw-w-4 tw-h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                    ></path>
                  </svg>
                  Delete Board
                </button>
              </div>
            </div>
          </div>

          <!-- Description with Tooltip -->
          <div class="tw-relative">
            <p
              class="tw-text-gray-600 tw-text-sm tw-leading-relaxed tw-line-clamp-2 tw-overflow-hidden tw-text-ellipsis hover:tw-cursor-pointer"
              title="{{ board.description }}"
            >
              {{ board.description }}
            </p>

            <!-- Tooltip -->
            <div
              *ngIf="
                hoveredDescription() === board.description &&
                board.description.length > 60
              "
              class="tw-absolute tw-z-50 tw-bg-gray-900 tw-text-white tw-text-xs tw-rounded-lg tw-px-3 tw-py-2 tw-max-w-xs tw-shadow-lg tw-top-full tw-left-0 tw-mt-2 tw-animate-fade-in"
            >
              {{ board.description }}
              <div
                class="tw-absolute tw-bottom-full tw-left-4 tw-w-0 tw-h-0 tw-border-l-4 tw-border-r-4 tw-border-b-4 tw-border-transparent tw-border-b-gray-900"
              ></div>
            </div>
          </div>
        </div>

        <div class="tw-m-auto tw-mt-2">
          <!-- Categories Pills -->
          <div class="tw-px-6 tw-pb-4">
            <div class="tw-flex tw-flex-wrap tw-gap-2">
              <span
                *ngFor="
                  let category of board.categories.slice(0, 2);
                  trackBy: trackByCategoryId
                "
                class="tw-inline-flex tw-items-center tw-px-2.5 tw-py-1 tw-rounded-full tw-text-xs tw-font-medium tw-bg-blue-100 tw-text-blue-800"
                [class.tw-hidden]="category.isDeleted"
              >
                {{ category.name }}
              </span>
              <span
                *ngIf="getNonDeletedCategoriesCount(board.categories) > 2"
                class="tw-inline-flex tw-items-center tw-px-2.5 tw-py-1 tw-rounded-full tw-text-xs tw-font-medium tw-bg-gray-100 tw-text-gray-600 hover:tw-cursor-pointer hover:tw-bg-gray-200 hover:tw-scale-105"
                (click)="onShowCategories(board, $event)"
              >
                +{{ getNonDeletedCategoriesCount(board.categories) - 2 }} more
              </span>
            </div>
          </div>

          <!-- Board Footer -->
          <div class="tw-px-6 tw-pb-6 tw-mt-auto">
            <div
              class="tw-flex tw-justify-between tw-items-center tw-text-sm tw-text-gray-500 tw-mb-4"
            >
              <span>Created: {{ formatDate(board.createdAt) }}</span>
              <!-- <span
                class="tw-px-2 tw-py-1 tw-bg-green-100 tw-text-green-700 tw-rounded-full tw-text-xs tw-font-medium"
              >
                {{ board.type }}
              </span> -->
            </div>
          </div>
        </div>

        <!-- Joined Members Component -->
        <div class="tw-absolute tw-bottom-6 tw-right-6">
          <app-joined-members
            [members]="board.members"
            [boardId]="board._id"
            (showAllMembers)="onShowMembers(board, $event)"
            (addMember)="onShowAddMember(board, $event)"
          ></app-joined-members>
        </div>

        <!-- Open Button (appears when board is selected) -->
        <!-- *ngIf="selectedBoard()?._id === board._id" -->
        <div
          class="tw-absolute tw-bottom-6 tw-left-6 tw-animate-fade-in"
        >
          <button
            (click)="onOpenBoard(board)"
            class="tw-bg-blue-600 tw-text-white tw-px-4 tw-py-2 tw-rounded-lg tw-font-medium tw-text-sm tw-shadow-lg hover:tw-bg-blue-700 tw-transition-all tw-duration-200 tw-transform hover:tw-scale-105"
          >
            Open Board
          </button>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div
      *ngIf="
        !loading &&
        filteredBoards().length === 0 &&
        taskPermissionsService.getCurrentUserRoleRank() !== 5
      "
      class="tw-text-center tw-py-16"
    >
      <div
        class="tw-w-24 tw-h-24 tw-bg-gray-100 tw-rounded-full tw-flex tw-items-center tw-justify-center tw-mx-auto tw-mb-4"
      >
        <svg
          class="tw-w-12 tw-h-12 tw-text-gray-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
          ></path>
        </svg>
      </div>
      <h3 class="tw-text-lg tw-font-medium tw-text-gray-900 tw-mb-2">
        No boards found
      </h3>
      <p class="tw-text-gray-500 tw-mb-6">
        Please Contact your administrator Join an existing one.
      </p>
      <!-- <button
        (click)="onCreateNewBoard()"
        class="tw-bg-blue-600 tw-text-white tw-px-6 tw-py-3 tw-rounded-lg tw-font-medium hover:tw-bg-blue-700 tw-transition-colors tw-duration-200"
      >
        Create Your First Board
      </button> -->
    </div>
  </div>

  <!-- Categories Modal -->
  <div
    *ngIf="showCategoriesModal()"
    class="tw-fixed tw-inset-0 tw-bg-black tw-bg-opacity-50 tw-flex tw-items-center tw-justify-center tw-z-50 tw-animate-fade-in"
    (click)="onCloseModal()"
  >
    <div
      class="tw-bg-white tw-rounded-2xl tw-p-6 tw-w-full tw-max-w-md tw-mx-4 tw-animate-scale-in tw-max-h-[80vh] tw-overflow-y-auto"
      (click)="$event.stopPropagation()"
    >
      <div class="tw-flex tw-justify-between tw-items-center tw-mb-6">
        <h3 class="tw-text-xl tw-font-bold tw-text-gray-900">
          {{
            taskPermissionsService.getCurrentUserRoleRank() >= 4
              ? "Manage"
              : "All"
          }}
          Categories
        </h3>
        <button
          (click)="onCloseModal()"
          class="tw-text-gray-400 hover:tw-text-gray-600 tw-transition-colors tw-duration-200"
        >
          <svg
            class="tw-w-6 tw-h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>

      <!-- Add New Category -->
      <div
        *ngIf="taskPermissionsService.getCurrentUserRoleRank() >= 4"
        class="tw-mb-6"
      >
        <div class="tw-flex tw-gap-2">
          <input
            type="text"
            [(ngModel)]="newCategoryName"
            placeholder="Enter category name"
            class="tw-flex-1 tw-px-3 tw-py-2 tw-border tw-border-gray-200 tw-rounded-lg tw-focus:outline-none tw-focus:ring-2 tw-focus:ring-blue-500"
            (keyup.enter)="onAddCategory()"
          />
          <button
            (click)="onAddCategory()"
            [disabled]="
              isNewCategoryNameEmpty() || !isNewCategoryNameIsUnique()
            "
            class="tw-bg-blue-600 tw-text-white tw-px-4 tw-py-2 tw-rounded-lg tw-font-medium hover:tw-bg-blue-700 tw-transition-colors tw-duration-200 disabled:tw-opacity-50 disabled:tw-cursor-not-allowed"
          >
            Add
          </button>
        </div>
        <p
          *ngIf="!isNewCategoryNameIsUnique()"
          class="tw-text-xs tw-text-red-500 tw-mt-2"
        >
          Category name must be unique
        </p>
      </div>

      <!-- Categories List Section -->
      <div class="tw-mb-6">
        <!-- Existing Categories -->
        <div *ngIf="editingCategories().length > 0" class="tw-mb-4">
          <h4
            *ngIf="taskPermissionsService.getCurrentUserRoleRank() >= 4"
            class="tw-text-sm tw-font-semibold tw-text-gray-700 tw-mb-3 tw-uppercase tw-tracking-wide"
          >
            Existing Categories
          </h4>
          <div class="tw-space-y-2">
            <div
              *ngFor="let category of editingCategories()"
              class="tw-flex tw-justify-between tw-items-center tw-p-3 tw-bg-blue-50 tw-border tw-border-blue-100 tw-rounded-lg"
            >
              <div class="tw-flex tw-items-center">
                <div
                  class="tw-w-2 tw-h-2 tw-bg-blue-500 tw-rounded-full tw-mr-3"
                ></div>
                <span class="tw-font-medium tw-text-gray-700">{{
                  category.name
                }}</span>
              </div>
              <button
                *ngIf="taskPermissionsService.getCurrentUserRoleRank() >= 4"
                (click)="onRemoveExistingCategory(category._id)"
                class="tw-text-red-500 hover:tw-text-red-700 tw-p-1 tw-rounded-full hover:tw-bg-red-50 tw-transition-all tw-duration-200"
                title="Remove category"
              >
                <svg
                  class="tw-w-4 tw-h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                  ></path>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- New Categories -->
        <div *ngIf="newCategories().length > 0" class="tw-mb-4">
          <h4
            class="tw-text-sm tw-font-semibold tw-text-gray-700 tw-mb-3 tw-uppercase tw-tracking-wide"
          >
            New Categories
          </h4>
          <div class="tw-space-y-2">
            <div
              *ngFor="let category of newCategories()"
              class="tw-flex tw-justify-between tw-items-center tw-p-3 tw-bg-green-50 tw-border tw-border-green-100 tw-rounded-lg"
            >
              <div class="tw-flex tw-items-center">
                <div
                  class="tw-w-2 tw-h-2 tw-bg-green-500 tw-rounded-full tw-mr-3"
                ></div>
                <span class="tw-font-medium tw-text-gray-700">{{
                  category.name
                }}</span>
                <span
                  class="tw-ml-2 tw-px-2 tw-py-1 tw-bg-green-100 tw-text-green-700 tw-text-xs tw-rounded-full tw-font-medium"
                >
                  New
                </span>
              </div>
              <button
                *ngIf="taskPermissionsService.getCurrentUserRoleRank() >= 4"
                (click)="onRemoveNewCategory(category._id)"
                class="tw-text-red-500 hover:tw-text-red-700 tw-p-1 tw-rounded-full hover:tw-bg-red-50 tw-transition-all tw-duration-200"
                title="Remove new category"
              >
                <svg
                  class="tw-w-4 tw-h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  ></path>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div
          *ngIf="
            editingCategories().length === 0 && newCategories().length === 0
          "
          class="tw-text-center tw-py-8"
        >
          <div
            class="tw-w-16 tw-h-16 tw-bg-gray-100 tw-rounded-full tw-flex tw-items-center tw-justify-center tw-mx-auto tw-mb-4"
          >
            <svg
              class="tw-w-8 tw-h-8 tw-text-gray-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.99 1.99 0 013 12V7a4 4 0 014-4z"
              ></path>
            </svg>
          </div>
          <h4 class="tw-text-sm tw-font-medium tw-text-gray-900 tw-mb-2">
            No categories
          </h4>
          <p class="tw-text-xs tw-text-gray-500">
            Add some categories to organize your board
          </p>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="tw-flex tw-gap-3">
        <button
          (click)="onCloseModal()"
          class="tw-flex-1 tw-px-4 tw-py-2 tw-border tw-border-gray-200 tw-text-gray-700 tw-rounded-lg tw-font-medium hover:tw-bg-gray-50 tw-transition-colors tw-duration-200"
        >
          Cancel
        </button>

        <!-- Update Button - Only shown if user has permissions and there are changes -->
        <button
          *ngIf="
            taskPermissionsService.getCurrentUserRoleRank() >= 4 && hasChanges()
          "
          (click)="onUpdateCategories()"
          class="tw-flex-1 tw-bg-blue-600 tw-text-white tw-px-4 tw-py-2 tw-rounded-lg tw-font-medium hover:tw-bg-blue-700 tw-transition-colors tw-duration-200 tw-shadow-lg"
        >
          Update Categories
        </button>

        <!-- View Only Button - Shown when no changes or no permissions -->
        <button
          *ngIf="
            taskPermissionsService.getCurrentUserRoleRank() >= 4 &&
            !hasChanges()
          "
          disabled
          class="tw-flex-1 tw-bg-gray-300 tw-text-gray-500 tw-px-4 tw-py-2 tw-rounded-lg tw-font-medium tw-cursor-not-allowed"
        >
          No Changes
        </button>
      </div>
    </div>
  </div>

  <!-- Members Modal -->
  <div
    *ngIf="showMembersModal()"
    class="tw-fixed tw-inset-0 tw-bg-black tw-bg-opacity-50 tw-flex tw-items-center tw-justify-center tw-z-50 tw-animate-fade-in"
    (click)="onCloseModal()"
  >
    <div
      class="tw-bg-white tw-rounded-2xl tw-p-6 tw-w-full tw-max-w-lg tw-mx-4 tw-max-h-[80vh] tw-overflow-y-auto tw-animate-scale-in"
      (click)="$event.stopPropagation()"
    >
      <div class="tw-flex tw-justify-between tw-items-center tw-mb-6">
        <h3 class="tw-text-xl tw-font-bold tw-text-gray-900">Board Members</h3>
        <button
          (click)="onCloseModal()"
          class="tw-text-gray-400 hover:tw-text-gray-600 tw-transition-colors tw-duration-200"
        >
          <svg
            class="tw-w-6 tw-h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>

      <!-- Members List -->
      <div class="tw-space-y-3 tw-mb-6">
        <div
          *ngFor="let member of selectedBoard()?.members"
          class="tw-flex tw-items-center tw-p-4 tw-bg-gray-50 tw-rounded-lg tw-hover:bg-gray-100 tw-transition-colors tw-duration-200"
        >
          <!-- Member Avatar -->
          <div
            class="tw-w-12 tw-h-12 tw-rounded-full tw-overflow-hidden tw-border-2 tw-border-white tw-shadow-sm tw-mr-4"
          >
            <img
              *ngIf="member.profileImage; else memberInitialsTemplate"
              [src]="imageURL + member.profileImage"
              [alt]="member.name"
              class="tw-w-full tw-h-full tw-object-cover"
            />
            <ng-template #memberInitialsTemplate>
              <div
                class="tw-w-full tw-h-full tw-bg-gradient-to-br tw-from-blue-500 tw-to-purple-600 tw-flex tw-items-center tw-justify-center tw-text-white tw-text-sm tw-font-semibold"
              >
                {{ getMemberInitials(member.name) }}
              </div>
            </ng-template>
          </div>

          <!-- Member Info -->
          <div class="tw-flex-1">
            <h4 class="tw-font-semibold tw-text-gray-900 tw-text-sm">
              {{ member.name }}
            </h4>
            <p class="tw-text-xs tw-text-gray-500">{{ member.emailId }}</p>
            <span
              class="tw-inline-flex tw-items-center tw-px-2 tw-py-1 tw-rounded-full tw-text-xs tw-font-medium tw-bg-blue-100 tw-text-blue-800 tw-mt-1 tw-capitalize"
            >
              {{ member.role }}
            </span>
          </div>
        </div>
      </div>

      <div
        *ngIf="selectedBoard()?.members?.length === 0"
        class="tw-text-center tw-py-8"
      >
        <div
          class="tw-w-16 tw-h-16 tw-bg-gray-100 tw-rounded-full tw-flex tw-items-center tw-justify-center tw-mx-auto tw-mb-4"
        >
          <i class="fa-solid fa-people-group tw-text-2xl"></i>
        </div>
        <h4 class="tw-text-sm tw-font-medium tw-text-gray-900 tw-mb-2">
          No Joined Users
        </h4>
        <p class="tw-text-xs tw-text-gray-500">
          Add some MEmber to organize your board
        </p>
      </div>

      <!-- Add Member Button -->
      <div
        *ngIf="taskPermissionsService.getCurrentUserRoleRank() >= 3"
        class="tw-flex tw-gap-3"
      >
        <button
          (click)="onCloseModal()"
          class="tw-flex-1 tw-px-4 tw-py-2 tw-border tw-border-gray-200 tw-text-gray-700 tw-rounded-lg tw-font-medium hover:tw-bg-gray-50 tw-transition-colors tw-duration-200"
        >
          Close
        </button>
        <button
          (click)="onShowAddMember(selectedBoard(), $event)"
          class="tw-flex-1 tw-bg-blue-600 tw-text-white tw-px-4 tw-py-2 tw-rounded-lg tw-font-medium hover:tw-bg-blue-700 tw-transition-colors tw-duration-200"
        >
          {{
            selectedBoard()?.members?.length === 0
              ? "Add Member"
              : "Update Members"
          }}
        </button>
      </div>
    </div>
  </div>

  <div
    *ngIf="showAddMemberModal()"
    class="tw-fixed tw-inset-0 tw-bg-black tw-bg-opacity-50 tw-flex tw-items-center tw-justify-center tw-z-50 tw-animate-fade-in"
    (click)="onCloseModal()"
  >
    <div
      class="tw-bg-white tw-rounded-2xl tw-w-full tw-max-w-lg tw-mx-4 tw-flex tw-flex-col tw-max-h-[80vh] overflow-hidden tw-shadow-2xl"
      (click)="$event.stopPropagation()"
    >
      <!-- Fixed Header -->
      <div
        class="tw-flex tw-justify-between tw-items-center tw-p-6 tw-border-b tw-border-gray-200 tw-bg-white tw-z-10"
      >
        <div>
          <h3 class="tw-text-xl tw-font-bold tw-text-gray-900">
            Update Team Members
          </h3>
          <p class="tw-text-sm tw-text-gray-500 tw-mt-1">
            Select or deselect members for this board
          </p>
        </div>
        <button
          (click)="onCloseModal()"
          class="tw-text-gray-400 hover:tw-text-gray-600 tw-transition-colors tw-duration-200 tw-p-1 tw-rounded-full hover:tw-bg-gray-100"
        >
          <svg
            class="tw-w-6 tw-h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>

      <!-- Members Count Info -->
      <div class="tw-px-6 tw-py-3 tw-bg-blue-50 tw-border-b tw-border-blue-100">
        <div class="tw-flex tw-items-center tw-justify-between tw-text-sm">
          <span class="tw-text-blue-700">
            <span class="tw-font-semibold">{{
              selectedMemberIds().length
            }}</span>
            of {{ allMembersDetails.length }} members selected
          </span>
          <span
            *ngIf="hasSelectedMembersChanged()"
            class="tw-inline-flex tw-items-center tw-px-2 tw-py-1 tw-rounded-full tw-bg-orange-100 tw-text-orange-800 tw-text-xs tw-font-medium"
          >
            <svg
              class="tw-w-3 tw-h-3 tw-mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"
              ></path>
            </svg>
            Changes pending
          </span>
        </div>
      </div>

      <!-- Scrollable Content -->
      <div class="tw-flex-1 tw-overflow-y-auto tw-p-6">
        <!-- Loading State -->
        <div
          *ngIf="membersLoading()"
          class="tw-flex tw-justify-center tw-items-center tw-py-16"
        >
          <div class="tw-text-center">
            <div
              class="tw-animate-spin tw-rounded-full tw-h-12 tw-w-12 tw-border-b-2 tw-border-blue-600 tw-mx-auto tw-mb-4"
            ></div>
            <p class="tw-text-gray-500 tw-text-sm">Loading members...</p>
          </div>
        </div>

        <!-- Members List -->
        <div class="tw-space-y-3">
          <ng-container
            *ngIf="!membersLoading() && allMembersDetails.length > 0"
          >
            <div
              *ngFor="
                let member of allMembersDetails;
                trackBy: trackByCategoryId
              "
              class="tw-group tw-relative tw-flex tw-items-center tw-justify-between tw-rounded-xl tw-transition-all tw-duration-200"
              [class.tw-p-4]="
                member._id !== taskPermissionsService.getCurrentUser()?._id
              "
              [class.tw-border]="
                member._id !== taskPermissionsService.getCurrentUser()?._id
              "
              [class.tw-border-blue-200]="
                isMemberSelected(member._id) && !isMemberDisabled(member)
              "
              [class.tw-bg-blue-50]="
                isMemberSelected(member._id) && !isMemberDisabled(member)
              "
              [class.tw-border-gray-200]="
                !isMemberSelected(member._id) && !isMemberDisabled(member)
              "
              [class.tw-bg-white]="
                !isMemberSelected(member._id) && !isMemberDisabled(member)
              "
              [class.tw-border-gray-200]="isMemberDisabled(member)"
              [class.tw-bg-gray-50]="isMemberDisabled(member)"
              [class.tw-opacity-60]="isMemberDisabled(member)"
              [class.tw-cursor-not-allowed]="isMemberDisabled(member)"
              [class.tw-cursor-pointer]="!isMemberDisabled(member)"
              [class.hover:tw-border-blue-300]="
                !isMemberDisabled(member) && !isMemberSelected(member._id)
              "
              [class.hover:tw-bg-gray-100]="
                !isMemberDisabled(member) && !isMemberSelected(member._id)
              "
              (click)="
                !isMemberDisabled(member) && onToggleMemberSelection(member._id)
              "
            >
              <ng-container
                *ngIf="
                  member._id !== taskPermissionsService.getCurrentUser()?._id
                "
              >
                <div class="tw-flex tw-items-center tw-flex-1">
                  <!-- Selection Checkbox -->
                  <div class="tw-relative tw-mr-4">
                    <input
                      type="checkbox"
                      [checked]="isMemberSelected(member._id)"
                      [disabled]="isMemberDisabled(member)"
                      class="tw-w-5 tw-h-5 tw-text-blue-600 tw-bg-gray-100 tw-border-gray-300 tw-rounded focus:tw-ring-blue-500 focus:tw-ring-2"
                      (click)="$event.stopPropagation()"
                      (change)="
                        !isMemberDisabled(member) &&
                          onToggleMemberSelection(member._id)
                      "
                    />
                    <!-- Selection indicator -->
                    <div
                      *ngIf="
                        isMemberSelected(member._id) &&
                        !isMemberDisabled(member)
                      "
                      class="tw-absolute -tw-top-1 -tw-right-1 tw-w-3 tw-h-3 tw-bg-blue-600 tw-rounded-full tw-flex tw-items-center tw-justify-center"
                    >
                      <svg
                        class="tw-w-2 tw-h-2 tw-text-white"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="3"
                          d="M5 13l4 4L19 7"
                        ></path>
                      </svg>
                    </div>
                  </div>

                  <!-- Member Avatar -->
                  <div
                    class="tw-w-12 tw-h-12 tw-rounded-full tw-overflow-hidden tw-border-2 tw-border-white tw-shadow-sm tw-mr-4 tw-flex-shrink-0"
                  >
                    <img
                      *ngIf="
                        member.profileImage;
                        else teamMemberInitialsTemplate
                      "
                      [src]="imageURL + member.profileImage"
                      [alt]="member.name"
                      class="tw-w-full tw-h-full tw-object-cover"
                    />
                    <ng-template #teamMemberInitialsTemplate>
                      <div
                        class="tw-w-full tw-h-full tw-bg-gradient-to-br tw-from-purple-500 tw-to-blue-600 tw-flex tw-items-center tw-justify-center tw-text-white tw-text-sm tw-font-semibold"
                      >
                        {{ getMemberInitials(member.name) }}
                      </div>
                    </ng-template>
                  </div>

                  <!-- Member Info -->
                  <div class="tw-flex-1 tw-min-w-0">
                    <div class="tw-flex tw-items-center tw-gap-2 tw-mb-1">
                      <h4
                        class="tw-font-semibold tw-text-gray-900 tw-text-sm tw-truncate"
                      >
                        {{ member.name }}
                      </h4>
                      <!-- Status indicators -->
                      <div class="tw-flex tw-items-center tw-gap-1">
                        <span
                          *ngIf="member.isActive"
                          class="tw-inline-flex tw-items-center tw-w-2 tw-h-2 tw-bg-green-500 tw-rounded-full"
                          title="Active"
                        ></span>
                        <span
                          *ngIf="!member.isActive"
                          class="tw-inline-flex tw-items-center tw-w-2 tw-h-2 tw-bg-red-500 tw-rounded-full"
                          title="Inactive"
                        ></span>
                        <span
                          *ngIf="member.isVerified"
                          class="tw-inline-flex tw-items-center tw-text-green-600"
                          title="Verified"
                        >
                          <svg
                            class="tw-w-3 tw-h-3"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                          >
                            <path
                              fill-rule="evenodd"
                              d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                              clip-rule="evenodd"
                            ></path>
                          </svg>
                        </span>
                      </div>
                    </div>
                    <p class="tw-text-xs tw-text-gray-500 tw-truncate tw-mb-2">
                      {{ member.emailId }}
                    </p>
                    <div class="tw-flex tw-items-center tw-gap-2 tw-flex-wrap">
                      <span
                        class="tw-inline-flex tw-items-center tw-px-2 tw-py-1 tw-rounded-full tw-text-xs tw-font-medium tw-capitalize"
                        [class.tw-bg-blue-100]="member.role === 'leader'"
                        [class.tw-text-blue-800]="member.role === 'leader'"
                        [class.tw-bg-green-100]="member.role === 'manager'"
                        [class.tw-text-green-800]="member.role === 'manager'"
                        [class.tw-bg-purple-100]="member.role === 'member'"
                        [class.tw-text-purple-800]="member.role === 'member'"
                      >
                        {{ member.role }}
                      </span>
                      <span
                        *ngIf="member.experience"
                        class="tw-text-xs tw-text-gray-500 tw-truncate"
                        [title]="member.experience"
                      >
                        {{ member.experience }}
                      </span>
                    </div>
                    <!-- Disabled Reason -->
                    <div
                      *ngIf="isMemberDisabled(member)"
                      class="tw-mt-2 tw-flex tw-items-center tw-text-xs tw-text-red-600"
                    >
                      <svg
                        class="tw-w-3 tw-h-3 tw-mr-1"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"
                        ></path>
                      </svg>
                      {{ getMemberDisabledReason(member) }}
                    </div>
                  </div>
                </div>
              </ng-container>
            </div>
          </ng-container>

          <!-- Empty State -->
          <div
            *ngIf="!membersLoading() && allMembersDetails.length === 0"
            class="tw-text-center tw-py-12"
          >
            <div
              class="tw-w-20 tw-h-20 tw-bg-gray-100 tw-rounded-full tw-flex tw-items-center tw-justify-center tw-mx-auto tw-mb-4"
            >
              <svg
                class="tw-w-10 tw-h-10 tw-text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                ></path>
              </svg>
            </div>
            <h4 class="tw-text-lg tw-font-medium tw-text-gray-900 tw-mb-2">
              No members found
            </h4>
            <p class="tw-text-sm tw-text-gray-500">
              There are no team members available for this board.
            </p>
          </div>
        </div>
      </div>

      <!-- Fixed Footer -->
      <div class="tw-p-6 tw-border-t tw-border-gray-200 tw-bg-gray-50 tw-z-10">
        <div class="tw-flex tw-gap-3">
          <button
            (click)="onCloseModal()"
            class="tw-flex-1 tw-px-4 tw-py-2.5 tw-border tw-border-gray-300 tw-text-gray-700 tw-rounded-lg tw-font-medium hover:tw-bg-white hover:tw-border-gray-400 tw-transition-all tw-duration-200 tw-shadow-sm"
          >
            Cancel
          </button>
          <button
            (click)="onUpdateBoardMembers()"
            [disabled]="!hasSelectedMembersChanged() || membersLoading()"
            class="tw-flex-1 tw-px-4 tw-py-2.5 tw-rounded-lg tw-font-medium tw-transition-all tw-duration-200 tw-shadow-sm tw-flex tw-items-center tw-justify-center tw-gap-2"
            [class.tw-bg-blue-600]="
              hasSelectedMembersChanged() && !membersLoading()
            "
            [class.tw-text-white]="
              hasSelectedMembersChanged() && !membersLoading()
            "
            [class.hover:tw-bg-blue-700]="
              hasSelectedMembersChanged() && !membersLoading()
            "
            [class.tw-bg-gray-300]="
              !hasSelectedMembersChanged() || membersLoading()
            "
            [class.tw-text-gray-500]="
              !hasSelectedMembersChanged() || membersLoading()
            "
            [class.tw-cursor-not-allowed]="
              !hasSelectedMembersChanged() || membersLoading()
            "
          >
            <svg
              *ngIf="!hasSelectedMembersChanged()"
              class="tw-w-4 tw-h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 13l4 4L19 7"
              ></path>
            </svg>
            <svg
              *ngIf="hasSelectedMembersChanged()"
              class="tw-w-4 tw-h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
              ></path>
            </svg>
            {{ hasSelectedMembersChanged() ? "Update Members" : "No Changes" }}
          </button>
        </div>
        <button
          (click)="onCreateNewUser()"
          class="tw-flex-1 tw-px-4 tw-py-2.5 tw-rounded-lg tw-font-medium tw-transition-all tw-duration-200 tw-shadow-sm tw-flex tw-items-center tw-justify-center tw-gap-2 tw-bg-blue-700 tw-w-full tw-text-white hover:tw-bg-blue-800 tw-mt-3"
        >
          <i class="fa-solid fa-plus tw-text-white"></i>
          <p>Create New User</p>
        </button>
      </div>
    </div>
  </div>
</div>

<app-add-team-member
  *ngIf="showCreateMemberModal()"
  (closeModalEvent)="onAddMemberModalClose()"
  (memberAdded)="onMemberCreated($event)"
></app-add-team-member>

<app-create-board
  *ngIf="showCreateBoardModal()"
  [boardData]="editingBoard()"
  (closeModalEvent)="onCreateBoardModalClose()"
  (boardCreated)="onBoardCreated($event)"
></app-create-board>
