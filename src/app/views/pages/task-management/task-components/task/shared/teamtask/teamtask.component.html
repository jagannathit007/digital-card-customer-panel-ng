<div
  class="tw-min-h-[calc(100vh-145px)] tw-max-h-[calc(100vh-145px)] tw-overflow-y-hidden"
>
  <div
    class="tw-min-h-screen tw-bg-slate-50 tw-p-6"
    (click)="onDocumentClick($event)"
  >
    <div class="tw-max-w-full tw-mx-auto">
      <!-- Board Header -->
      <!-- <div class="tw-mb-6">
      <h1 class="tw-text-3xl tw-font-bold tw-text-gray-900 tw-mb-2">
        Team Task Board
      </h1>
      <p class="tw-text-gray-600">Manage your team's tasks efficiently</p>
    </div> -->

      <!-- board not selected design -->
      <div
        *ngIf="!boardId()"
        class="tw-flex tw-flex-col tw-items-center tw-justify-center tw-h-64 tw-bg-white tw-rounded-lg tw-shadow-md tw-p-8 tw-space-y-4"
      >
        <i class="ri-dashboard-line tw-text-5xl tw-text-gray-400"></i>
        <div class="tw-text-lg tw-font-semibold tw-text-gray-700">
          No Board Selected
        </div>
        <div class="tw-text-gray-500 tw-text-sm">
          Please select a board to view tasks and details.
        </div>
        <a
          routerLink="/task-management/boards"
          class="tw-inline-flex tw-items-center tw-gap-2 tw-bg-blue-600 tw-text-white tw-px-4 tw-py-2 tw-rounded-md tw-shadow hover:tw-bg-blue-700 tw-transition"
        >
          <i class="ri-layout-grid-line"></i>
          Browse Boards
        </a>
      </div>

      <!-- page Loader -->
      <div
        class="tw-fixed tw-top-0 tw-left-0 tw-right-0 tw-bottom-0 tw-flex tw-items-center tw-justify-center tw-bg-[#0000004d] tw-z-30"
        *ngIf="isLoading() && boardId()"
      >
        <div
          class="tw-flex tw-items-center tw-gap-5 tw-bg-white tw-px-8 tw-py-5 tw-rounded"
        >
          <span
            class="tw-animate-spin tw-rounded-full tw-h-5 tw-w-5 tw-border-b-2 tw-border-blue-600"
          ></span
          >Loading...
        </div>
      </div>

      <!-- Kanban Board -->
      <div
        class="tw-flex tw-gap-6 tw-overflow-x-auto tw-pb-4"
        *ngIf="boardId()"
        cdkDropList
        cdkDropListOrientation="horizontal"
        [cdkDropListData]="editableColumns()"
        [cdkDropListDisabled]="!taskPermissionsService.isBoardLevelPermission()"
        (cdkDropListDropped)="onColumnDrop($event)"
      >
        <!-- FIXED: Updated cdkDropListGroup for cross-column drag -->
        <div cdkDropListGroup class="tw-flex tw-gap-6 tw-w-full">
          <!-- Editable Columns -->
          <div
            *ngFor="let column of editableColumns(); trackBy: trackByColumnId"
            class="tw-flex-shrink-0 tw-w-80 tw-transition-all tw-duration-300 tw-ease-in-out"
            cdkDrag
            [cdkDragData]="column"
            [cdkDragDisabled]="!taskPermissionsService.isBoardLevelPermission()"
          >
            <!-- Column Container -->
            <div
              class="tw-bg-white tw-rounded-xl tw-shadow-sm tw-border tw-border-gray-200 tw-h-fit tw-min-h-[calc(100vh-175px)] tw-transition-all tw-duration-200 tw-relative"
            >
              <!-- Column Header -->
              <div class="tw-p-4 tw-border-b tw-border-gray-100">
                <div
                  class="tw-flex tw-items-center tw-justify-between tw-gap-2"
                >
                  <!-- Drag Handle Button -->
                  <button
                    cdkDragHandle
                    class="tw-p-1 tw-text-gray-400 hover:tw-text-gray-600 hover:tw-bg-gray-100 tw-rounded hover:tw-cursor-move"
                  >
                    <i class="ri-draggable"></i>
                  </button>
                  <!-- Column Title -->
                  <div class="tw-flex tw-items-center tw-flex-1">
                    <div
                      *ngIf="editingColumnId() !== column._id"
                      class="tw-flex tw-items-center tw-gap-2 tw-flex-1"
                    >
                      <h3 class="tw-font-semibold tw-text-gray-900 tw-text-sm">
                        {{ column.title }}
                      </h3>
                      <span
                        class="tw-bg-gray-100 tw-text-gray-600 tw-text-xs tw-px-2 tw-py-1 tw-rounded-full"
                      >
                        {{ column.tasks.length }}
                      </span>
                    </div>

                    <!-- Edit Title Input -->
                    <div
                      *ngIf="editingColumnId() === column._id"
                      class="tw-flex-1"
                    >
                      <input
                        type="text"
                        [value]="newColumnTitle()"
                        (input)="onColumnTitleInput($event)"
                        (keydown.enter)="
                          saveColumnRename(column._id, newColumnTitle())
                        "
                        (keydown.escape)="cancelColumnRename()"
                        (blur)="saveColumnRename(column._id, newColumnTitle())"
                        [attr.data-column-id]="column._id"
                        class="tw-w-full tw-px-2 tw-py-1 tw-text-sm tw-font-semibold tw-text-gray-900 tw-bg-transparent tw-border tw-border-blue-300 tw-rounded tw-focus:outline-none tw-focus:ring-2 tw-focus:ring-blue-500"
                      />
                    </div>
                  </div>

                  <!-- Column Actions -->
                  <div
                    class="tw-relative column-menu-container"
                    *ngIf="
                      column.canEdit &&
                      taskPermissionsService.isBoardLevelPermission()
                    "
                  >
                    <button
                      (click)="toggleColumnMenu(column._id, $event)"
                      class="tw-p-1 tw-rounded tw-text-gray-400 hover:tw-text-gray-600 hover:tw-bg-gray-100 tw-transition-colors tw-duration-200"
                    >
                      <svg
                        class="tw-w-4 tw-h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M12 5v.01M12 12v.01M12 19v.01"
                        ></path>
                      </svg>
                    </button>

                    <!-- Dropdown Menu -->
                    <div
                      *ngIf="activeColumnMenu() === column._id"
                      class="tw-absolute tw-right-0 tw-top-8 tw-bg-white tw-border tw-border-gray-200 tw-rounded-lg tw-shadow-lg tw-z-20 tw-min-w-48"
                    >
                      <div class="tw-py-1">
                        <button
                          (click)="openRenameColumnPopup(column._id)"
                          class="tw-w-full tw-px-4 tw-py-2 tw-text-left tw-text-sm tw-text-gray-700 hover:tw-bg-gray-50 tw-transition-colors tw-duration-200"
                        >
                          <svg
                            class="tw-w-4 tw-h-4 tw-inline tw-mr-2"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                            ></path>
                          </svg>
                          Rename Column
                        </button>

                        <button
                          (click)="openAddColumnPopup('left', column._id)"
                          class="tw-w-full tw-px-4 tw-py-2 tw-text-left tw-text-sm tw-text-gray-700 hover:tw-bg-gray-50 tw-transition-colors tw-duration-200"
                        >
                          <svg
                            class="tw-w-4 tw-h-4 tw-inline tw-mr-2"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                            ></path>
                          </svg>
                          Add Column Left
                        </button>

                        <button
                          (click)="openAddColumnPopup('right', column._id)"
                          class="tw-w-full tw-px-4 tw-py-2 tw-text-left tw-text-sm tw-text-gray-700 hover:tw-bg-gray-50 tw-transition-colors tw-duration-200"
                        >
                          <svg
                            class="tw-w-4 tw-h-4 tw-inline tw-mr-2"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                            ></path>
                          </svg>
                          Add Column Right
                        </button>

                        <div
                          class="tw-border-t tw-border-gray-100 tw-my-1"
                        ></div>

                        <button
                          (click)="deleteColumn(column._id)"
                          [disabled]="column.tasks.length > 0"
                          [class.tw-opacity-50]="column.tasks.length > 0"
                          [class.tw-cursor-not-allowed]="
                            column.tasks.length > 0
                          "
                          class="tw-w-full tw-px-4 tw-py-2 tw-text-left tw-text-sm tw-text-red-600 hover:tw-bg-red-50 tw-transition-colors tw-duration-200 disabled:hover:tw-bg-transparent"
                        >
                          <svg
                            class="tw-w-4 tw-h-4 tw-inline tw-mr-2"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                            ></path>
                          </svg>
                          Delete Column
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Tasks Container -->
              <div
                class="tw-p-4 tw-space-y-3 tw-min-h-[calc(100vh-300px)] tw-max-h-[calc(100vh-300px)] tw-overflow-y-auto task-container-scroll tw-transition-all tw-duration-200"
                cdkDropList
                [id]="column._id"
                [cdkDropListData]="column.tasks"
                (cdkDropListDropped)="onTaskDrop($event, column._id)"
                [class.tw-bg-blue-50]="
                  isDragging() && draggedTask()?.column !== column._id
                "
                [class.tw-border-2]="
                  isDragging() && draggedTask()?.column !== column._id
                "
                [class.tw-border-blue-300]="
                  isDragging() && draggedTask()?.column !== column._id
                "
                [class.tw-border-dashed]="
                  isDragging() && draggedTask()?.column !== column._id
                "
              >
                <!-- Task Cards -->
                <div
                  *ngFor="let task of column.tasks; trackBy: trackByTaskId"
                  class="tw-transition-all tw-duration-300 tw-ease-in-out"
                  cdkDrag
                  [cdkDragData]="task"
                  [cdkDragDisabled]="
                    !taskPermissionsService.isTeamTaskCardAccessible(task)
                  "
                >
                  <app-team-task-card
                    [task]="task"
                    [isSelected]="selectedTask()?._id === task._id"
                    [isDragging]="
                      isDragging() && draggedTask()?._id === task._id
                    "
                    [completedColumnId]="completedColumnId()"
                    [deleetdColumnId]="deletedColumnId()"
                    (taskClick)="selectTask(task, $event)"
                    (taskDoubleClick)="onTaskDoubleClick(task)"
                    (taskComplete)="completeTask(task)"
                    (taskDelete)="deleteTask(task)"
                    (taskOpen)="openTask(task)"
                    (dragStarted)="onDragStarted(task)"
                    (dragEnded)="onDragEnded()"
                  >
                  </app-team-task-card>
                </div>

                <!-- Drop Placeholder -->
                <!-- <div
                  *ngIf="isDragging() && column.tasks.length === 0"
                  class="tw-h-20 tw-border-2 tw-border-dashed tw-border-blue-300 tw-rounded-lg tw-bg-blue-50 tw-flex tw-items-center tw-justify-center tw-text-blue-600 tw-text-sm tw-font-medium tw-transition-all tw-duration-200"
                >
                  Drop task here
                </div> -->
                <div
                  *cdkDropListPlaceholder
                  class="tw-my-3 tw-h-20 tw-border-2 tw-border-dashed tw-border-blue-300 tw-rounded-lg tw-bg-blue-50"
                ></div>

                <div class="tw-absolute tw-bottom-1 tw-right-1 tw-left-1">
                  <div
                    *ngIf="
                      newTaskInputColumnId() === column._id;
                      else addTaskBtn
                    "
                  >
                    <input
                      type="text"
                      class="tw-w-full tw-p-4 tw-border-2 tw-border-dashed tw-border-gray-300 tw-rounded-lg tw-text-gray-500 tw-transition-all tw-duration-200 tw-flex tw-items-center tw-justify-center tw-gap-2"
                      [value]="newTaskDraftTitle()"
                      (input)="onNewTaskTitleInput($event)"
                      (keydown.enter)="submitNewTask(column._id)"
                      (blur)="cancelNewTaskInput()"
                      placeholder="Enter task title"
                      autofocus
                      attr.data-new-task-input="{{ column._id }}"
                    />
                  </div>
                  <!-- Add New Task Button -->
                  <ng-template #addTaskBtn>
                    <button
                      (click)="showNewTaskInput(column._id)"
                      class="tw-w-full tw-p-4 tw-border-2 tw-border-dashed tw-border-gray-300 tw-rounded-lg tw-text-gray-500 hover:tw-border-blue-400 hover:tw-text-blue-600 tw-transition-all tw-duration-200 tw-flex tw-items-center tw-justify-center tw-gap-2 hover:tw-bg-blue-50"
                    >
                      <svg
                        class="tw-w-5 tw-h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                        ></path>
                      </svg>
                      Add New Task
                    </button></ng-template
                  >
                </div>
              </div>
            </div>
          </div>

          <!-- Fixed Columns (Completed & Deleted) -->
          <div
            *ngFor="let column of fixedColumns(); trackBy: trackByColumnId"
            class="tw-flex-shrink-0 tw-w-80 tw-transition-all tw-duration-300 tw-ease-in-out"
          >
            <!-- Column Container -->
            <div
              class="tw-bg-white tw-rounded-xl tw-shadow-sm tw-border tw-border-gray-200 tw-h-fit tw-max-h-[calc(100vh-175px)] tw-transition-all tw-duration-200"
            >
              <!-- Column Header -->
              <div class="tw-p-4 tw-border-b tw-border-gray-100">
                <div class="tw-flex tw-items-center tw-justify-between">
                  <div class="tw-flex tw-items-center tw-gap-2">
                    <h3 class="tw-font-semibold tw-text-gray-900 tw-text-sm">
                      {{ column.title }}
                    </h3>
                    <span
                      class="tw-bg-gray-100 tw-text-gray-600 tw-text-xs tw-px-2 tw-py-1 tw-rounded-full"
                    >
                      {{ column.tasks.length }}
                    </span>
                    <svg
                      *ngIf="taskPermissionsService.isBoardLevelPermission()"
                      class="tw-w-4 tw-h-4 tw-text-gray-400 tw-ml-1"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                      ></path>
                    </svg>
                  </div>
                </div>
              </div>

              <!-- Tasks Container -->
              <!-- For fixed columns -->
              <div
                class="tw-p-4 tw-space-y-3 tw-min-h-[calc(100vh-300px)] tw-max-h-[calc(100vh-240px)] tw-overflow-y-auto task-container-scroll tw-transition-all tw-duration-200"
                cdkDropList
                [id]="column._id"
                [cdkDropListData]="column.tasks"
                (cdkDropListDropped)="onTaskDrop($event, column._id)"
                [class.tw-bg-blue-50]="
                  isDragging() && draggedTask()?.column !== column._id
                "
                [class.tw-border-2]="
                  isDragging() && draggedTask()?.column !== column._id
                "
                [class.tw-border-blue-300]="
                  isDragging() && draggedTask()?.column !== column._id
                "
                [class.tw-border-dashed]="
                  isDragging() && draggedTask()?.column !== column._id
                "
              >
                <!-- Task Cards -->
                <div
                  *ngFor="let task of column.tasks; trackBy: trackByTaskId"
                  class="tw-transition-all tw-duration-300 tw-ease-in-out"
                  cdkDrag
                  [cdkDragData]="task"
                  [cdkDragDisabled]="
                    !taskPermissionsService.isTeamTaskCardAccessible(task)
                  "
                >
                  <app-team-task-card
                    [task]="task"
                    [isSelected]="selectedTask()?._id === task._id"
                    [isDragging]="
                      isDragging() && draggedTask()?._id === task._id
                    "
                    [completedColumnId]="completedColumnId()"
                    [deleetdColumnId]="deletedColumnId()"
                    (taskClick)="selectTask(task, $event)"
                    (taskDoubleClick)="onTaskDoubleClick(task)"
                    (taskComplete)="completeTask(task)"
                    (taskDelete)="deleteTask(task)"
                    (taskOpen)="openTask(task)"
                    (dragStarted)="onDragStarted(task)"
                    (dragEnded)="onDragEnded()"
                  >
                  </app-team-task-card>
                </div>

                <!-- Drop Placeholder -->
                <div
                  *cdkDropListPlaceholder
                  class="tw-my-3 tw-h-20 tw-border-2 tw-border-dashed tw-border-blue-300 tw-rounded-lg tw-bg-blue-50"
                ></div>

                <!-- Add New Task Button (for fixed columns too) -->
                <!-- <button
                (click)="addNewTask(column._id)"
                class="tw-w-full tw-p-4 tw-border-2 tw-border-dashed tw-border-gray-300 tw-rounded-lg tw-text-gray-500 hover:tw-border-blue-400 hover:tw-text-blue-600 tw-transition-all tw-duration-200 tw-flex tw-items-center tw-justify-center tw-gap-2 hover:tw-bg-blue-50">
                <svg class="tw-w-5 tw-h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Add New Task
              </button> -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- column name input popup with modern interactive design -->
<!-- Modern Column Name Input Popup -->
<!-- Replace your current popup div with this -->
<div
  *ngIf="showColumnNamePopup()"
  class="tw-fixed tw-inset-0 tw-bg-black tw-bg-opacity-50 tw-flex tw-items-center tw-justify-center tw-z-40 tw-p-4"
  (click)="closeColumnNamePopup()"
>
  <div
    class="tw-bg-white tw-rounded-xl tw-shadow-xl tw-w-full tw-max-w-md tw-overflow-hidden tw-animate-scale-in"
    (click)="$event.stopPropagation()"
  >
    <form [formGroup]="columnForm" (ngSubmit)="handleColumnNameSubmit()">
      <div class="tw-p-6">
        <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900 tw-mb-4">
          {{ popupMode() === "add" ? "Add New Column" : "Rename Column" }}
        </h3>

        <input
          type="text"
          formControlName="columnName"
          class="tw-w-full tw-px-4 tw-py-3 tw-border tw-border-gray-300 tw-rounded-lg tw-focus:ring-2 tw-focus:ring-blue-500 tw-focus:border-blue-500 tw-outline-none tw-transition-all tw-duration-200"
          placeholder="Enter column name"
          autofocus
        />

        <div
          *ngIf="
            columnForm.get('columnName')?.invalid &&
            (columnForm.get('columnName')?.dirty ||
              columnForm.get('columnName')?.touched)
          "
          class="tw-text-red-500 tw-text-sm tw-mt-1"
        >
          <div *ngIf="columnForm.get('columnName')?.errors?.['required']">
            Column name is required
          </div>
          <div *ngIf="columnForm.get('columnName')?.errors?.['duplicateName']">
            Column name already exists
          </div>
        </div>

        <div class="tw-flex tw-justify-end tw-gap-3 tw-mt-6">
          <button
            type="button"
            (click)="closeColumnNamePopup()"
            class="tw-px-4 tw-py-2 tw-text-gray-700 hover:tw-bg-gray-100 tw-rounded-lg tw-transition-colors tw-duration-200"
          >
            Cancel
          </button>
          <button
            type="submit"
            [disabled]="columnForm.invalid"
            class="tw-px-4 tw-py-2 tw-bg-blue-600 tw-text-white hover:tw-bg-blue-700 tw-rounded-lg tw-transition-colors tw-duration-200 disabled:tw-opacity-50 disabled:tw-cursor-not-allowed"
          >
            {{ popupMode() === "add" ? "Add" : "Save" }}
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
