<div class="tw-p-6">
  <!-- Header -->
  <div class="tw-mb-8">
    <h1 class="tw-text-3xl tw-font-bold tw-text-gray-900 tw-mb-2">CRM Dashboard</h1>
    <p class="tw-text-gray-600">Overview of your CRM performance and lead management</p>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="tw-text-center tw-py-12">
    <div class="tw-animate-spin tw-rounded-full tw-h-12 tw-w-12 tw-border-b-2 tw-border-blue-600 tw-mx-auto tw-mb-4"></div>
    <p class="tw-text-gray-600">Loading dashboard data...</p>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!isLoading" class="tw-space-y-8">
    <!-- Main Stats Cards -->
    <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 lg:tw-grid-cols-4 tw-gap-6">
      <!-- Total Leads -->
      <div class="tw-bg-white tw-rounded-xl tw-shadow-sm tw-border tw-border-gray-200 tw-p-6">
        <div class="tw-flex tw-items-center tw-justify-between">
          <div>
            <p class="tw-text-sm tw-font-medium tw-text-gray-600">Total Leads</p>
            <p class="tw-text-3xl tw-font-bold tw-text-gray-900">{{ getTotalLeads() }}</p>
          </div>
          <div class="tw-p-3 tw-bg-blue-100 tw-rounded-full">
            <i class="ri-user-line tw-text-2xl tw-text-blue-600"></i>
          </div>
        </div>
      </div>

      <!-- Active Leads -->
      <div class="tw-bg-white tw-rounded-xl tw-shadow-sm tw-border tw-border-gray-200 tw-p-6">
        <div class="tw-flex tw-items-center tw-justify-between">
          <div>
            <p class="tw-text-sm tw-font-medium tw-text-gray-600">Active Leads</p>
            <p class="tw-text-3xl tw-font-bold tw-text-gray-900">{{ getActiveLeads() }}</p>
          </div>
          <div class="tw-p-3 tw-bg-green-100 tw-rounded-full">
            <i class="ri-time-line tw-text-2xl tw-text-green-600"></i>
          </div>
        </div>
      </div>

      <!-- Won Leads -->
      <div class="tw-bg-white tw-rounded-xl tw-shadow-sm tw-border tw-border-gray-200 tw-p-6">
        <div class="tw-flex tw-items-center tw-justify-between">
          <div>
            <p class="tw-text-sm tw-font-medium tw-text-gray-600">Won Leads</p>
            <p class="tw-text-3xl tw-font-bold tw-text-green-600">{{ getWonLeads() }}</p>
          </div>
          <div class="tw-p-3 tw-bg-green-100 tw-rounded-full">
            <i class="ri-trophy-line tw-text-2xl tw-text-green-600"></i>
          </div>
        </div>
      </div>

      <!-- Lost Leads -->
      <div class="tw-bg-white tw-rounded-xl tw-shadow-sm tw-border tw-border-gray-200 tw-p-6">
        <div class="tw-flex tw-items-center tw-justify-between">
          <div>
            <p class="tw-text-sm tw-font-medium tw-text-gray-600">Lost Leads</p>
            <p class="tw-text-3xl tw-font-bold tw-text-red-600">{{ getLostLeads() }}</p>
          </div>
          <div class="tw-p-3 tw-bg-red-100 tw-rounded-full">
            <i class="ri-close-circle-line tw-text-2xl tw-text-red-600"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Today's Performance -->
    <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-3 tw-gap-6">
      <div class="tw-bg-white tw-rounded-xl tw-shadow-sm tw-border tw-border-gray-200 tw-p-6">
        <div class="tw-flex tw-items-center tw-justify-between tw-mb-4">
          <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">Today's Performance</h3>
          <i class="ri-calendar-line tw-text-xl tw-text-blue-600"></i>
        </div>
        <div class="tw-space-y-4">
          <div class="tw-flex tw-items-center tw-justify-between">
            <span class="tw-text-sm tw-text-gray-600">New Leads</span>
            <span class="tw-text-lg tw-font-semibold tw-text-blue-600">{{ getTodaysNewLeads() }}</span>
          </div>
          <div class="tw-flex tw-items-center tw-justify-between">
            <span class="tw-text-sm tw-text-gray-600">Won Today</span>
            <span class="tw-text-lg tw-font-semibold tw-text-green-600">{{ getTodaysWonLeads() }}</span>
          </div>
          <div class="tw-flex tw-items-center tw-justify-between">
            <span class="tw-text-sm tw-text-gray-600">Lost Today</span>
            <span class="tw-text-lg tw-font-semibold tw-text-red-600">{{ getTodaysLostLeads() }}</span>
          </div>
        </div>
      </div>

      <!-- Financial Overview -->
      <div class="tw-bg-white tw-rounded-xl tw-shadow-sm tw-border tw-border-gray-200 tw-p-6">
        <div class="tw-flex tw-items-center tw-justify-between tw-mb-4">
          <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">Financial Overview</h3>
          <i class="ri-money-dollar-circle-line tw-text-xl tw-text-green-600"></i>
        </div>
        <div class="tw-space-y-4">
          <div class="tw-flex tw-items-center tw-justify-between">
            <span class="tw-text-sm tw-text-gray-600">Total Value</span>
            <span class="tw-text-lg tw-font-semibold tw-text-gray-900">{{ formatAmount(getTotalAmount()) }}</span>
          </div>
          <div class="tw-flex tw-items-center tw-justify-between">
            <span class="tw-text-sm tw-text-gray-600">Won Value</span>
            <span class="tw-text-lg tw-font-semibold tw-text-green-600">{{ formatAmount(getWonAmount()) }}</span>
          </div>
          <div class="tw-flex tw-items-center tw-justify-between">
            <span class="tw-text-sm tw-text-gray-600">Conversion Rate</span>
            <span class="tw-text-lg tw-font-semibold tw-text-blue-600">{{ getConversionRate() }}%</span>
          </div>
        </div>
      </div>

      <!-- Priority Breakdown -->
      <div class="tw-bg-white tw-rounded-xl tw-shadow-sm tw-border tw-border-gray-200 tw-p-6">
        <div class="tw-flex tw-items-center tw-justify-between tw-mb-4">
          <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">Priority Breakdown</h3>
          <i class="ri-pie-chart-line tw-text-xl tw-text-purple-600"></i>
        </div>
        <div class="tw-space-y-3">
          <div class="tw-flex tw-items-center tw-justify-between">
            <div class="tw-flex tw-items-center tw-gap-2">
              <div class="tw-w-3 tw-h-3 tw-bg-red-500 tw-rounded-full"></div>
              <span class="tw-text-sm tw-text-gray-600">Hot</span>
            </div>
            <span class="tw-text-sm tw-font-semibold tw-text-gray-900">{{ getLeadsByPriority('hot') }}</span>
          </div>
          <div class="tw-flex tw-items-center tw-justify-between">
            <div class="tw-flex tw-items-center tw-gap-2">
              <div class="tw-w-3 tw-h-3 tw-bg-yellow-500 tw-rounded-full"></div>
              <span class="tw-text-sm tw-text-gray-600">Warm</span>
            </div>
            <span class="tw-text-sm tw-font-semibold tw-text-gray-900">{{ getLeadsByPriority('warm') }}</span>
          </div>
          <div class="tw-flex tw-items-center tw-justify-between">
            <div class="tw-flex tw-items-center tw-gap-2">
              <div class="tw-w-3 tw-h-3 tw-bg-blue-500 tw-rounded-full"></div>
              <span class="tw-text-sm tw-text-gray-600">Cold</span>
            </div>
            <span class="tw-text-sm tw-font-semibold tw-text-gray-900">{{ getLeadsByPriority('cold') }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Today's Closable Leads and Top 10 Near Closing -->
    <div class="tw-grid tw-grid-cols-1 lg:tw-grid-cols-2 tw-gap-6">
      <!-- Today's Closable Leads -->
      <div class="tw-bg-white tw-rounded-xl tw-shadow-sm tw-border tw-border-gray-200 tw-p-6">
        <div class="tw-flex tw-items-center tw-justify-between tw-mb-4">
          <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">Today's Closable Leads</h3>
          <i class="ri-calendar-check-line tw-text-xl tw-text-orange-600"></i>
        </div>
        
        <!-- Sorting Controls -->
        <div class="tw-flex tw-items-center tw-gap-2 tw-mb-4">
          <span class="tw-text-sm tw-text-gray-600">Sort by:</span>
          <button 
            (click)="setSortForTodaysClosableLeads('closingDate')"
            class="tw-flex tw-items-center tw-gap-1 tw-px-2 tw-py-1 tw-text-xs tw-rounded tw-transition-colors"
            [class]="todaysClosableLeadsSortBy === 'closingDate' ? 'tw-bg-blue-100 tw-text-blue-700' : 'tw-text-gray-600 hover:tw-bg-gray-100'"
          >
            Date
            <i [class]="getSortIcon('closingDate', todaysClosableLeadsSortBy, todaysClosableLeadsSortOrder)"></i>
          </button>
          <button 
            (click)="setSortForTodaysClosableLeads('amount')"
            class="tw-flex tw-items-center tw-gap-1 tw-px-2 tw-py-1 tw-text-xs tw-rounded tw-transition-colors"
            [class]="todaysClosableLeadsSortBy === 'amount' ? 'tw-bg-blue-100 tw-text-blue-700' : 'tw-text-gray-600 hover:tw-bg-gray-100'"
          >
            Amount
            <i [class]="getSortIcon('amount', todaysClosableLeadsSortBy, todaysClosableLeadsSortOrder)"></i>
          </button>
          <button 
            (click)="setSortForTodaysClosableLeads('priority')"
            class="tw-flex tw-items-center tw-gap-1 tw-px-2 tw-py-1 tw-text-xs tw-rounded tw-transition-colors"
            [class]="todaysClosableLeadsSortBy === 'priority' ? 'tw-bg-blue-100 tw-text-blue-700' : 'tw-text-gray-600 hover:tw-bg-gray-100'"
          >
            Priority
            <i [class]="getSortIcon('priority', todaysClosableLeadsSortBy, todaysClosableLeadsSortOrder)"></i>
          </button>
        </div>

        <div class="tw-space-y-3 tw-max-h-80 tw-overflow-y-auto">
          <div *ngFor="let lead of getTodaysClosableLeads(); let i = index" class="tw-flex tw-items-center tw-justify-between tw-p-3 tw-bg-gray-50 tw-rounded-lg tw-border-l-4 tw-border-l-orange-400">
            <div class="tw-flex tw-items-center tw-gap-3">
              <div class="tw-w-8 tw-h-8 tw-bg-orange-100 tw-rounded-full tw-flex tw-items-center tw-justify-center">
                <span class="tw-text-sm tw-font-semibold tw-text-orange-600">#{{ i + 1 }}</span>
              </div>
              <div>
                <p class="tw-text-sm tw-font-medium tw-text-gray-900 tw-line-clamp-1">{{ lead.title }}</p>
                <p class="tw-text-xs tw-text-gray-600">{{ lead.contactDetails?.name || 'No contact' }}</p>
                <p class="tw-text-xs tw-text-orange-600">Due Today</p>
              </div>
            </div>
            <div class="tw-text-right">
              <p class="tw-text-sm tw-font-semibold tw-text-green-600">{{ formatAmount(lead.amount) }}</p>
              <span [class]="'tw-px-2 tw-py-1 tw-text-xs tw-font-medium tw-rounded-full ' + getPriorityBgColor(lead.priority) + ' ' + getPriorityColor(lead.priority)">
                {{ lead.priority | titlecase }}
              </span>
            </div>
          </div>
          <div *ngIf="getTodaysClosableLeads().length === 0" class="tw-text-center tw-py-8 tw-text-gray-500">
            <i class="ri-calendar-check-line tw-text-3xl tw-mb-2"></i>
            <p>No leads closing today</p>
          </div>
        </div>
      </div>

      <!-- Top 10 Leads Near Closing -->
      <div class="tw-bg-white tw-rounded-xl tw-shadow-sm tw-border tw-border-gray-200 tw-p-6">
        <div class="tw-flex tw-items-center tw-justify-between tw-mb-4">
          <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">Upcoming Closures (Top 10)</h3>
          <i class="ri-time-line tw-text-xl tw-text-purple-600"></i>
        </div>
        <div class="tw-space-y-3 tw-max-h-80 tw-overflow-y-auto">
          <div *ngFor="let lead of getTop10LeadsNearClosing(); let i = index" class="tw-flex tw-items-center tw-justify-between tw-p-3 tw-bg-gray-50 tw-rounded-lg">
            <div class="tw-flex tw-items-center tw-gap-3">
              <div class="tw-w-8 tw-h-8 tw-bg-purple-100 tw-rounded-full tw-flex tw-items-center tw-justify-center">
                <span class="tw-text-sm tw-font-semibold tw-text-purple-600">#{{ i + 1 }}</span>
              </div>
              <div>
                <p class="tw-text-sm tw-font-medium tw-text-gray-900 tw-line-clamp-1">{{ lead.title }}</p>
                <p class="tw-text-xs tw-text-gray-600">{{ lead.contactDetails?.name || 'No contact' }}</p>
                <p class="tw-text-xs" [class]="getClosingDateClass(lead.closingDate)">
                  {{ lead.closingDate | date:'MMM dd, yyyy' }}
                  <span *ngIf="getDaysUntilClosing(lead.closingDate) >= 0">
                    ({{ getDaysUntilClosing(lead.closingDate) === 0 ? 'Today' : getDaysUntilClosing(lead.closingDate) + ' days' }})
                  </span>
                  <span *ngIf="getDaysUntilClosing(lead.closingDate) < 0">
                    (Overdue)
                  </span>
                </p>
              </div>
            </div>
            <div class="tw-text-right">
              <p class="tw-text-sm tw-font-semibold tw-text-green-600">{{ formatAmount(lead.amount) }}</p>
              <span [class]="'tw-px-2 tw-py-1 tw-text-xs tw-font-medium tw-rounded-full ' + getPriorityBgColor(lead.priority) + ' ' + getPriorityColor(lead.priority)">
                {{ lead.priority | titlecase }}
              </span>
            </div>
          </div>
          <div *ngIf="getTop10LeadsNearClosing().length === 0" class="tw-text-center tw-py-8 tw-text-gray-500">
            <i class="ri-time-line tw-text-3xl tw-mb-2"></i>
            <p>No upcoming closures</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Top Leads and Recent Activity -->
    <div class="tw-grid tw-grid-cols-1 lg:tw-grid-cols-2 tw-gap-6">
      <!-- Top Leads by Amount -->
      <div class="tw-bg-white tw-rounded-xl tw-shadow-sm tw-border tw-border-gray-200 tw-p-6">
        <div class="tw-flex tw-items-center tw-justify-between tw-mb-4">
          <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">Top Leads by Amount</h3>
          <i class="ri-trophy-line tw-text-xl tw-text-yellow-600"></i>
        </div>
        <div class="tw-space-y-3">
          <div *ngFor="let lead of getTopLeadsByAmount(); let i = index" class="tw-flex tw-items-center tw-justify-between tw-p-3 tw-bg-gray-50 tw-rounded-lg">
            <div class="tw-flex tw-items-center tw-gap-3">
              <div class="tw-w-8 tw-h-8 tw-bg-blue-100 tw-rounded-full tw-flex tw-items-center tw-justify-center">
                <span class="tw-text-sm tw-font-semibold tw-text-blue-600">#{{ i + 1 }}</span>
              </div>
              <div>
                <p class="tw-text-sm tw-font-medium tw-text-gray-900 tw-line-clamp-1">{{ lead.title }}</p>
                <p class="tw-text-xs tw-text-gray-600">{{ lead.contactDetails?.name || 'No contact' }}</p>
              </div>
            </div>
            <div class="tw-text-right">
              <p class="tw-text-sm tw-font-semibold tw-text-green-600">{{ formatAmount(lead.amount) }}</p>
              <span [class]="'tw-px-2 tw-py-1 tw-text-xs tw-font-medium tw-rounded-full ' + getPriorityBgColor(lead.priority) + ' ' + getPriorityColor(lead.priority)">
                {{ lead.priority | titlecase }}
              </span>
            </div>
          </div>
          <div *ngIf="getTopLeadsByAmount().length === 0" class="tw-text-center tw-py-8 tw-text-gray-500">
            <i class="ri-inbox-line tw-text-3xl tw-mb-2"></i>
            <p>No leads with amounts found</p>
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="tw-bg-white tw-rounded-xl tw-shadow-sm tw-border tw-border-gray-200 tw-p-6">
        <div class="tw-flex tw-items-center tw-justify-between tw-mb-4">
          <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">Recent Activity</h3>
          <i class="ri-notification-line tw-text-xl tw-text-blue-600"></i>
        </div>
        <div class="tw-space-y-3">
          <div *ngFor="let activity of getRecentActivity()" class="tw-flex tw-items-center tw-gap-3 tw-p-3 tw-bg-gray-50 tw-rounded-lg">
            <div class="tw-w-2 tw-h-2 tw-rounded-full" 
                 [class]="activity.action === 'Won' ? 'tw-bg-green-500' : activity.action === 'Lost' ? 'tw-bg-red-500' : 'tw-bg-blue-500'">
            </div>
            <div class="tw-flex-1">
              <p class="tw-text-sm tw-font-medium tw-text-gray-900 tw-line-clamp-1">{{ activity.title }}</p>
              <p class="tw-text-xs tw-text-gray-600">{{ activity.action }} • {{ formatDate(activity.updatedAt) }}</p>
            </div>
            <span [class]="'tw-px-2 tw-py-1 tw-text-xs tw-font-medium tw-rounded-full ' + getPriorityBgColor(activity.priority) + ' ' + getPriorityColor(activity.priority)">
              {{ activity.priority | titlecase }}
            </span>
          </div>
          <div *ngIf="getRecentActivity().length === 0" class="tw-text-center tw-py-8 tw-text-gray-500">
            <i class="ri-time-line tw-text-3xl tw-mb-2"></i>
            <p>No recent activity</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Monthly Trends -->
    <div class="tw-bg-white tw-rounded-xl tw-shadow-sm tw-border tw-border-gray-200 tw-p-6">
      <div class="tw-flex tw-items-center tw-justify-between tw-mb-6">
        <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">Monthly Trends (Last 6 Months)</h3>
        <i class="ri-bar-chart-line tw-text-xl tw-text-purple-600"></i>
      </div>
      <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-6 tw-gap-4">
        <div *ngFor="let trend of getMonthlyTrends()" class="tw-text-center tw-p-4 tw-bg-gray-50 tw-rounded-lg">
          <p class="tw-text-sm tw-font-medium tw-text-gray-600 tw-mb-2">{{ trend.month }}</p>
          <div class="tw-space-y-2">
            <div>
              <p class="tw-text-xs tw-text-gray-500">New Leads</p>
              <p class="tw-text-lg tw-font-semibold tw-text-blue-600">{{ trend.newLeads }}</p>
            </div>
            <div>
              <p class="tw-text-xs tw-text-gray-500">Won</p>
              <p class="tw-text-lg tw-font-semibold tw-text-green-600">{{ trend.wonLeads }}</p>
            </div>
            <div>
              <p class="tw-text-xs tw-text-gray-500">Rate</p>
              <p class="tw-text-sm tw-font-semibold tw-text-purple-600">{{ trend.conversionRate }}%</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- CRM Details with Category Management -->
    <div *ngIf="crmDetails" class="tw-bg-white tw-rounded-xl tw-shadow-sm tw-border tw-border-gray-200 tw-p-6">
      <div class="tw-flex tw-items-center tw-justify-between tw-mb-6">
        <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">CRM Information</h3>
        <button 
          (click)="openAddCategoryModal()"
          class="tw-px-4 tw-py-2 tw-bg-blue-600 tw-text-white tw-rounded-lg hover:tw-bg-blue-700 tw-transition-colors tw-flex tw-items-center tw-gap-2"
        >
          <i class="ri-add-line"></i>
          Add Category
        </button>
      </div>
      <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-6">
        <div>
          <h4 class="tw-text-md tw-font-medium tw-text-gray-700 tw-mb-3">Categories</h4>
          <div class="tw-space-y-2">
                         <div *ngFor="let category of getActiveCategories()" 
                  class="tw-flex tw-items-center tw-justify-between tw-p-3 tw-bg-gray-50 tw-rounded-lg">
              <div class="tw-flex tw-items-center tw-gap-2">
                <span class="tw-px-3 tw-py-1 tw-bg-purple-100 tw-text-purple-800 tw-text-sm tw-rounded-full">
                  {{ category.name }}
                </span>
                <span class="tw-text-xs tw-text-gray-500">
                  {{ getCategoryStats()[category.name] || 0 }} leads
                </span>
              </div>
              <div class="tw-flex tw-items-center tw-gap-2">
                <button 
                  (click)="openEditCategoryModal(category)"
                  class="tw-p-1 tw-text-gray-400 hover:tw-text-blue-600 hover:tw-bg-blue-50 tw-rounded tw-transition-colors"
                >
                  <i class="ri-edit-line tw-text-sm"></i>
                </button>
                <button 
                  (click)="deleteCategory(category)"
                  class="tw-p-1 tw-text-gray-400 hover:tw-text-red-600 hover:tw-bg-red-50 tw-rounded tw-transition-colors"
                >
                  <i class="ri-delete-bin-line tw-text-sm"></i>
                </button>
              </div>
            </div>
                         <div *ngIf="!hasActiveCategories()" class="tw-text-center tw-py-4 tw-text-gray-500">
              <i class="ri-folder-line tw-text-2xl tw-mb-2"></i>
              <p>No categories found</p>
            </div>
          </div>
        </div>
        <div>
          <div class="tw-flex tw-items-center tw-justify-between tw-mb-3">
            <h4 class="tw-text-md tw-font-medium tw-text-gray-700">Team Members</h4>
            <button 
              (click)="openAddMemberModal()"
              class="tw-px-3 tw-py-1 tw-text-xs tw-bg-blue-600 tw-text-white tw-rounded-lg hover:tw-bg-blue-700 tw-transition-colors tw-flex tw-items-center tw-gap-1"
            >
              <i class="ri-add-line"></i>
              Manage Members
            </button>
          </div>
          <div class="tw-space-y-3">
            <div *ngFor="let member of teamMembers?.slice(0, 5); let i = index" 
                 class="tw-flex tw-items-center tw-justify-between tw-p-3 tw-bg-gray-50 tw-rounded-lg">
              <div class="tw-flex tw-items-center tw-gap-3">
                <div class="tw-w-10 tw-h-10 tw-bg-blue-100 tw-rounded-full tw-flex tw-items-center tw-justify-center">
                  <span class="tw-text-sm tw-font-semibold tw-text-blue-600">
                    {{ getTeamMemberInitials(member) }}
                  </span>
                </div>
                <div>
                  <p class="tw-text-sm tw-font-medium tw-text-gray-900">{{ member.name || 'Unknown' }}</p>
                  <p class="tw-text-xs tw-text-gray-600">{{ member.emailId || 'No email' }}</p>
                  <p class="tw-text-xs tw-text-purple-600">{{ member.role || 'No role' }}</p>
                </div>
              </div>
              <div class="tw-flex tw-items-center tw-gap-2">
                <span class="tw-inline-flex tw-items-center tw-px-2 tw-py-1 tw-text-xs tw-font-medium tw-rounded-full"
                      [class]="member.isDeleted ? 'tw-bg-red-100 tw-text-red-800' : 'tw-bg-green-100 tw-text-green-800'">
                  {{ member.isDeleted ? 'Inactive' : 'Active' }}
                </span>
              </div>
            </div>
            <div *ngIf="teamMembers.length > 5" class="tw-text-center tw-py-2">
              <button 
                (click)="openAddMemberModal()"
                class="tw-text-sm tw-text-blue-600 hover:tw-text-blue-800 tw-transition-colors"
              >
                View all {{ teamMembers.length }} members
              </button>
            </div>
            <div *ngIf="!teamMembers || teamMembers.length === 0" class="tw-text-center tw-py-4 tw-text-gray-500">
              <i class="ri-team-line tw-text-2xl tw-mb-2"></i>
              <p>No team members found</p>
              <button 
                (click)="openAddMemberModal()"
                class="tw-text-sm tw-text-blue-600 hover:tw-text-blue-800 tw-transition-colors tw-mt-2"
              >
                Add your first member
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- No CRM Setup Message -->
  <div *ngIf="!isLoading && !crmDetails" class="tw-text-center tw-py-12">
    <div class="tw-bg-white tw-rounded-xl tw-shadow-sm tw-border tw-border-gray-200 tw-p-8 tw-max-w-md tw-mx-auto">
      <i class="ri-dashboard-line tw-text-5xl tw-text-gray-400 tw-mb-4"></i>
      <h3 class="tw-text-lg tw-font-semibold tw-text-gray-700 tw-mb-2">No CRM Setup Found</h3>
      <p class="tw-text-gray-500 tw-text-sm tw-mb-6">
        Please contact your administrator to set up CRM for your account.
      </p>
    </div>
  </div>
</div>

<!-- Category Management Modal -->
<div *ngIf="showCategoryModal" class="tw-fixed tw-inset-0 tw-bg-black tw-bg-opacity-50 tw-flex tw-items-center tw-justify-center tw-z-50 tw-p-4" (click)="closeCategoryModal()">
  <div class="tw-bg-white tw-rounded-xl tw-shadow-xl tw-w-full tw-max-w-md tw-overflow-hidden tw-animate-scale-in" (click)="$event.stopPropagation()">
    <div class="tw-p-6">
      <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900 tw-mb-4">
        {{ categoryModalMode === 'add' ? 'Add New Category' : 'Edit Category' }}
      </h3>

      <div class="tw-mb-6">
        <label class="tw-block tw-text-sm tw-font-medium tw-text-gray-700 tw-mb-2">Category Name</label>
        <input
          type="text"
          [(ngModel)]="newCategoryName"
          (keydown.enter)="saveCategory()"
          class="tw-w-full tw-px-4 tw-py-3 tw-border tw-border-gray-300 tw-rounded-lg tw-focus:ring-2 tw-focus:ring-blue-500 tw-focus:border-blue-500 tw-outline-none tw-transition-all tw-duration-200"
          placeholder="Enter category name"
          autofocus
        />
      </div>

      <div class="tw-flex tw-justify-end tw-gap-3">
        <button
          type="button"
          (click)="closeCategoryModal()"
          class="tw-px-4 tw-py-2 tw-text-gray-700 hover:tw-bg-gray-100 tw-rounded-lg tw-transition-colors tw-duration-200"
        >
          Cancel
        </button>
        <button
          type="button"
          (click)="saveCategory()"
          [disabled]="!newCategoryName.trim()"
          class="tw-px-4 tw-py-2 tw-bg-blue-600 tw-text-white hover:tw-bg-blue-700 tw-rounded-lg tw-transition-colors tw-duration-200 disabled:tw-opacity-50 disabled:tw-cursor-not-allowed"
        >
          {{ categoryModalMode === 'add' ? 'Add' : 'Save' }}
        </button>
      </div>

      <!-- Add Team Member Mode -->
      <!-- <div *ngIf="teamMemberModalMode === 'add'">
        <form #addForm="ngForm" (ngSubmit)="addTeamMember(addForm.value)">
          <div class="tw-space-y-6">
=            <div class="tw-flex tw-items-center tw-gap-4 tw-p-4 tw-bg-blue-50 tw-rounded-lg">
              <div class="tw-w-16 tw-h-16 tw-bg-blue-100 tw-rounded-full tw-flex tw-items-center tw-justify-center">
                <i class="ri-user-add-line tw-text-2xl tw-text-blue-600"></i>
              </div>
              <div>
                <h4 class="tw-text-xl tw-font-semibold tw-text-gray-900">Add New Team Member</h4>
                <p class="tw-text-sm tw-text-gray-600">Enter the details for the new team member</p>
              </div>
            </div>

            <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-6">
              <div>
                <label class="tw-block tw-text-sm tw-font-medium tw-text-gray-700 tw-mb-2">Full Name *</label>
                <input
                  type="text"
                  name="name"
                  [(ngModel)]="newTeamMember.name"
                  class="tw-w-full tw-px-4 tw-py-3 tw-border tw-border-gray-300 tw-rounded-lg tw-focus:ring-2 tw-focus:ring-blue-500 tw-focus:border-blue-500 tw-outline-none tw-transition-all tw-duration-200"
                  placeholder="Enter full name"
                  required
                />
              </div>
              <div>
                <label class="tw-block tw-text-sm tw-font-medium tw-text-gray-700 tw-mb-2">Email Address *</label>
                <input
                  type="email"
                  name="emailId"
                  [(ngModel)]="newTeamMember.emailId"
                  class="tw-w-full tw-px-4 tw-py-3 tw-border tw-border-gray-300 tw-rounded-lg tw-focus:ring-2 tw-focus:ring-blue-500 tw-focus:border-blue-500 tw-outline-none tw-transition-all tw-duration-200"
                  placeholder="Enter email address"
                  required
                />
              </div>
              <div>
                <label class="tw-block tw-text-sm tw-font-medium tw-text-gray-700 tw-mb-2">Role</label>
                <input
                  type="text"
                  name="role"
                  [(ngModel)]="newTeamMember.role"
                  class="tw-w-full tw-px-4 tw-py-3 tw-border tw-border-gray-300 tw-rounded-lg tw-focus:ring-2 tw-focus:ring-blue-500 tw-focus:border-blue-500 tw-outline-none tw-transition-all tw-duration-200"
                  placeholder="Enter role (e.g., Sales Manager, Account Executive)"
                />
              </div>
              <div>
                <label class="tw-block tw-text-sm tw-font-medium tw-text-gray-700 tw-mb-2">Status</label>
                <select
                  name="isDeleted"
                  [(ngModel)]="newTeamMember.isDeleted"
                  class="tw-w-full tw-px-4 tw-py-3 tw-border tw-border-gray-300 tw-rounded-lg tw-focus:ring-2 tw-focus:ring-blue-500 tw-focus:border-blue-500 tw-outline-none tw-transition-all tw-duration-200"
                >
                  <option [value]="false">Active</option>
                  <option [value]="true">Inactive</option>
                </select>
              </div>
            </div>

            <div class="tw-flex tw-items-center tw-justify-end tw-gap-3 tw-pt-4 tw-border-t tw-border-gray-200">
              <button 
                type="button"
                (click)="closeTeamMemberModal()"
                class="tw-px-4 tw-py-2 tw-text-gray-700 tw-border tw-border-gray-300 tw-rounded-lg hover:tw-bg-gray-50 tw-transition-colors"
              >
                Cancel
              </button>
              <button 
                type="submit"
                [disabled]="!newTeamMember.name.trim() || !newTeamMember.emailId.trim()"
                class="tw-px-4 tw-py-2 tw-bg-blue-600 tw-text-white tw-rounded-lg hover:tw-bg-blue-700 tw-transition-colors tw-flex tw-items-center tw-gap-2 disabled:tw-opacity-50 disabled:tw-cursor-not-allowed"
              >
                <i class="ri-user-add-line"></i>
                Add Member
              </button>
            </div>
          </div>
        </form>
      </div> -->
    </div>
  </div>
</div>

<!-- Team Member Management Modal -->
<div *ngIf="showTeamMemberModal" class="tw-fixed tw-inset-0 tw-bg-black tw-bg-opacity-50 tw-flex tw-items-center tw-justify-center tw-z-50 tw-p-4" (click)="closeTeamMemberModal()">
  <div class="tw-bg-white tw-rounded-xl tw-shadow-xl tw-w-full tw-max-w-2xl tw-max-h-[90vh] tw-overflow-hidden tw-animate-scale-in" (click)="$event.stopPropagation()">
    
    <!-- Modal Header -->
    <div class="tw-p-6 tw-border-b tw-border-gray-200">
      <div class="tw-flex tw-items-center tw-justify-between">
        <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">
          {{ teamMemberModalMode === 'show' ? 'Team Members' : teamMemberModalMode === 'update' ? 'Update Team Member' : 'Add New Team Member' }}
        </h3>
        <button 
          (click)="closeTeamMemberModal()"
          class="tw-p-2 tw-text-gray-400 hover:tw-text-gray-600 hover:tw-bg-gray-100 tw-rounded-full tw-transition-colors"
        >
          <i class="ri-close-line tw-text-xl"></i>
        </button>
      </div>
    </div>

    <!-- Modal Content -->
    <div class="tw-p-6 tw-max-h-[calc(90vh-140px)] tw-overflow-y-auto">
      
      <!-- Show All Team Members Mode -->
      <div *ngIf="teamMemberModalMode === 'show' && !selectedTeamMember">
        <div class="tw-flex tw-items-center tw-justify-between tw-mb-4">
          <h4 class="tw-text-lg tw-font-medium tw-text-gray-900">All Team Members</h4>
          <button 
            (click)="openTeamMemberModal('add')"
            class="tw-px-4 tw-py-2 tw-bg-blue-600 tw-text-white tw-rounded-lg hover:tw-bg-blue-700 tw-transition-colors tw-flex tw-items-center tw-gap-2"
          >
            <i class="ri-user-add-line"></i>
            Add New Member
          </button>
        </div>
        <div class="tw-space-y-4">
          <div *ngFor="let member of teamMembers; let i = index" 
               class="tw-flex tw-items-center tw-justify-between tw-p-4 tw-bg-gray-50 tw-rounded-lg tw-border">
            <div class="tw-flex tw-items-center tw-gap-4">
              <div class="tw-w-12 tw-h-12 tw-bg-blue-100 tw-rounded-full tw-flex tw-items-center tw-justify-center">
                <span class="tw-text-base tw-font-semibold tw-text-blue-600">
                  {{ getTeamMemberInitials(member) }}
                </span>
              </div>
              <div>
                <h4 class="tw-text-base tw-font-medium tw-text-gray-900">{{ member.name || 'Unknown' }}</h4>
                <p class="tw-text-sm tw-text-gray-600">{{ member.emailId || 'No email' }}</p>
                <p class="tw-text-sm tw-text-purple-600">{{ member.role || 'No role' }}</p>
                <p class="tw-text-xs tw-text-gray-500">
                  Status: {{ member.isDeleted ? 'Inactive' : 'Active' }}
                </p>
              </div>
            </div>
            <div class="tw-flex tw-items-center tw-gap-2">
              <button 
                (click)="openTeamMemberModal('show', member)"
                class="tw-px-3 tw-py-1 tw-text-xs tw-text-blue-600 tw-border tw-border-blue-600 tw-rounded hover:tw-bg-blue-50 tw-transition-colors"
              >
                View Details
              </button>
              <button 
                (click)="openTeamMemberModal('update', member)"
                class="tw-px-3 tw-py-1 tw-text-xs tw-text-green-600 tw-border tw-border-green-600 tw-rounded hover:tw-bg-green-50 tw-transition-colors"
              >
                Update
              </button>
            </div>
          </div>
          <div *ngIf="!teamMembers || teamMembers.length === 0" class="tw-text-center tw-py-12 tw-text-gray-500">
            <i class="ri-team-line tw-text-4xl tw-mb-4"></i>
            <p class="tw-text-lg tw-font-medium">No team members found</p>
            <p class="tw-text-sm">Team members will appear here once added to the CRM.</p>
          </div>
        </div>
      </div>

      <!-- Show Single Team Member Details Mode -->
      <div *ngIf="teamMemberModalMode === 'show' && selectedTeamMember">
        <div class="tw-space-y-6">
          <!-- Member Header -->
          <div class="tw-flex tw-items-center tw-gap-4 tw-p-4 tw-bg-blue-50 tw-rounded-lg">
            <div class="tw-w-16 tw-h-16 tw-bg-blue-100 tw-rounded-full tw-flex tw-items-center tw-justify-center">
              <span class="tw-text-xl tw-font-semibold tw-text-blue-600">
                {{ getTeamMemberInitials(selectedTeamMember) }}
              </span>
            </div>
            <div>
              <h4 class="tw-text-xl tw-font-semibold tw-text-gray-900">{{ selectedTeamMember.name || 'Unknown' }}</h4>
              <p class="tw-text-sm tw-text-gray-600">{{ selectedTeamMember.role || 'No role assigned' }}</p>
              <span class="tw-inline-flex tw-items-center tw-px-2 tw-py-1 tw-text-xs tw-font-medium tw-rounded-full"
                    [class]="selectedTeamMember.isDeleted ? 'tw-bg-red-100 tw-text-red-800' : 'tw-bg-green-100 tw-text-green-800'">
                {{ selectedTeamMember.isDeleted ? 'Inactive' : 'Active' }}
              </span>
            </div>
          </div>

          <!-- Member Details -->
          <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-6">
            <div>
              <h5 class="tw-text-sm tw-font-medium tw-text-gray-700 tw-mb-2">Contact Information</h5>
              <div class="tw-space-y-2">
                <div class="tw-flex tw-items-center tw-gap-2">
                  <i class="ri-mail-line tw-text-gray-400"></i>
                  <span class="tw-text-sm tw-text-gray-600">{{ selectedTeamMember.emailId || 'No email' }}</span>
                </div>
                <div class="tw-flex tw-items-center tw-gap-2">
                  <i class="ri-user-line tw-text-gray-400"></i>
                  <span class="tw-text-sm tw-text-gray-600">ID: {{ selectedTeamMember._id || 'N/A' }}</span>
                </div>
              </div>
            </div>
            <div>
              <h5 class="tw-text-sm tw-font-medium tw-text-gray-700 tw-mb-2">Additional Information</h5>
              <div class="tw-space-y-2">
                <div class="tw-flex tw-items-center tw-gap-2">
                  <i class="ri-shield-user-line tw-text-gray-400"></i>
                  <span class="tw-text-sm tw-text-gray-600">Role: {{ selectedTeamMember.role || 'Not assigned' }}</span>
                </div>
                <div class="tw-flex tw-items-center tw-gap-2">
                  <i class="ri-image-line tw-text-gray-400"></i>
                  <span class="tw-text-sm tw-text-gray-600">
                    Profile Image: {{ selectedTeamMember.profileImage ? 'Available' : 'Not set' }}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="tw-flex tw-items-center tw-gap-3 tw-pt-4 tw-border-t tw-border-gray-200">
            <button 
              (click)="openTeamMemberModal('update', selectedTeamMember)"
              class="tw-px-4 tw-py-2 tw-bg-blue-600 tw-text-white tw-rounded-lg hover:tw-bg-blue-700 tw-transition-colors tw-flex tw-items-center tw-gap-2"
            >
              <i class="ri-edit-line"></i>
              Update Member
            </button>
            <button 
              (click)="openTeamMemberModal('show')"
              class="tw-px-4 tw-py-2 tw-text-gray-700 tw-border tw-border-gray-300 tw-rounded-lg hover:tw-bg-gray-50 tw-transition-colors"
            >
              Back to List
            </button>
          </div>
        </div>
      </div>

      <!-- Update Team Member Mode -->
      <!-- <div *ngIf="teamMemberModalMode === 'update' && selectedTeamMember">
        <form #updateForm="ngForm" (ngSubmit)="updateTeamMember(updateForm.value)">
          <div class="tw-space-y-6">
            <div class="tw-flex tw-items-center tw-gap-4 tw-p-4 tw-bg-green-50 tw-rounded-lg">
              <div class="tw-w-16 tw-h-16 tw-bg-green-100 tw-rounded-full tw-flex tw-items-center tw-justify-center">
                <span class="tw-text-xl tw-font-semibold tw-text-green-600">
                  {{ getTeamMemberInitials(selectedTeamMember) }}
                </span>
              </div>
              <div>
                <h4 class="tw-text-xl tw-font-semibold tw-text-gray-900">Update Member</h4>
                <p class="tw-text-sm tw-text-gray-600">Modify team member information</p>
              </div>
            </div>

            <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-6">
              <div>
                <label class="tw-block tw-text-sm tw-font-medium tw-text-gray-700 tw-mb-2">Full Name</label>
                <input
                  type="text"
                  name="name"
                  [(ngModel)]="selectedTeamMember.name"
                  class="tw-w-full tw-px-4 tw-py-3 tw-border tw-border-gray-300 tw-rounded-lg tw-focus:ring-2 tw-focus:ring-blue-500 tw-focus:border-blue-500 tw-outline-none tw-transition-all tw-duration-200"
                  placeholder="Enter full name"
                  required
                />
              </div>
              <div>
                <label class="tw-block tw-text-sm tw-font-medium tw-text-gray-700 tw-mb-2">Email Address</label>
                <input
                  type="email"
                  name="emailId"
                  [(ngModel)]="selectedTeamMember.emailId"
                  class="tw-w-full tw-px-4 tw-py-3 tw-border tw-border-gray-300 tw-rounded-lg tw-focus:ring-2 tw-focus:ring-blue-500 tw-focus:border-blue-500 tw-outline-none tw-transition-all tw-duration-200"
                  placeholder="Enter email address"
                  required
                />
              </div>
              <div>
                <label class="tw-block tw-text-sm tw-font-medium tw-text-gray-700 tw-mb-2">Role</label>
                <input
                  type="text"
                  name="role"
                  [(ngModel)]="selectedTeamMember.role"
                  class="tw-w-full tw-px-4 tw-py-3 tw-border tw-border-gray-300 tw-rounded-lg tw-focus:ring-2 tw-focus:ring-blue-500 tw-focus:border-blue-500 tw-outline-none tw-transition-all tw-duration-200"
                  placeholder="Enter role"
                />
              </div>
              <div>
                <label class="tw-block tw-text-sm tw-font-medium tw-text-gray-700 tw-mb-2">Status</label>
                <select
                  name="isDeleted"
                  [(ngModel)]="selectedTeamMember.isDeleted"
                  class="tw-w-full tw-px-4 tw-py-3 tw-border tw-border-gray-300 tw-rounded-lg tw-focus:ring-2 tw-focus:ring-blue-500 tw-focus:border-blue-500 tw-outline-none tw-transition-all tw-duration-200"
                >
                  <option [value]="false">Active</option>
                  <option [value]="true">Inactive</option>
                </select>
              </div>
            </div>

            <input type="hidden" name="_id" [(ngModel)]="selectedTeamMember._id" />
            <input type="hidden" name="profileImage" [(ngModel)]="selectedTeamMember.profileImage" />

            <div class="tw-flex tw-items-center tw-justify-end tw-gap-3 tw-pt-4 tw-border-t tw-border-gray-200">
              <button 
                type="button"
                (click)="closeTeamMemberModal()"
                class="tw-px-4 tw-py-2 tw-text-gray-700 tw-border tw-border-gray-300 tw-rounded-lg hover:tw-bg-gray-50 tw-transition-colors"
              >
                Cancel
              </button>
              <button 
                type="submit"
                class="tw-px-4 tw-py-2 tw-bg-green-600 tw-text-white tw-rounded-lg hover:tw-bg-green-700 tw-transition-colors tw-flex tw-items-center tw-gap-2"
              >
                <i class="ri-save-line"></i>
                Update Member
              </button>
            </div>
          </div>
        </form>
      </div> -->
    </div>
  </div>
</div>

<!-- Board-Style Team Member Management Modal -->
<div
  *ngIf="showAddMemberModal"
  class="tw-fixed tw-inset-0 tw-bg-black tw-bg-opacity-50 tw-flex tw-items-center tw-justify-center tw-z-50 tw-animate-fade-in"
  (click)="closeAddMemberModal()"
>
  <div
    class="tw-bg-white tw-rounded-2xl tw-w-full tw-max-w-lg tw-mx-4 tw-flex tw-flex-col tw-max-h-[80vh] overflow-hidden tw-shadow-2xl"
    (click)="$event.stopPropagation()"
  >
    <!-- Fixed Header -->
    <div
      class="tw-flex tw-justify-between tw-items-center tw-p-6 tw-border-b tw-border-gray-200 tw-bg-white tw-z-10"
    >
      <div>
        <h3 class="tw-text-xl tw-font-bold tw-text-gray-900">
          Manage CRM Team Members
        </h3>
        <p class="tw-text-sm tw-text-gray-500 tw-mt-1">
          Select or deselect members for this CRM
        </p>
      </div>
      <button
        (click)="closeAddMemberModal()"
        class="tw-text-gray-400 hover:tw-text-gray-600 tw-transition-colors tw-duration-200 tw-p-1 tw-rounded-full hover:tw-bg-gray-100"
      >
        <svg
          class="tw-w-6 tw-h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </button>
    </div>

    <!-- Members Count Info -->
    <div class="tw-p-6 tw-border-b tw-border-gray-200">
      <div class="tw-flex tw-items-center tw-justify-between tw-mb-4">
        <div class="tw-flex tw-items-center tw-gap-2">
          <div class="tw-w-8 tw-h-8 tw-bg-blue-100 tw-rounded-full tw-flex tw-items-center tw-justify-center">
            <i class="ri-team-line tw-text-blue-600"></i>
          </div>
          <span class="tw-text-sm tw-font-medium tw-text-gray-700">
            {{ selectedMemberIds.length }} of {{ allMembersDetails.length }} members selected
          </span>
        </div>
        <div class="tw-text-xs tw-text-gray-500">
          {{ hasSelectedMembersChanged ? 'Changes detected' : 'No changes' }}
        </div>
      </div>
    </div>

    <!-- Scrollable Content -->
    <div class="tw-flex-1 tw-overflow-y-auto tw-p-6">
      <!-- Loading State -->
      <div *ngIf="membersLoading" class="tw-text-center tw-py-8">
        <div class="tw-animate-spin tw-rounded-full tw-h-8 tw-w-8 tw-border-b-2 tw-border-blue-600 tw-mx-auto tw-mb-4"></div>
        <p class="tw-text-gray-600">Loading available members...</p>
      </div>

      <!-- Members List -->
      <div class="tw-space-y-3">
        <ng-container
          *ngIf="!membersLoading && allMembersDetails.length > 0"
        >
          <div
            *ngFor="let member of allMembersDetails; trackBy: trackByMemberId"
            class="tw-group tw-relative tw-flex tw-items-center tw-justify-between tw-rounded-xl tw-transition-all tw-duration-200 tw-p-4 tw-border"
            [class.tw-border-blue-200]="isMemberSelected(member._id) && !isMemberDisabled(member)"
            [class.tw-bg-blue-50]="isMemberSelected(member._id) && !isMemberDisabled(member)"
            [class.tw-border-gray-200]="!isMemberSelected(member._id) && !isMemberDisabled(member)"
            [class.tw-bg-white]="!isMemberSelected(member._id) && !isMemberDisabled(member)"
            [class.tw-border-gray-200]="isMemberDisabled(member)"
            [class.tw-bg-gray-50]="isMemberDisabled(member)"
            [class.tw-opacity-60]="isMemberDisabled(member)"
            [class.tw-cursor-not-allowed]="isMemberDisabled(member)"
            [class.tw-cursor-pointer]="!isMemberDisabled(member)"
            [class.hover:tw-border-blue-300]="!isMemberDisabled(member) && !isMemberSelected(member._id)"
            [class.hover:tw-bg-gray-100]="!isMemberDisabled(member) && !isMemberSelected(member._id)"
            (click)="!isMemberDisabled(member) && onToggleMemberSelection(member._id)"
          >
            <div class="tw-flex tw-items-center tw-flex-1">
              <!-- Selection Checkbox -->
              <div class="tw-relative tw-mr-4">
                <input
                  type="checkbox"
                  [checked]="isMemberSelected(member._id)"
                  [disabled]="isMemberDisabled(member)"
                  class="tw-w-5 tw-h-5 tw-text-blue-600 tw-bg-gray-100 tw-border-gray-300 tw-rounded focus:tw-ring-blue-500 focus:tw-ring-2"
                  (click)="$event.stopPropagation()"
                  (change)="!isMemberDisabled(member) && onToggleMemberSelection(member._id)"
                />
                <!-- Selection indicator -->
                <div
                  *ngIf="isMemberSelected(member._id) && !isMemberDisabled(member)"
                  class="tw-absolute -tw-top-1 -tw-right-1 tw-w-3 tw-h-3 tw-bg-blue-600 tw-rounded-full tw-flex tw-items-center tw-justify-center"
                >
                  <svg
                    class="tw-w-2 tw-h-2 tw-text-white"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="3"
                      d="M5 13l4 4L19 7"
                    ></path>
                  </svg>
                </div>
              </div>

              <!-- Member Avatar -->
              <div class="tw-w-12 tw-h-12 tw-rounded-full tw-overflow-hidden tw-border-2 tw-border-white tw-shadow-sm tw-mr-4">
                <img
                  *ngIf="member.profileImage; else memberInitialsTemplate"
                  [src]="imageBaseUrl + member.profileImage"
                  [alt]="member.name"
                  class="tw-w-full tw-h-full tw-object-cover"
                />
                <ng-template #memberInitialsTemplate>
                  <div
                    class="tw-w-full tw-h-full tw-bg-gradient-to-br tw-from-blue-500 tw-to-purple-600 tw-flex tw-items-center tw-justify-center tw-text-white tw-text-sm tw-font-semibold"
                  >
                    {{ getTeamMemberInitials(member) }}
                  </div>
                </ng-template>
              </div>

              <!-- Member Info -->
              <div class="tw-flex-1">
                <h4 class="tw-font-semibold tw-text-gray-900 tw-text-sm">
                  {{ member.name }}
                </h4>
                <p class="tw-text-xs tw-text-gray-500">{{ member.emailId }}</p>
                <span
                  class="tw-inline-flex tw-items-center tw-px-2 tw-py-1 tw-rounded-full tw-text-xs tw-font-medium tw-bg-blue-100 tw-text-blue-800 tw-mt-1 tw-capitalize"
                >
                  {{ member.role || 'No role' }}
                </span>
              </div>
            </div>

            <!-- Status Badge -->
            <div class="tw-ml-4">
              <span
                class="tw-inline-flex tw-items-center tw-px-2 tw-py-1 tw-text-xs tw-font-medium tw-rounded-full"
                [class]="member.isDeleted ? 'tw-bg-red-100 tw-text-red-800' : 'tw-bg-green-100 tw-text-green-800'"
              >
                {{ member.isDeleted ? 'Inactive' : 'Active' }}
              </span>
            </div>
          </div>
        </ng-container>

        <!-- Empty State -->
        <div *ngIf="!membersLoading && allMembersDetails.length === 0" class="tw-text-center tw-py-12 tw-text-gray-500">
          <i class="ri-team-line tw-text-4xl tw-mb-4"></i>
          <p class="tw-text-lg tw-font-medium">No available members found</p>
          <p class="tw-text-sm">All team members are already added to this CRM.</p>
        </div>
      </div>
    </div>

    <!-- Fixed Footer -->
    <div class="tw-p-6 tw-border-t tw-border-gray-200 tw-bg-white">
      <div class="tw-flex tw-gap-3">
        <button
          (click)="closeAddMemberModal()"
          class="tw-flex-1 tw-px-4 tw-py-2.5 tw-border tw-border-gray-200 tw-text-gray-700 tw-rounded-lg tw-font-medium hover:tw-bg-gray-50 tw-transition-colors tw-duration-200"
        >
          Cancel
        </button>
        <button
          (click)="updateCrmMembers()"
          [disabled]="!hasSelectedMembersChanged || membersLoading"
          class="tw-flex-1 tw-px-4 tw-py-2.5 tw-rounded-lg tw-font-medium tw-transition-all tw-duration-200 tw-shadow-sm tw-flex tw-items-center tw-justify-center tw-gap-2 tw-bg-blue-600 tw-text-white hover:tw-bg-blue-700 disabled:tw-opacity-50 disabled:tw-cursor-not-allowed"
        >
          <svg
            *ngIf="!hasSelectedMembersChanged"
            class="tw-w-4 tw-h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 13l4 4L19 7"
            ></path>
          </svg>
          <svg
            *ngIf="hasSelectedMembersChanged"
            class="tw-w-4 tw-h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
            ></path>
          </svg>
          {{ hasSelectedMembersChanged ? "Update Members" : "No Changes" }}
        </button>
      </div>
    </div>
  </div>
</div>
