<div
  class="tw-min-h-[calc(100vh-145px)] tw-max-h-[calc(100vh-145px)] tw-overflow-y-hidden"
>
  <div
    class="tw-min-h-screen tw-bg-slate-50 tw-p-6"
    (click)="onDocumentClick($event)"
  >
    <div class="tw-max-w-full tw-mx-auto">
      <!-- CRM Header -->
      <div class="tw-mb-6">
        <div class="tw-flex tw-items-center tw-justify-between tw-mb-2">
          <h1 class="tw-text-3xl tw-font-bold tw-text-gray-900">
            CRM Lead Management
          </h1>
          
          <!-- View Toggle Button -->
          <div class="tw-flex tw-items-center tw-gap-4" *ngIf="crmId()">
            <!-- View Toggle -->
            <div class="tw-flex tw-items-center tw-bg-gray-100 tw-rounded-lg tw-p-1">
              <button
                (click)="setViewMode('kanban')"
                class="tw-px-4 tw-py-2 tw-rounded-md tw-text-sm tw-font-medium tw-transition-all tw-duration-200"
                [ngClass]="{
                  'tw-bg-white tw-text-blue-600 tw-shadow-sm': viewMode() === 'kanban',
                  'tw-text-gray-600 hover:tw-text-gray-900': viewMode() !== 'kanban'
                }"
              >
                <i class="ri-layout-grid-line tw-mr-2"></i>
                Kanban
              </button>
              <button
                (click)="setViewMode('table')"
                class="tw-px-4 tw-py-2 tw-rounded-md tw-text-sm tw-font-medium tw-transition-all tw-duration-200"
                [ngClass]="{
                  'tw-bg-white tw-text-blue-600 tw-shadow-sm': viewMode() === 'table',
                  'tw-text-gray-600 hover:tw-text-gray-900': viewMode() !== 'table'
                }"
              >
                <i class="ri-table-line tw-mr-2"></i>
                Table
              </button>
            </div>

            <!-- Column Filter for Table View -->
            <div *ngIf="viewMode() === 'table'" class="tw-flex tw-items-center tw-gap-2">
              <label class="tw-text-sm tw-font-medium tw-text-gray-700">Filter by Column:</label>
              <select
                [(ngModel)]="selectedTableColumnValue"
                (change)="onTableColumnChange()"
                class="tw-px-3 tw-py-2 tw-border tw-border-gray-300 tw-rounded-md tw-text-sm tw-focus:ring-2 tw-focus:ring-blue-500 tw-focus:border-blue-500"
              >
                <option value="">All Columns</option>
                <option *ngFor="let column of crmColumns()" [value]="column._id">
                  {{ column.title }}
                </option>
              </select>
            </div>
          </div>
        </div>
        <p class="tw-text-gray-600" *ngIf="viewMode() === 'kanban'">Manage your leads efficiently with Kanban view</p>
        <p class="tw-text-gray-600" *ngIf="viewMode() === 'table'">View and manage your leads in a structured table format</p>
      </div>

      <!-- CRM not selected design -->
      <div
        *ngIf="!crmId()"
        class="tw-flex tw-flex-col tw-items-center tw-justify-center tw-h-64 tw-bg-white tw-rounded-lg tw-shadow-md tw-p-8 tw-space-y-4"
      >
        <i class="ri-dashboard-line tw-text-5xl tw-text-gray-400"></i>
        <div class="tw-text-lg tw-font-semibold tw-text-gray-700">
          No CRM Setup Found
        </div>
        <div class="tw-text-gray-500 tw-text-sm">
          Please contact your administrator to set up CRM for your account.
        </div>
      </div>

      <!-- page Loader -->
      <div
        class="tw-fixed tw-top-0 tw-left-0 tw-right-0 tw-bottom-0 tw-flex tw-items-center tw-justify-center tw-bg-[#0000004d] tw-z-50"
        *ngIf="isLoading() && crmId()"
      >
        <div
          class="tw-flex tw-items-center tw-gap-5 tw-bg-white tw-px-8 tw-py-5 tw-rounded"
        >
          <span
            class="tw-animate-spin tw-rounded-full tw-h-5 tw-w-5 tw-border-b-2 tw-border-blue-600"
          ></span
          >Loading...
        </div>
      </div>

      <!-- Kanban Board -->
      <div
        *ngIf="crmId() && viewMode() === 'kanban'"
        #kanbanContainer
        class="tw-flex tw-gap-6 tw-overflow-x-auto tw-pb-4"
        cdkDropList
        cdkDropListOrientation="horizontal"
        [cdkDropListData]="editableColumns()"
        [cdkDropListDisabled]="!crmPermissionsService.isBoardLevelPermission()"
        (cdkDropListDropped)="onColumnDrop($event)"
        style="min-width: 100%"
      >
        <!-- FIXED: Updated cdkDropListGroup for cross-column drag -->
        <div
          cdkDropListGroup
          class="tw-flex tw-gap-6 tw-w-full"
          style="min-width: 1000px"
        >
          <!-- Editable Columns -->
          <div
            *ngFor="let column of editableColumns(); trackBy: trackByColumnId"
            class="tw-flex-shrink-0 tw-w-80 tw-transition-all tw-duration-300 tw-ease-in-out"
            cdkDrag
            [cdkDragData]="column"
            [cdkDragDisabled]="!crmPermissionsService.isBoardLevelPermission()"
          >
            <!-- Column Container -->
            <div
              class="tw-bg-white tw-rounded-xl tw-shadow-sm tw-border tw-border-gray-200 tw-h-fit tw-min-h-[calc(100vh-300px)] tw-transition-all tw-duration-200 tw-relative"
            >
              <!-- Column Header -->
              <div class="tw-p-4 tw-border-b tw-border-gray-100">
                <div
                  class="tw-flex tw-items-center tw-justify-between tw-gap-2"
                >
                  <!-- Drag Handle Button -->
                  <button
                    *ngIf="crmPermissionsService.isBoardLevelPermission()"
                    cdkDragHandle
                    class="tw-p-1 tw-text-gray-400 hover:tw-text-gray-600 hover:tw-bg-gray-100 tw-rounded hover:tw-cursor-move"
                  >
                    <i class="ri-draggable"></i>
                  </button>
                  <!-- Column Title -->
                  <div
                    class="tw-flex tw-items-center tw-flex-1 tw-line-clamp-1 tw-truncate"
                  >
                    <div
                      *ngIf="editingColumnId() !== column._id"
                      class="tw-flex tw-items-center tw-gap-2 tw-flex-1 tw-line-clamp-1 tw-truncate"
                    >
                      <h3
                        class="tw-font-semibold tw-text-gray-900 tw-text-sm tw-line-clamp-1 tw-truncate"
                        title="{{ column.title }}"
                      >
                        {{ column.title }}
                      </h3>
                      <div class="tw-flex tw-items-center tw-gap-2">
                        <span
                          class="tw-bg-gray-100 tw-text-gray-600 tw-text-xs tw-px-2 tw-py-1 tw-rounded-full"
                        >
                          {{ column?.leads?.length }}
                        </span>
                        <span
                          class="tw-bg-green-100 tw-text-green-700 tw-text-xs tw-px-2 tw-py-1 tw-rounded-full tw-font-medium"
                          title="Total Amount"
                        >
                          {{ formatAmount(getColumnTotalAmount(column)) }}
                        </span>
                      </div>
                    </div>

                    <!-- Edit Title Input -->
                    <div
                      *ngIf="editingColumnId() === column._id"
                      class="tw-flex-1"
                    >
                      <input
                        type="text"
                        [value]="newColumnTitle()"
                        (input)="onColumnTitleInput($event)"
                        (keydown.enter)="
                          saveColumnRename(column._id, newColumnTitle())
                        "
                        (keydown.escape)="cancelColumnRename()"
                        (blur)="saveColumnRename(column._id, newColumnTitle())"
                        [attr.data-column-id]="column._id"
                        class="tw-w-full tw-px-2 tw-py-1 tw-text-sm tw-font-semibold tw-text-gray-900 tw-bg-transparent tw-border tw-border-blue-300 tw-rounded tw-focus:outline-none tw-focus:ring-2 tw-focus:ring-blue-500"
                      />
                    </div>
                  </div>

                  <!-- Column Actions -->
                  <div
                    class="tw-relative column-menu-container"
                    *ngIf="
                      column.canEdit &&
                      crmPermissionsService.isBoardLevelPermission()
                    "
                  >
                    <button
                      (click)="toggleColumnMenu(column._id, $event)"
                      class="tw-p-1 tw-rounded tw-text-gray-400 hover:tw-text-gray-600 hover:tw-bg-gray-100 tw-transition-colors tw-duration-200"
                    >
                      <svg
                        class="tw-w-4 tw-h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M12 5v.01M12 12v.01M12 19v.01"
                        ></path>
                      </svg>
                    </button>

                    <!-- Dropdown Menu -->
                    <div
                      *ngIf="activeColumnMenu() === column._id"
                      class="tw-absolute tw-right-0 tw-top-8 tw-bg-white tw-border tw-border-gray-200 tw-rounded-lg tw-shadow-lg tw-z-20 tw-min-w-48"
                    >
                      <div class="tw-py-1">
                        <button
                          (click)="openRenameColumnPopup(column._id)"
                          class="tw-w-full tw-px-4 tw-py-2 tw-text-left tw-text-sm tw-text-gray-700 hover:tw-bg-gray-50 tw-transition-colors tw-duration-200"
                        >
                          <svg
                            class="tw-w-4 tw-h-4 tw-inline tw-mr-2"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                            ></path>
                          </svg>
                          Rename Column
                        </button>

                        <button
                          (click)="openAddColumnPopup('left', column._id)"
                          class="tw-w-full tw-px-4 tw-py-2 tw-text-left tw-text-sm tw-text-gray-700 hover:tw-bg-gray-50 tw-transition-colors tw-duration-200"
                        >
                          <svg
                            class="tw-w-4 tw-h-4 tw-inline tw-mr-2"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                            ></path>
                          </svg>
                          Add Column Left
                        </button>

                        <button
                          (click)="openAddColumnPopup('right', column._id)"
                          class="tw-w-full tw-px-4 tw-py-2 tw-text-left tw-text-sm tw-text-gray-700 hover:tw-bg-gray-50 tw-transition-colors tw-duration-200"
                        >
                          <svg
                            class="tw-w-4 tw-h-4 tw-inline tw-mr-2"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                            ></path>
                          </svg>
                          Add Column Right
                        </button>

                        <div
                          class="tw-border-t tw-border-gray-100 tw-my-1"
                        ></div>

                        <button
                          (click)="deleteColumn(column._id)"
                          [disabled]="column.leads.length > 0"
                          [class.tw-opacity-50]="column.leads.length > 0"
                          [class.tw-cursor-not-allowed]="
                            column.leads.length > 0
                          "
                          class="tw-w-full tw-px-4 tw-py-2 tw-text-left tw-text-sm tw-text-red-600 hover:tw-bg-red-50 tw-transition-colors tw-duration-200 disabled:hover:tw-bg-transparent"
                        >
                          <svg
                            class="tw-w-4 tw-h-4 tw-inline tw-mr-2"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                            ></path>
                          </svg>
                          Delete Column
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Leads Container -->
              <div
                class="tw-p-4 tw-space-y-3 tw-min-h-[calc(100vh-370px)] tw-max-h-[calc(100vh-370px)] tw-overflow-y-auto task-container-scroll tw-transition-all tw-duration-200"
                cdkDropList
                [id]="column._id"
                [cdkDropListData]="column.leads"
                (cdkDropListDropped)="onLeadDrop($event, column._id)"
                [class.tw-bg-blue-50]="
                  isDragging() && draggedLead()?.column !== column._id
                "
                [class.tw-border-2]="
                  isDragging() && draggedLead()?.column !== column._id
                "
                [class.tw-border-blue-300]="
                  isDragging() && draggedLead()?.column !== column._id
                "
                [class.tw-border-dashed]="
                  isDragging() && draggedLead()?.column !== column._id
                "
              >
                <!-- Lead Cards -->
                <div
                  *ngFor="let lead of column.leads; trackBy: trackByLeadId"
                  class="tw-transition-all tw-duration-300 tw-ease-in-out"
                  cdkDrag
                  [cdkDragData]="lead"
                  [cdkDragDisabled]="
                    !crmPermissionsService.isTaskLevelPermission()
                  "
                  (cdkDragStarted)="onDragStarted(lead)"
                  (cdkDragEnded)="onDragEnded()"
                >
                  <app-lead-card
                    [assignedToMe]="
                      isAssignmentFilterActive() ? lead.assignedToMe : false
                    "
                    [lead]="lead"
                    [isSelected]="selectedLead()?._id === lead._id"
                    [isDragging]="
                      isDragging() && draggedLead()?._id === lead._id
                    "
                    [crmId]="crmId()"
                    [wonColumnId]="wonColumnId()"
                    [lostColumnId]="lostColumnId()"
                    [categories]="categories()"
                    (leadClick)="selectLead(lead)"
                    (leadDoubleClick)="onLeadDoubleClick(lead)"
                    (leadWin)="winLead(lead)"
                    (leadLose)="loseLead(lead)"
                    (leadOpen)="openLead(lead)"
                    (dragStarted)="onDragStarted(lead)"
                    (dragEnded)="onDragEnded()"
                  >
                  </app-lead-card>
                </div>

                <!-- Drop Placeholder -->
                <div
                  *cdkDropListPlaceholder
                  class="tw-my-3 tw-h-20 tw-border-2 tw-border-dashed tw-border-blue-300 tw-rounded-lg tw-bg-blue-50"
                ></div>
              </div>
            </div>
          </div>

          <!-- Fixed Columns (Won & Lost) -->
          <div
            *ngFor="let column of fixedColumns(); trackBy: trackByColumnId"
            class="tw-flex-shrink-0 tw-w-80 tw-transition-all tw-duration-300 tw-ease-in-out"
          >
            <!-- Column Container -->
            <div
              class="tw-bg-white tw-rounded-xl tw-shadow-sm tw-border tw-border-gray-200 tw-h-fit tw-max-h-[calc(100vh-175px)] tw-transition-all tw-duration-200"
            >
              <!-- Column Header -->
              <div class="tw-p-4 tw-border-b tw-border-gray-100">
                <div class="tw-flex tw-items-center tw-justify-between">
                  <div class="tw-flex tw-items-center tw-gap-2">
                    <h3 class="tw-font-semibold tw-text-gray-900 tw-text-sm">
                      {{ column.title }}
                    </h3>
                    <div class="tw-flex tw-items-center tw-gap-2">
                      <span
                        class="tw-bg-gray-100 tw-text-gray-600 tw-text-xs tw-px-2 tw-py-1 tw-rounded-full"
                      >
                        {{ column?.leads?.length }}
                      </span>
                      <span
                        class="tw-bg-green-100 tw-text-green-700 tw-text-xs tw-px-2 tw-py-1 tw-rounded-full tw-font-medium"
                        title="Total Amount"
                      >
                        {{ formatAmount(getColumnTotalAmount(column)) }}
                      </span>
                    </div>
                    <svg
                      *ngIf="crmPermissionsService.isBoardLevelPermission()"
                      class="tw-w-4 tw-h-4 tw-text-gray-400 tw-ml-1"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                      ></path>
                    </svg>
                  </div>
                </div>
              </div>

              <!-- Leads Container -->
              <!-- For fixed columns -->
              <div
                class="tw-p-4 tw-space-y-3 tw-min-h-[calc(100vh-370px)] tw-max-h-[calc(100vh-370px)] tw-overflow-y-auto task-container-scroll tw-transition-all tw-duration-200"
                cdkDropList
                [id]="column._id"
                [cdkDropListData]="column.leads"
                (cdkDropListDropped)="onLeadDrop($event, column._id)"
                [class.tw-bg-blue-50]="
                  isDragging() && draggedLead()?.column !== column._id
                "
                [class.tw-border-2]="
                  isDragging() && draggedLead()?.column !== column._id
                "
                [class.tw-border-blue-300]="
                  isDragging() && draggedLead()?.column !== column._id
                "
                [class.tw-border-dashed]="
                  isDragging() && draggedLead()?.column !== column._id
                "
              >
                <!-- Lead Cards -->
                <div
                  *ngFor="let lead of column.leads; trackBy: trackByLeadId"
                  class="tw-transition-all tw-duration-300 tw-ease-in-out"
                  cdkDrag
                  [cdkDragData]="lead"
                  [cdkDragDisabled]="
                    !crmPermissionsService.isTaskLevelPermission()
                  "
                  (cdkDragStarted)="onDragStarted(lead)"
                  (cdkDragEnded)="onDragEnded()"
                >
                  <app-lead-card
                    [lead]="lead"
                    [isSelected]="selectedLead()?._id === lead._id"
                    [isDragging]="
                      isDragging() && draggedLead()?.column !== column._id
                    "
                    [crmId]="crmId()"
                    [wonColumnId]="wonColumnId()"
                    [lostColumnId]="lostColumnId()"
                    [categories]="categories()"
                    (leadClick)="selectLead(lead)"
                    (leadDoubleClick)="onLeadDoubleClick(lead)"
                    (leadWin)="winLead(lead)"
                    (leadLose)="loseLead(lead)"
                    (leadOpen)="openLead(lead)"
                    (dragStarted)="onDragStarted(lead)"
                    (dragEnded)="onDragEnded()"
                  >
                  </app-lead-card>
                </div>

                <!-- Drop Placeholder -->
                <div
                  *cdkDropListPlaceholder
                  class="tw-my-3 tw-h-20 tw-border-2 tw-border-dashed tw-border-blue-300 tw-rounded-lg tw-bg-blue-50"
                ></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Table View -->
      <div
        *ngIf="crmId() && viewMode() === 'table' && !isLoading()"
        class="tw-bg-white tw-rounded-xl tw-shadow-sm tw-border tw-border-gray-200 tw-overflow-hidden tw-max-h-[calc(100vh-280px)] tw-overflow-y-auto tw-transition-all tw-duration-200"
      >
        <!-- Table Header -->
        <div class="tw-px-6 tw-py-4 tw-border-b tw-border-gray-100">
          <div class="tw-flex tw-items-center tw-justify-between">
            <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">
              Leads Table View
            </h3>
            <div class="tw-text-sm tw-text-gray-500">
              {{ filteredLeadsForTable().length }} leads
            </div>
          </div>
        </div>

        <!-- Table Content -->
        <div class="tw-overflow-x-auto">
          <table class="tw-w-full">
            <thead class="tw-bg-gray-50">
              <tr>
                <th class="tw-px-6 tw-py-3 tw-text-left tw-text-xs tw-font-medium tw-text-gray-500 tw-uppercase tw-tracking-wider">
                  Lead
                </th>
                <th class="tw-px-6 tw-py-3 tw-text-left tw-text-xs tw-font-medium tw-text-gray-500 tw-uppercase tw-tracking-wider">
                  Contact
                </th>
                <th class="tw-px-6 tw-py-3 tw-text-left tw-text-xs tw-font-medium tw-text-gray-500 tw-uppercase tw-tracking-wider">
                  Status
                </th>
                <th class="tw-px-6 tw-py-3 tw-text-left tw-text-xs tw-font-medium tw-text-gray-500 tw-uppercase tw-tracking-wider">
                  Priority
                </th>
                <th class="tw-px-6 tw-py-3 tw-text-left tw-text-xs tw-font-medium tw-text-gray-500 tw-uppercase tw-tracking-wider">
                  Amount
                </th>
                <th class="tw-px-6 tw-py-3 tw-text-left tw-text-xs tw-font-medium tw-text-gray-500 tw-uppercase tw-tracking-wider">
                  Assigned To
                </th>
                <th class="tw-px-6 tw-py-3 tw-text-left tw-text-xs tw-font-medium tw-text-gray-500 tw-uppercase tw-tracking-wider">
                  Created
                </th>
              </tr>
            </thead>
            <tbody class="tw-bg-white tw-divide-y tw-divide-gray-200">
              <tr
                *ngFor="let lead of filteredLeadsForTable(); trackBy: trackByLeadId"
                (click)="selectLead(lead)"
                class="tw-cursor-pointer hover:tw-bg-gray-50 tw-transition-colors tw-duration-150"
                [ngClass]="{
                  'tw-bg-blue-50 tw-border-l-4 tw-border-l-blue-500': selectedLead()?._id === lead._id
                }"
              >
                <td class="tw-px-6 tw-py-4 tw-whitespace-nowrap">
                  <div class="tw-flex tw-items-center">
                    <div class="tw-flex-shrink-0 tw-w-10 tw-h-10">
                      <div class="tw-w-10 tw-h-10 tw-rounded-full tw-bg-blue-100 tw-flex tw-items-center tw-justify-center">
                        <span class="tw-text-sm tw-font-medium tw-text-blue-600">
                          {{ lead?.contactDetails?.name?.charAt(0)?.toUpperCase() || 'L' }}
                        </span>
                      </div>
                    </div>
                    <div class="tw-ml-4">
                      <div class="tw-text-sm tw-font-medium tw-text-gray-900 tw-line-clamp-1">
                        {{ lead.title }}
                      </div>
                      <div class="tw-text-sm tw-text-gray-500 tw-line-clamp-1">
                        {{ lead.description || 'No description' }}
                      </div>
                    </div>
                  </div>
                </td>
                <td class="tw-px-6 tw-py-4 tw-whitespace-nowrap">
                  <div class="tw-text-sm tw-text-gray-900">
                    {{ lead?.contactDetails?.name || 'N/A' }}
                  </div>
                  <div class="tw-text-sm tw-text-gray-500">
                    {{ lead?.contactDetails?.email || 'N/A' }}
                  </div>
                  <div class="tw-text-sm tw-text-gray-500">
                    {{ lead?.contactDetails?.phone || 'N/A' }}
                  </div>
                </td>
                <td class="tw-px-6 tw-py-4 tw-whitespace-nowrap">
                  <span
                    class="tw-inline-flex tw-items-center tw-px-2.5 tw-py-0.5 tw-rounded-full tw-text-xs tw-font-medium"
                    [ngClass]="{
                      'tw-bg-green-100 tw-text-green-800': getColumnTitle(lead.column).toLowerCase() === 'won',
                      'tw-bg-red-100 tw-text-red-800': getColumnTitle(lead.column).toLowerCase() === 'lost',
                      'tw-bg-blue-100 tw-text-blue-800': !['won', 'lost'].includes(getColumnTitle(lead.column).toLowerCase() || '')
                    }"
                  >
                    {{ getColumnTitle(lead.column) || 'Unknown' }}
                  </span>
                </td>
                <td class="tw-px-6 tw-py-4 tw-whitespace-nowrap">
                  <span
                    class="tw-inline-flex tw-items-center tw-px-2.5 tw-py-0.5 tw-rounded-full tw-text-xs tw-font-medium"
                    [ngClass]="{
                      'tw-bg-red-100 tw-text-red-800': lead.priority === 'hot',
                      'tw-bg-orange-100 tw-text-orange-800': lead.priority === 'warm',
                      'tw-bg-blue-100 tw-text-blue-800': lead.priority === 'cold'
                    }"
                  >
                    {{ lead.priority ? (lead.priority.charAt(0).toUpperCase() + lead.priority.slice(1)) : 'N/A' }}
                  </span>
                </td>
                <td class="tw-px-6 tw-py-4 tw-whitespace-nowrap">
                  <div class="tw-text-sm tw-font-medium tw-text-gray-900">
                    {{ formatAmount(lead.amount) }}
                  </div>
                </td>
                <td class="tw-px-6 tw-py-4 tw-whitespace-nowrap">
                  <div class="tw-flex tw-items-center tw-space-x-2">
                    <div
                      *ngFor="let member of lead.assignedTo?.slice(0, 3); let i = index"
                      class="tw-relative"
                    >
                      <div
                        class="tw-w-8 tw-h-8 tw-rounded-full tw-bg-gray-200 tw-flex tw-items-center tw-justify-center tw-text-xs tw-font-medium tw-text-gray-600"
                        [title]="member?.name || 'Unknown'"
                      >
                        {{ getMemberInitials(member || {}) }}
                      </div>
                    </div>
                    <span
                      *ngIf="lead.assignedTo && lead.assignedTo.length > 3"
                      class="tw-text-xs tw-text-gray-500"
                    >
                      +{{ (lead?.assignedTo?.length || 0) - 3 }}
                    </span>
                  </div>
                </td>
                <td class="tw-px-6 tw-py-4 tw-whitespace-nowrap">
                  <div class="tw-text-sm tw-text-gray-900">
                    {{ lead.createdAt | date:'MMM dd, yyyy' }}
                  </div>
                  <div class="tw-text-sm tw-text-gray-500">
                    {{ lead.createdAt | date:'HH:mm' }}
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Empty State -->
        <div
          *ngIf="filteredLeadsForTable().length === 0"
          class="tw-flex tw-flex-col tw-items-center tw-justify-center tw-py-12 tw-px-6"
        >
          <i class="ri-file-list-line tw-text-4xl tw-text-gray-400 tw-mb-4"></i>
          <div class="tw-text-lg tw-font-medium tw-text-gray-700 tw-mb-2">
            No leads found
          </div>
          <div class="tw-text-gray-500 tw-text-sm tw-text-center">
            {{ selectedTableColumn() ? 'No leads in the selected column' : 'No leads available' }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- column name input popup with modern interactive design -->
<!-- Modern Column Name Input Popup -->
<div
  *ngIf="showColumnNamePopup()"
  class="tw-fixed tw-inset-0 tw-bg-black tw-bg-opacity-50 tw-flex tw-items-center tw-justify-center tw-z-40 tw-p-4"
  (click)="closeColumnNamePopup()"
>
  <div
    class="tw-bg-white tw-rounded-xl tw-shadow-xl tw-w-full tw-max-w-md tw-overflow-hidden tw-animate-scale-in"
    (click)="$event.stopPropagation()"
  >
    <form [formGroup]="columnForm" (ngSubmit)="handleColumnNameSubmit()">
      <div class="tw-p-6">
        <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900 tw-mb-4">
          {{ popupMode() === "add" ? "Add New Column" : "Rename Column" }}
        </h3>

        <input
          id="columnNameInput"
          type="text"
          formControlName="columnName"
          class="tw-w-full tw-px-4 tw-py-3 tw-border tw-border-gray-300 tw-rounded-lg tw-focus:ring-2 tw-focus:ring-blue-500 tw-focus:border-blue-500 tw-outline-none tw-transition-all tw-duration-200"
          placeholder="Enter column name"
          autofocus
        />

        <div
          *ngIf="
            columnForm.get('columnName')?.invalid &&
            (columnForm.get('columnName')?.dirty ||
              columnForm.get('columnName')?.touched)
          "
          class="tw-text-red-500 tw-text-sm tw-mt-1"
        >
          <div *ngIf="columnForm.get('columnName')?.errors?.['required']">
            Column name is required
          </div>
          <div *ngIf="columnForm.get('columnName')?.errors?.['duplicateName']">
            Column name already exists
          </div>
        </div>

        <div class="tw-flex tw-justify-end tw-gap-3 tw-mt-6">
          <button
            type="button"
            (click)="closeColumnNamePopup()"
            class="tw-px-4 tw-py-2 tw-text-gray-700 hover:tw-bg-gray-100 tw-rounded-lg tw-transition-colors tw-duration-200"
          >
            Cancel
          </button>
          <button
            type="submit"
            [disabled]="columnForm.invalid"
            class="tw-px-4 tw-px-4 tw-py-2 tw-bg-blue-600 tw-text-white hover:tw-bg-blue-700 tw-rounded-lg tw-transition-colors tw-duration-200 disabled:tw-opacity-50 disabled:tw-cursor-not-allowed"
          >
            {{ popupMode() === "add" ? "Add" : "Save" }}
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- filter -->
<!-- <button
  *ngIf="crmId()"
  title="whats assigned to me"
  (click)="onToggleAssignmentFilter()"
  class="tw-fixed tw-bottom-40 tw-right-7 hover:tw-bg-blue-600 hover:tw-text-white tw-rounded-full tw-p-4 tw-shadow-lg hover:tw-shadow-xl tw-transition-all tw-duration-200 tw-z-30 tw-flex tw-items-center tw-justify-center tw-h-14 tw-w-14"
  [ngClass]="{
    'tw-bg-blue-100 tw-text-blue-600': isAssignmentFilterActive(),
    'tw-bg-blue-500 tw-text-white': !isAssignmentFilterActive()
  }"
>
  <i *ngIf="!isAssignmentFilterActive()" class="ri-filter-fill"></i>
  <i *ngIf="isAssignmentFilterActive()" class="ri-filter-off-fill"></i>
</button> -->

<!-- Add Lead Button (Floating) -->
<button
  *ngIf="crmId()"
  (click)="openAddLeadModal()"
  class="tw-fixed tw-bottom-24 tw-right-7 tw-bg-blue-500 hover:tw-bg-blue-600 tw-text-white tw-rounded-full tw-p-4 tw-shadow-lg hover:tw-shadow-xl tw-transition-all tw-duration-200 tw-z-30"
>
  <svg
    class="tw-w-6 tw-h-6"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"
  >
    <path
      stroke-linecap="round"
      stroke-linejoin="round"
      stroke-width="2"
      d="M12 6v6m0 0v6m0-6h6m-6 0H6"
    ></path>
  </svg>
</button>

<!-- Lead Creation Popup -->
<app-common-lead-create-popup
  *ngIf="showCreatePopup()"
  [isVisible]="showCreatePopup()"
  [createLeadData]="createLeadData()"
  (leadCreated)="onLeadCreated($event)"
  (popupClosed)="onPopupClosed()"
></app-common-lead-create-popup>

<!-- Needed for rendering popup -->
<router-outlet></router-outlet>
