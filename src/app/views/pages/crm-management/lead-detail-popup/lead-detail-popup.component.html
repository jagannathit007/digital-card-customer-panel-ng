<!-- Desktop Modal -->
<div
  class="tw-fixed tw-inset-0 tw-bg-black/70 tw-backdrop-blur-sm tw-flex tw-items-center tw-justify-center tw-z-50 tw-p-4 md:tw-p-6 tw-transition-all tw-duration-300"
  (click)="closePopup()"
>
  <!-- Modal Container -->
  <div
    class="tw-bg-white tw-rounded-2xl tw-shadow-2xl tw-w-full tw-h-full md:tw-w-[950px] md:tw-h-[750px] tw-flex tw-flex-col tw-overflow-hidden tw-animate-scale-in"
    (click)="$event.stopPropagation()"
  >
    <!-- Header -->
    <div
      class="tw-flex tw-items-center tw-justify-between tw-p-4 md:tw-p-6 tw-border-b tw-border-gray-200 tw-bg-gray-50"
    >
      <div class="tw-flex tw-items-center tw-space-x-3">
        <div
          class="tw-w-8 tw-h-8 tw-bg-blue-500 tw-rounded-lg tw-flex tw-items-center tw-justify-center"
        >
          <i class="fas fa-user-tie tw-text-white tw-text-sm"></i>
        </div>
        <span class="tw-text-lg tw-font-semibold tw-text-gray-900"
          >Lead Details</span
        >
      </div>

      <button
        type="button"
        class="tw-p-2 tw-text-gray-400 hover:tw-text-gray-600 hover:tw-bg-gray-200 tw-rounded-lg tw-transition-all tw-duration-200"
        (click)="closePopup()"
      >
        <i class="fas fa-times tw-text-lg"></i>
      </button>
    </div>

    <!-- Content Area -->
    <div class="tw-flex-1 tw-flex tw-flex-col tw-overflow-hidden">
      <!-- Lead Title Section -->
      <div
        class="tw-px-5 tw-py-4 md:tw-p-6 md:tw-py-5 tw-bg-gray-50 tw-border-b tw-border-gray-200"
      >
        <div *ngIf="isLoading" class="tw-p-2">
          <!-- shimmer effect -->
          <div
            class="tw-w-full tw-h-9 tw-bg-gradient-to-r tw-from-gray-200 tw-via-gray-100 tw-to-gray-200 tw-rounded-xl tw-animate-pulse tw-mb-2"
          ></div>
        </div>

        <!-- Editable Title -->
        <div class="tw-mb-3 tw-relative" *ngIf="!isLoading">
          <div
            *ngIf="!isEditingTitle"
            class="tw-group tw-cursor-pointer tw-py-3 tw-px-4 tw-rounded-xl hover:tw-bg-white tw-transition-all tw-duration-300"
            (click)="startEditingTitle()"
          >
            <div class="tw-flex tw-items-center tw-justify-between">
              <h2
                class="tw-text-2xl md:tw-text-3xl tw-font-bold tw-text-gray-900 tw-flex-1 tw-pr-2"
              >
                {{ lead.title || "Untitled Lead" }}
              </h2>
              <i
                class="fas fa-edit tw-text-blue-500 group-hover:tw-text-blue-700 tw-text-base tw-transition-all tw-duration-300"
              ></i>
            </div>
          </div>

          <!-- Title Edit Mode -->
          <div *ngIf="isEditingTitle" class="tw-relative">
            <input
              id="editTitleInput"
              type="text"
              [(ngModel)]="editTitle"
              (keydown)="onTitleKeydown($event)"
              class="tw-w-full tw-text-2xl md:tw-text-3xl tw-font-bold tw-text-gray-900 tw-bg-white tw-border-2 tw-border-blue-200 tw-rounded-xl tw-outline-none tw-px-4 tw-py-3 focus:tw-border-blue-500 tw-transition-all tw-duration-300 tw-shadow-sm"
              placeholder="Enter lead title..."
              autofocus
            />

            <div
              class="tw-flex tw-justify-end tw-items-center tw-space-x-3 tw-absolute tw-left-0 tw-right-0 tw-top-full tw-z-10 tw-bg-white tw-py-3 tw-px-4 tw-border-t tw-border-gray-200 tw-rounded-b-xl tw-shadow-lg tw-mt-1"
            >
              <button
                type="button"
                (click)="saveTitle()"
                [disabled]="!editTitle.trim() || isSavingTitle"
                class="tw-px-5 tw-py-2.5 tw-bg-blue-600 tw-text-white tw-text-sm tw-font-semibold tw-rounded-xl hover:tw-bg-blue-700 disabled:tw-bg-gray-300 disabled:tw-cursor-not-allowed tw-transition-all tw-duration-300 tw-flex tw-items-center tw-space-x-2 tw-shadow-md hover:tw-shadow-lg"
              >
                <i *ngIf="isSavingTitle" class="fas fa-spinner fa-spin"></i>
                <span>{{ isSavingTitle ? "Saving..." : "Save" }}</span>
              </button>
              <button
                type="button"
                (click)="cancelTitleEdit()"
                [disabled]="isSavingTitle"
                class="tw-px-5 tw-py-2.5 tw-bg-gray-100 tw-text-gray-700 tw-text-sm tw-font-semibold tw-rounded-xl hover:tw-bg-gray-200 disabled:tw-opacity-50 tw-transition-all tw-duration-300 tw-shadow-sm"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>

        <!-- shimmer effect for this section -->
        <div *ngIf="isLoading" class="tw-flex tw-justify-between tw-mt-4">
          <div class="tw-flex tw-gap-4">
            <div
              class="tw-w-full tw-h-[42px] tw-bg-gradient-to-r tw-from-gray-200 tw-via-gray-100 tw-to-gray-200 tw-rounded-xl tw-animate-pulse tw-min-w-[140px] tw-max-w-[140px]"
            ></div>
            <div
              class="tw-w-full tw-h-[42px] tw-bg-gradient-to-r tw-from-gray-200 tw-via-gray-100 tw-to-gray-200 tw-rounded-xl tw-animate-pulse tw-min-w-[130px] tw-max-w-[130px]"
            ></div>
          </div>
          <div
            class="tw-w-full tw-h-[42px] tw-bg-gradient-to-r tw-from-gray-200 tw-via-gray-100 tw-to-gray-200 tw-rounded-xl tw-animate-pulse tw-min-w-[180px] tw-max-w-[180px]"
          ></div>
        </div>

        <!-- Status, Priority, Category, and Assignment Row -->
        <div *ngIf="!isLoading" class="tw-flex tw-flex-col tw-gap-4 tw-mt-4">
          <!-- Left Side: Priority, Category, and Closing Date -->
          <div
            class="tw-flex tw-flex-col sm:tw-flex-row tw-items-start sm:tw-items-center tw-space-y-3 sm:tw-space-y-0 sm:tw-space-x-4"
          >
            <!-- Priority Select -->
            <div class="tw-relative">
              <select
                [(ngModel)]="lead.priority"
                (change)="updatePriority(lead.priority)"
                class="tw-appearance-none tw-bg-white tw-border-2 tw-border-gray-200 tw-rounded-xl tw-px-4 tw-py-2.5 tw-text-sm tw-font-semibold tw-text-gray-700 focus:tw-ring-2 focus:tw-ring-blue-500 focus:tw-border-blue-500 tw-transition-all tw-duration-300 tw-cursor-pointer tw-pr-10 hover:tw-border-gray-300 tw-shadow-sm"
              >
                <option
                  *ngFor="let option of priorityOptions"
                  [value]="option.value"
                >
                  {{ option.label }}
                </option>
              </select>
              <i
                class="fas fa-chevron-down tw-absolute tw-right-3 tw-top-1/2 tw-transform tw--translate-y-1/2 tw-text-gray-400 tw-text-xs tw-pointer-events-none"
              ></i>
            </div>

            <!-- Category Select -->
            <div class="tw-relative">
              <select
                [(ngModel)]="lead.category"
                (change)="updateCategory(lead.category || '')"
                class="tw-appearance-none tw-bg-white tw-border-2 tw-border-gray-200 tw-rounded-xl tw-px-4 tw-py-2.5 tw-text-sm tw-font-semibold tw-text-gray-700 focus:tw-ring-2 focus:tw-ring-blue-500 focus:tw-border-blue-500 tw-transition-all tw-duration-300 tw-cursor-pointer tw-pr-10 hover:tw-border-gray-300 tw-shadow-sm"
              >
                <option value="">No Category</option>
                <option
                  *ngFor="let category of availableCategories"
                  [value]="category._id"
                >
                  {{ category.name }}
                </option>
              </select>
              <i
                class="fas fa-chevron-down tw-absolute tw-right-3 tw-top-1/2 tw-transform tw--translate-y-1/2 tw-text-gray-400 tw-text-xs tw-pointer-events-none"
              ></i>
            </div>
          </div>

          <!-- Right Side: Assignment -->
          <div class="tw-flex tw-items-center tw-gap-3">
            <!-- Closing Date -->
            <div class="tw-relative">
              <ng-container
                *ngIf="lead.closingDate; else noClosingDateTemplate"
              >
                <div
                  class="tw-bg-blue-50 tw-text-blue-700 tw-px-4 tw-py-2.5 tw-rounded-xl tw-text-sm tw-font-semibold tw-inline-flex tw-items-center tw-space-x-2 tw-cursor-pointer tw-border-2 tw-border-blue-200 hover:tw-bg-blue-100 hover:tw-text-blue-800 tw-transition-all tw-duration-300 tw-shadow-sm"
                  (click)="toggleDatePicker()"
                >
                  <i class="fas fa-calendar-check tw-text-sm"></i>
                  <span>Closing: {{ formatDate(lead.closingDate) }}</span>
                </div>
              </ng-container>

              <ng-template #noClosingDateTemplate>
                <div
                  class="tw-bg-gray-50 tw-text-gray-700 tw-px-4 tw-py-2.5 tw-rounded-xl tw-text-sm tw-font-semibold tw-inline-flex tw-items-center tw-space-x-2 tw-cursor-pointer tw-border-2 tw-border-gray-200 hover:tw-bg-gray-100 tw-transition-all tw-duration-300 tw-shadow-sm"
                  (click)="toggleDatePicker()"
                >
                  <i class="fas fa-calendar-plus tw-text-sm"></i>
                  <span>Set closing date</span>
                </div>
              </ng-template>

              <!-- Date Picker Popup -->
              <div
                *ngIf="showCustomDatePicker"
                class="tw-absolute tw-top-full tw-left-0 tw-mt-2 tw-bg-white tw-border-2 tw-border-gray-200 tw-rounded-2xl tw-shadow-xl tw-p-5 tw-w-80 tw-z-50"
                (click)="$event.stopPropagation()"
              >
                <div class="tw-flex tw-items-center tw-justify-between tw-mb-4">
                  <button
                    type="button"
                    (click)="
                      currentCalendarDate.setMonth(
                        currentCalendarDate.getMonth() - 1
                      )
                    "
                    class="tw-p-2 tw-text-gray-600 hover:tw-text-gray-800 tw-rounded-lg hover:tw-bg-gray-100 tw-transition-all tw-duration-200"
                  >
                    <i class="fas fa-chevron-left tw-text-sm"></i>
                  </button>

                  <h3 class="tw-text-sm tw-font-bold tw-text-gray-900">
                    {{ currentCalendarDate | date : "MMMM yyyy" }}
                  </h3>

                  <button
                    type="button"
                    (click)="
                      currentCalendarDate.setMonth(
                        currentCalendarDate.getMonth() + 1
                      )
                    "
                    class="tw-p-2 tw-text-gray-600 hover:tw-text-gray-800 tw-rounded-lg hover:tw-bg-gray-100 tw-transition-all tw-duration-200"
                  >
                    <i class="fas fa-chevron-right tw-text-sm"></i>
                  </button>
                </div>

                <div class="tw-grid tw-grid-cols-7 tw-gap-1 tw-mb-3">
                  <div
                    *ngFor="let day of dayHeaders"
                    class="tw-text-center tw-text-xs tw-font-semibold tw-text-gray-500 tw-py-2"
                  >
                    {{ day }}
                  </div>

                  <button
                    *ngFor="let day of getCalendarDays()"
                    type="button"
                    (click)="selectDate(day.date)"
                    [disabled]="!day.isCurrentMonth"
                    [class]="getDateButtonClass(day)"
                    class="tw-w-9 tw-h-9 tw-text-sm tw-rounded-lg tw-flex tw-items-center tw-justify-center tw-transition-all tw-duration-200 hover:tw-bg-blue-100"
                  >
                    {{ day.date.getDate() }}
                  </button>
                </div>

                <div
                  class="tw-flex tw-items-center tw-justify-between tw-pt-3 tw-border-t tw-border-gray-200"
                >
                  <button
                    type="button"
                    (click)="updateClosingDate(null)"
                    class="tw-text-xs tw-text-red-600 hover:tw-text-red-800 tw-px-3 tw-py-2 tw-rounded-lg hover:tw-bg-red-50 tw-transition-all tw-duration-200 tw-font-semibold"
                  >
                    NO DATE
                  </button>

                  <button
                    type="button"
                    (click)="setClosingDate()"
                    class="tw-text-xs tw-text-blue-600 hover:tw-text-blue-800 tw-px-3 tw-py-2 tw-rounded-lg hover:tw-bg-blue-50 tw-transition-all tw-duration-200 tw-font-semibold"
                  >
                    TODAY
                  </button>
                </div>
              </div>
            </div>

            <!-- Quotation Date (New Feature) -->
            <div class="tw-relative">
              <ng-container
                *ngIf="lead.quotationDate; else noQuotationDateTemplate"
              >
                <div
                  class="tw-bg-gradient-to-r tw-from-green-50 tw-to-emerald-50 tw-text-green-700 tw-px-4 tw-py-2.5 tw-rounded-xl tw-text-sm tw-font-semibold tw-inline-flex tw-items-center tw-space-x-2 tw-cursor-pointer tw-border-2 tw-border-green-200 hover:tw-from-green-100 hover:tw-to-emerald-100 tw-transition-all tw-duration-300 tw-shadow-sm"
                  (click)="toggleQuotationDatePicker()"
                >
                  <i class="fas fa-file-invoice tw-text-sm"></i>
                  <span>Quotation: {{ formatDate(lead.quotationDate) }}</span>
                </div>
              </ng-container>

              <ng-template #noQuotationDateTemplate>
                <div
                  class="tw-bg-gradient-to-r tw-from-gray-50 tw-to-gray-100 tw-text-gray-700 tw-px-4 tw-py-2.5 tw-rounded-xl tw-text-sm tw-font-semibold tw-inline-flex tw-items-center tw-space-x-2 tw-cursor-pointer tw-border-2 tw-border-gray-200 hover:tw-from-gray-100 hover:tw-to-gray-200 tw-transition-all tw-duration-300 tw-shadow-sm"
                  (click)="toggleQuotationDatePicker()"
                >
                  <i class="fas fa-file-invoice-dollar tw-text-sm"></i>
                  <span>Set quotation date</span>
                </div>
              </ng-template>

              <!-- Quotation Date Picker Popup -->
              <div
                *ngIf="showQuotationDatePicker"
                class="tw-absolute tw-top-full tw-left-0 tw-mt-2 tw-bg-white tw-border-2 tw-border-gray-200 tw-rounded-2xl tw-shadow-xl tw-p-5 tw-w-80 tw-z-50"
                (click)="$event.stopPropagation()"
              >
                <div class="tw-flex tw-items-center tw-justify-between tw-mb-4">
                  <button
                    type="button"
                    (click)="
                      currentQuotationCalendarDate.setMonth(
                        currentQuotationCalendarDate.getMonth() - 1
                      )
                    "
                    class="tw-p-2 tw-text-gray-600 hover:tw-text-gray-800 tw-rounded-lg hover:tw-bg-gray-100 tw-transition-all tw-duration-200"
                  >
                    <i class="fas fa-chevron-left tw-text-sm"></i>
                  </button>

                  <h3 class="tw-text-sm tw-font-bold tw-text-gray-900">
                    {{ currentQuotationCalendarDate | date : "MMMM yyyy" }}
                  </h3>

                  <button
                    type="button"
                    (click)="
                      currentQuotationCalendarDate.setMonth(
                        currentQuotationCalendarDate.getMonth() + 1
                      )
                    "
                    class="tw-p-2 tw-text-gray-600 hover:tw-text-gray-800 tw-rounded-lg hover:tw-bg-gray-100 tw-transition-all tw-duration-200"
                  >
                    <i class="fas fa-chevron-right tw-text-sm"></i>
                  </button>
                </div>

                <div class="tw-grid tw-grid-cols-7 tw-gap-1 tw-mb-3">
                  <div
                    *ngFor="let day of dayHeaders"
                    class="tw-text-center tw-text-xs tw-font-semibold tw-text-gray-500 tw-py-2"
                  >
                    {{ day }}
                  </div>

                  <button
                    *ngFor="let day of getQuotationCalendarDays()"
                    type="button"
                    (click)="selectQuotationDate(day.date)"
                    [disabled]="!day.isCurrentMonth"
                    [class]="getQuotationDateButtonClass(day)"
                    class="tw-w-9 tw-h-9 tw-text-sm tw-rounded-lg tw-flex tw-items-center tw-justify-center tw-transition-all tw-duration-200 hover:tw-bg-green-100"
                  >
                    {{ day.date.getDate() }}
                  </button>
                </div>

                <div
                  class="tw-flex tw-items-center tw-justify-between tw-pt-3 tw-border-t tw-border-gray-200"
                >
                  <button
                    type="button"
                    (click)="updateQuotationDate(null)"
                    class="tw-text-xs tw-text-red-600 hover:tw-text-red-800 tw-px-3 tw-py-2 tw-rounded-lg hover:tw-bg-red-50 tw-transition-all tw-duration-200 tw-font-semibold"
                  >
                    NO DATE
                  </button>

                  <button
                    type="button"
                    (click)="setQuotationDate()"
                    class="tw-text-xs tw-text-green-600 hover:tw-text-green-800 tw-px-3 tw-py-2 tw-rounded-lg hover:tw-bg-green-50 tw-transition-all tw-duration-200 tw-font-semibold"
                  >
                    TODAY
                  </button>
                </div>
              </div>
            </div>

            <!-- Member Dropdown -->
            <crm-team-member-dropdown
              #addMembersDropdown
              [leadId]="leadId"
              [allignment]="'right'"
              [isModernMemberSelect]="true"
              (onMemberAdded)="onMembersUpdated($event)"
            ></crm-team-member-dropdown>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tw-border-b tw-border-gray-200 tw-bg-white">
        <nav class="tw-flex tw-space-x-0">
          <button
            *ngFor="let tab of ['description', 'attachments']; let i = index"
            (click)="setTab(tab)"
            [class.tw-border-blue-500]="currentTab === tab"
            [class.tw-text-blue-600]="currentTab === tab"
            [class.tw-text-gray-500]="currentTab !== tab"
            class="tw-flex-1 tw-py-4 tw-px-5 tw-text-sm tw-font-semibold tw-border-b-2 tw-border-transparent hover:tw-text-gray-700 hover:tw-border-gray-300 tw-transition-all tw-duration-300 tw-capitalize"
          >
            {{ tab }}
            <span
              *ngIf="tab === 'attachments'"
              class="tw-ml-2 tw-bg-gray-100 tw-text-gray-600 tw-text-xs tw-px-2 tw-py-1 tw-rounded-full"
            >
              {{ lead.attachments.length || 0 }}
            </span>
          </button>
        </nav>
      </div>

      <!-- loader for tabs content with full height and width and centered -->
      <div
        *ngIf="isLoading"
        class="tw-flex tw-items-center tw-justify-center tw-h-full tw-w-full"
      >
        <div
          class="tw-w-10 tw-h-10 tw-border-4 tw-border-blue-500 tw-border-t-transparent tw-rounded-full tw-animate-spin"
        ></div>
      </div>

      <!-- Tab Content -->
      <div *ngIf="!isLoading && lead._id" class="tw-flex-1 tw-overflow-hidden">
        <!-- Description Tab -->
        <div
          *ngIf="currentTab === 'description'"
          class="tw-h-full tw-overflow-y-auto"
        >
          <div class="tw-p-5 md:tw-p-6">
            <!-- Contact Details Section -->
            <div class="tw-mb-8">
              <div
                *ngIf="!isEditingContactDetails"
                class="tw-group tw-cursor-pointer tw-p-5 tw--m-5 tw-rounded-xl hover:tw-bg-gray-50 tw-transition-all tw-duration-300"
                (click)="startEditingContactDetails()"
              >
                <div class="tw-flex tw-items-start tw-justify-between tw-mb-4">
                  <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">
                    Contact Details
                  </h3>
                  <i
                    class="fas fa-edit tw-text-blue-500 group-hover:tw-text-blue-700 tw-text-base tw-transition-all tw-duration-300"
                  ></i>
                </div>

                <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-5">
                  <div>
                    <label
                      class="tw-block tw-text-sm tw-font-semibold tw-text-gray-700 tw-mb-2"
                      >Name</label
                    >
                    <span class="tw-text-sm tw-text-gray-900">{{
                      lead.contactDetails.name || "Not specified"
                    }}</span>
                  </div>
                  <div>
                    <label
                      class="tw-block tw-text-sm tw-font-semibold tw-text-gray-700 tw-mb-2"
                      >Phone</label
                    >
                    <span class="tw-text-sm tw-text-gray-900">{{
                      lead.contactDetails.phone || "Not specified"
                    }}</span>
                  </div>
                  <div>
                    <label
                      class="tw-block tw-text-sm tw-font-semibold tw-text-gray-700 tw-mb-2"
                      >Email</label
                    >
                    <span class="tw-text-sm tw-text-gray-900">{{
                      lead.contactDetails.email || "Not specified"
                    }}</span>
                  </div>
                  <div>
                    <label
                      class="tw-block tw-text-sm tw-font-semibold tw-text-gray-700 tw-mb-2"
                      >Address</label
                    >
                    <span class="tw-text-sm tw-text-gray-900">{{
                      lead.contactDetails.address || "Not specified"
                    }}</span>
                  </div>
                </div>
              </div>

              <!-- Contact Details Edit Mode -->
              <div *ngIf="isEditingContactDetails" class="tw-space-y-5">
                <div class="tw-flex tw-items-center tw-justify-between">
                  <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">
                    Edit Contact Details
                  </h3>
                  <div class="tw-flex tw-items-center tw-space-x-3">
                    <button
                      type="button"
                      (click)="saveContactDetails()"
                      [disabled]="isSavingContactDetails"
                      class="tw-px-5 tw-py-2.5 tw-bg-blue-600 tw-text-white tw-text-sm tw-font-semibold tw-rounded-xl hover:tw-bg-blue-700 disabled:tw-bg-gray-300 disabled:tw-cursor-not-allowed tw-transition-all tw-duration-300 tw-flex tw-items-center tw-space-x-2 tw-shadow-md hover:tw-shadow-lg"
                    >
                      <i
                        *ngIf="isSavingContactDetails"
                        class="fas fa-spinner fa-spin"
                      ></i>
                      <span>{{
                        isSavingContactDetails ? "Saving..." : "Save"
                      }}</span>
                    </button>

                    <button
                      type="button"
                      (click)="cancelContactDetailsEdit()"
                      [disabled]="isSavingContactDetails"
                      class="tw-px-5 tw-py-2.5 tw-bg-gray-100 tw-text-gray-700 tw-text-sm tw-font-semibold tw-rounded-xl hover:tw-bg-gray-200 disabled:tw-opacity-50 tw-transition-all tw-duration-300 tw-shadow-sm"
                    >
                      Cancel
                    </button>
                  </div>
                </div>

                <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-5">
                  <div>
                    <label
                      class="tw-block tw-text-sm tw-font-semibold tw-text-gray-700 tw-mb-2"
                      >Name</label
                    >
                    <input
                      type="text"
                      [(ngModel)]="editContactDetails.name"
                      class="tw-mt-1 tw-block tw-w-full tw-rounded-xl tw-border-2 tw-border-gray-200 tw-shadow-sm focus:tw-border-blue-500 focus:tw-ring-blue-500 sm:tw-text-sm tw-px-4 tw-py-2.5 tw-transition-all tw-duration-300"
                      placeholder="Enter name"
                    />
                  </div>
                  <div>
                    <label
                      class="tw-block tw-text-sm tw-font-semibold tw-text-gray-700 tw-mb-2"
                      >Phone</label
                    >
                    <input
                      type="tel"
                      [(ngModel)]="editContactDetails.phone"
                      class="tw-mt-1 tw-block tw-w-full tw-rounded-xl tw-border-2 tw-border-gray-200 tw-shadow-sm focus:tw-border-blue-500 focus:tw-ring-blue-500 sm:tw-text-sm tw-px-4 tw-py-2.5 tw-transition-all tw-duration-300"
                      placeholder="Enter phone number"
                    />
                  </div>
                  <div>
                    <label
                      class="tw-block tw-text-sm tw-font-semibold tw-text-gray-700 tw-mb-2"
                      >Email</label
                    >
                    <input
                      type="email"
                      [(ngModel)]="editContactDetails.email"
                      class="tw-mt-1 tw-block tw-w-full tw-rounded-xl tw-border-2 tw-border-gray-200 tw-shadow-sm focus:tw-border-blue-500 focus:tw-ring-blue-500 sm:tw-text-sm tw-px-4 tw-py-2.5 tw-transition-all tw-duration-300"
                      placeholder="Enter email"
                    />
                  </div>
                  <div>
                    <label
                      class="tw-block tw-text-sm tw-font-semibold tw-text-gray-700 tw-mb-2"
                      >Address</label
                    >
                    <input
                      type="text"
                      [(ngModel)]="editContactDetails.address"
                      class="tw-mt-1 tw-block tw-w-full tw-rounded-xl tw-border-2 tw-border-gray-200 tw-shadow-sm focus:tw-border-blue-500 focus:tw-ring-blue-500 sm:tw-text-sm tw-px-4 tw-py-2.5 tw-transition-all tw-duration-300"
                      placeholder="Enter address"
                    />
                  </div>
                </div>
              </div>
            </div>

            <!-- Amount Section -->
            <div class="tw-mb-8">
              <div
                *ngIf="!isEditingAmount"
                class="tw-group tw-cursor-pointer tw-p-5 tw--m-5 tw-rounded-xl hover:tw-bg-gray-50 tw-transition-all tw-duration-300"
                (click)="startEditingAmount()"
              >
                <div class="tw-flex tw-items-start tw-justify-between tw-mb-4">
                  <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">
                    Amount
                  </h3>
                  <i
                    class="fas fa-edit tw-text-blue-500 group-hover:tw-text-blue-700 tw-text-base tw-transition-all tw-duration-300"
                  ></i>
                </div>

                <span class="tw-text-3xl tw-font-bold tw-text-gray-900">{{
                  lead.amount || "Not specified"
                }}</span>
              </div>

              <!-- Amount Edit Mode -->
              <div *ngIf="isEditingAmount" class="tw-space-y-5">
                <div class="tw-flex tw-items-center tw-justify-between">
                  <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">
                    Edit Amount
                  </h3>
                  <div class="tw-flex tw-items-center tw-space-x-3">
                    <button
                      type="button"
                      (click)="saveAmount()"
                      [disabled]="isSavingAmount"
                      class="tw-px-5 tw-py-2.5 tw-bg-blue-600 tw-text-white tw-text-sm tw-font-semibold tw-rounded-xl hover:tw-bg-blue-700 disabled:tw-bg-gray-300 disabled:tw-cursor-not-allowed tw-transition-all tw-duration-300 tw-flex tw-items-center tw-space-x-2 tw-shadow-md hover:tw-shadow-lg"
                    >
                      <i
                        *ngIf="isSavingAmount"
                        class="fas fa-spinner fa-spin"
                      ></i>
                      <span>{{ isSavingAmount ? "Saving..." : "Save" }}</span>
                    </button>

                    <button
                      type="button"
                      (click)="cancelAmountEdit()"
                      [disabled]="isSavingAmount"
                      class="tw-px-5 tw-py-2.5 tw-bg-gray-100 tw-text-gray-700 tw-text-sm tw-font-semibold tw-rounded-xl hover:tw-bg-gray-200 disabled:tw-opacity-50 tw-transition-all tw-duration-300 tw-shadow-sm"
                    >
                      Cancel
                    </button>
                  </div>
                </div>

                <input
                  type="text"
                  [(ngModel)]="editAmount"
                  class="tw-block tw-w-full tw-rounded-xl tw-border-2 tw-border-gray-200 tw-shadow-sm focus:tw-border-blue-500 focus:tw-ring-blue-500 sm:tw-text-3xl tw-font-bold tw-px-4 tw-py-3 tw-transition-all tw-duration-300"
                  placeholder="Enter amount"
                />
              </div>
            </div>

            <!-- Product Section -->
            <div class="tw-mb-8">
              <div
                *ngIf="!isEditingProduct"
                class="tw-group tw-cursor-pointer tw-p-5 tw--m-5 tw-rounded-xl hover:tw-bg-gray-50 tw-transition-all tw-duration-300"
                (click)="startEditingProduct()"
              >
                <div class="tw-flex tw-items-start tw-justify-between tw-mb-4">
                  <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">
                    Products
                  </h3>
                  <i
                    class="fas fa-edit tw-text-blue-500 group-hover:tw-text-blue-700 tw-text-base tw-transition-all tw-duration-300"
                  ></i>
                </div>

                <div
                  *ngIf="!lead.product || lead.product.length === 0"
                  class="tw-text-gray-500 tw-italic"
                >
                  No products added
                </div>
                <div
                  *ngIf="lead.product && lead.product.length > 0"
                  class="tw-space-y-3"
                >
                  <div
                    *ngFor="let item of lead.product; trackBy: trackByProductId"
                    class="tw-flex tw-items-center tw-space-x-4 tw-p-3 tw-bg-gray-50 tw-rounded-xl"
                  >
                    <span class="tw-font-semibold">{{ item.name }}</span>
                    <span class="tw-text-gray-600">{{ item.price }}</span>
                    <span class="tw-text-gray-600"
                      >Qty: {{ item.quantity }}</span
                    >
                  </div>
                </div>
              </div>

              <!-- Product Edit Mode -->
              <div *ngIf="isEditingProduct" class="tw-space-y-5">
                <div class="tw-flex tw-items-center tw-justify-between">
                  <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">
                    Edit Products
                  </h3>
                  <div class="tw-flex tw-items-center tw-space-x-3">
                    <button
                      type="button"
                      (click)="saveProduct()"
                      [disabled]="isSavingProduct"
                      class="tw-px-5 tw-py-2.5 tw-bg-blue-600 tw-text-white tw-text-sm tw-font-semibold tw-rounded-xl hover:tw-bg-blue-700 disabled:tw-bg-gray-300 disabled:tw-cursor-not-allowed tw-transition-all tw-duration-300 tw-flex tw-items-center tw-space-x-2 tw-shadow-md hover:tw-shadow-lg"
                    >
                      <i
                        *ngIf="isSavingProduct"
                        class="fas fa-spinner fa-spin"
                      ></i>
                      <span>{{ isSavingProduct ? "Saving..." : "Save" }}</span>
                    </button>

                    <button
                      type="button"
                      (click)="cancelProductEdit()"
                      [disabled]="isSavingProduct"
                      class="tw-px-5 tw-py-2.5 tw-bg-gray-100 tw-text-gray-700 tw-text-sm tw-font-semibold tw-rounded-xl hover:tw-bg-gray-200 disabled:tw-opacity-50 tw-transition-all tw-duration-300 tw-shadow-sm"
                    >
                      Cancel
                    </button>
                  </div>
                </div>

                <div class="tw-space-y-4">
                  <div
                    *ngFor="
                      let item of editProduct;
                      trackBy: trackByProductId;
                      let i = index
                    "
                    class="tw-flex tw-items-center tw-space-x-3 tw-p-4 tw-bg-gray-50 tw-rounded-xl"
                  >
                    <input
                      type="text"
                      [(ngModel)]="item.name"
                      placeholder="Product name"
                      class="tw-flex-1 tw-rounded-xl tw-border-2 tw-border-gray-200 tw-shadow-sm focus:tw-border-blue-500 focus:tw-ring-blue-500 sm:tw-text-sm tw-px-4 tw-py-2.5 tw-transition-all tw-duration-300"
                    />
                    <input
                      type="text"
                      [(ngModel)]="item.price"
                      placeholder="Price"
                      class="tw-w-28 tw-rounded-xl tw-border-2 tw-border-gray-200 tw-shadow-sm focus:tw-border-blue-500 focus:tw-ring-blue-500 sm:tw-text-sm tw-px-4 tw-py-2.5 tw-transition-all tw-duration-300"
                    />
                    <input
                      type="text"
                      [(ngModel)]="item.quantity"
                      placeholder="Qty"
                      class="tw-w-24 tw-rounded-xl tw-border-2 tw-border-gray-200 tw-shadow-sm focus:tw-border-blue-500 focus:tw-ring-blue-500 sm:tw-text-sm tw-px-4 tw-py-2.5 tw-transition-all tw-duration-300"
                    />
                    <button
                      type="button"
                      (click)="removeProductItem(i)"
                      class="tw-p-2 tw-text-red-600 hover:tw-text-red-800 hover:tw-bg-red-50 tw-rounded-lg tw-transition-all tw-duration-300"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                  <button
                    type="button"
                    (click)="addProductItem()"
                    class="tw-px-4 tw-py-2.5 tw-bg-green-100 tw-text-green-700 tw-rounded-xl hover:tw-bg-green-200 tw-transition-all tw-duration-300 tw-font-semibold tw-shadow-sm"
                  >
                    <i class="fas fa-plus tw-mr-2"></i>Add Product
                  </button>
                </div>
              </div>
            </div>

            <!-- Description Section -->
            <div class="tw-mb-8">
              <div
                *ngIf="!isEditingDescription"
                class="tw-group tw-cursor-pointer tw-p-5 tw--m-5 tw-rounded-xl hover:tw-bg-gray-50 tw-transition-all tw-duration-300 tw-min-h-[200px]"
                (click)="startEditingDescription()"
              >
                <div class="tw-flex tw-items-start tw-justify-between tw-mb-4">
                  <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">
                    Description
                  </h3>
                  <i
                    class="fas fa-edit tw-text-blue-500 group-hover:tw-text-blue-700 tw-text-base tw-transition-all tw-duration-300"
                  ></i>
                </div>

                <div
                  class="tw-text-gray-700 tw-leading-relaxed"
                  [innerHTML]="
                    lead.description
                      ? lead.description
                      : '<p class=&quot;tw-text-gray-500 tw-italic&quot;>Click to add a description...</p>'
                  "
                ></div>
              </div>

              <!-- Description Edit Mode -->
              <div *ngIf="isEditingDescription" class="tw-space-y-5">
                <div class="tw-flex tw-items-center tw-justify-between">
                  <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">
                    Edit Description
                  </h3>
                  <div class="tw-flex tw-items-center tw-space-x-3">
                    <button
                      type="button"
                      (click)="saveDescription()"
                      [disabled]="isSavingDescription"
                      class="tw-px-5 tw-py-2.5 tw-bg-blue-600 tw-text-white tw-text-sm tw-font-semibold tw-rounded-xl hover:tw-bg-blue-700 disabled:tw-bg-gray-300 disabled:tw-cursor-not-allowed tw-transition-all tw-duration-300 tw-flex tw-items-center tw-space-x-2 tw-shadow-md hover:tw-shadow-lg"
                    >
                      <i
                        *ngIf="isSavingDescription"
                        class="fas fa-spinner fa-spin"
                      ></i>
                      <span>{{
                        isSavingDescription ? "Saving..." : "Save"
                      }}</span>
                    </button>

                    <button
                      type="button"
                      (click)="cancelDescriptionEdit()"
                      [disabled]="isSavingDescription"
                      class="tw-px-5 tw-py-2.5 tw-bg-gray-100 tw-text-gray-700 tw-text-sm tw-font-semibold tw-rounded-xl hover:tw-bg-gray-200 disabled:tw-opacity-50 tw-transition-all tw-duration-300 tw-shadow-sm"
                    >
                      Cancel
                    </button>
                  </div>
                </div>

                <div
                  class="tw-border-2 tw-border-gray-200 tw-rounded-xl tw-overflow-hidden tw-shadow-sm"
                >
                  <ngx-editor-menu
                    [editor]="editor!"
                    [toolbar]="toolbar"
                  ></ngx-editor-menu>
                  <ngx-editor
                    [editor]="editor!"
                    [(ngModel)]="lead.description"
                    [placeholder]="'Add lead description...'"
                    class="tw-min-h-[300px]"
                  >
                  </ngx-editor>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Attachments Tab -->
        <div
          *ngIf="currentTab === 'attachments'"
          class="tw-h-full tw-flex tw-flex-col"
        >
          <div class="tw-p-5 md:tw-p-6 tw-h-full tw-flex tw-flex-col">
            <!-- Attachments List -->
            <div class="tw-space-y-4 tw-mb-6 tw-flex-1 tw-overflow-y-auto">
              <!-- No Attachments State -->
              <div
                *ngIf="!lead.attachments || lead.attachments.length === 0"
                class="tw-text-center tw-py-12"
              >
                <div
                  class="tw-w-16 tw-h-16 tw-bg-gray-100 tw-rounded-full tw-flex tw-items-center tw-justify-center tw-mx-auto tw-mb-4"
                >
                  <i class="fas fa-paperclip tw-text-gray-400 tw-text-xl"></i>
                </div>
                <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900 tw-mb-2">
                  No attachments yet
                </h3>
                <p class="tw-text-gray-500">
                  Upload files to keep them organized with this lead.
                </p>
              </div>

              <!-- Attachment Items -->
              <div
                *ngFor="
                  let attachment of lead.attachments;
                  trackBy: trackByAttachmentId
                "
                class="tw-space-y-4"
              >
                <div
                  *ngFor="let file of attachment.files"
                  class="tw-group tw-bg-white tw-border-2 tw-border-gray-200 tw-rounded-xl tw-p-4 hover:tw-shadow-md tw-transition-all tw-duration-300"
                >
                  <div class="tw-flex tw-items-center tw-justify-between">
                    <div
                      class="tw-flex tw-items-center tw-space-x-4 tw-flex-1 tw-min-w-0"
                    >
                      <!-- File Icon -->
                      <div
                        class="tw-w-12 tw-h-12 tw-bg-blue-50 tw-rounded-xl tw-flex tw-items-center tw-justify-center tw-flex-shrink-0"
                      >
                        <i
                          [class]="
                            'fas ' +
                            getFileIcon(file.fileType) +
                            ' tw-text-blue-600 tw-text-lg'
                          "
                        ></i>
                      </div>

                      <!-- File Info -->
                      <div class="tw-flex-1 tw-min-w-0">
                        <h4
                          class="tw-text-sm tw-font-semibold tw-text-gray-900 tw-truncate"
                        >
                          {{ file.fileName }}
                        </h4>
                        <div
                          class="tw-flex tw-items-center tw-space-x-2 tw-text-xs tw-text-gray-500 tw-mt-1"
                        >
                          <span>{{ attachment.uploadedBy.name }}</span>
                          <span>•</span>
                          <span>{{ formatDate(attachment.createdAt) }}</span>
                          <span
                            *ngIf="file.uploadedFrom === 'url'"
                            class="tw-bg-green-100 tw-text-green-800 tw-px-2 tw-py-1 tw-rounded-full"
                          >
                            Link
                          </span>
                        </div>
                      </div>
                    </div>

                    <!-- Actions -->
                    <div
                      class="tw-flex tw-items-center tw-space-x-2 tw-opacity-0 group-hover:tw-opacity-100 tw-transition-opacity tw-duration-300"
                    >
                      <a
                        [href]="imageBaseUrl + file.fileUrl"
                        target="_blank"
                        class="tw-p-2 tw-text-gray-400 hover:tw-text-blue-600 hover:tw-bg-blue-50 tw-rounded-lg tw-transition-all tw-duration-300"
                      >
                        <i class="fas fa-external-link-alt tw-text-sm"></i>
                      </a>

                      <button
                        type="button"
                        (click)="deleteAttachment(file._id, attachment._id)"
                        class="tw-p-2 tw-text-gray-400 hover:tw-text-red-600 hover:tw-bg-red-50 tw-rounded-lg tw-transition-all tw-duration-300"
                      >
                        <i class="fas fa-trash tw-text-sm"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Upload Options -->
            <div class="tw-border-t tw-border-gray-200 tw-pt-6">
              <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-1 tw-gap-4">
                <!-- File Upload -->
                <div class="tw-relative">
                  <input
                    type="file"
                    [disabled]="isUploading"
                    #fileInput
                    (change)="onFileUpload($event)"
                    multiple
                    class="tw-absolute tw-inset-0 tw-w-full tw-h-full tw-opacity-0 tw-cursor-pointer"
                  />

                  <div
                    class="tw-border-2 tw-border-dashed tw-border-gray-300 tw-rounded-xl tw-px-6 tw-py-5 tw-flex tw-gap-3 tw-justify-center hover:tw-border-blue-400 hover:tw-bg-blue-50 tw-transition-all tw-duration-300 tw-cursor-pointer"
                    [ngClass]="{
                      'tw-opacity-50 tw-cursor-not-allowed': isUploading,
                      'tw-cursor-pointer': !isUploading
                    }"
                  >
                    <i
                      *ngIf="!isUploading"
                      class="fas fa-cloud-upload-alt tw-text-blue-600 tw-text-2xl"
                    ></i>
                    <i
                      *ngIf="isUploading"
                      class="fas fa-spinner fa-spin tw-text-blue-600 tw-text-2xl"
                    ></i>
                    <span class="tw-text-sm tw-font-semibold tw-text-gray-900">
                      {{ isUploading ? "Uploading..." : "Upload Files" }}
                    </span>
                  </div>

                  <!-- File size restriction message -->
                  <div
                    class="tw-text-xs tw-text-gray-500 tw-mt-2 tw-text-center"
                  >
                    Maximum file size: 10MB
                  </div>

                  <!-- Upload progress indicator -->
                  <div
                    *ngIf="isUploading"
                    class="tw-mt-3 tw-w-full tw-bg-gray-200 tw-rounded-full tw-h-2"
                  >
                    <div
                      class="tw-bg-blue-600 tw-h-2 tw-rounded-full tw-animate-pulse"
                      style="width: 100%"
                    ></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>