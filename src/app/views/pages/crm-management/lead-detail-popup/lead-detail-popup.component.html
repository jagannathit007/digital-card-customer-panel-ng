<!-- Desktop Modal -->
<div
  class="tw-fixed tw-inset-0 tw-bg-black tw-bg-opacity-50 tw-flex tw-items-center tw-justify-center tw-z-50 tw-p-4 md:tw-p-6"
  (click)="closePopup()"
>
  <!-- Modal Container - Fixed size on desktop, full screen on mobile -->
  <div
    class="tw-bg-white tw-rounded-none md:tw-rounded-2xl tw-shadow-2xl tw-w-full tw-h-full md:tw-w-[900px] md:tw-h-[700px] tw-flex tw-flex-col tw-overflow-hidden tw-animate-scale-in"
    (click)="$event.stopPropagation()"
  >
    <!-- Header -->
    <div
      class="tw-flex tw-items-center tw-justify-between tw-p-4 md:tw-p-6 tw-border-b tw-border-gray-200 tw-bg-gray-50"
    >
      <div class="tw-flex tw-items-center tw-space-x-3">
        <div
          class="tw-w-8 tw-h-8 tw-bg-blue-500 tw-rounded-lg tw-flex tw-items-center tw-justify-center"
        >
          <i class="fas fa-user-tie tw-text-white tw-text-sm"></i>
        </div>
        <span class="tw-text-lg tw-font-semibold tw-text-gray-900"
          >Lead Details</span
        >
      </div>

      <button
        type="button"
        class="tw-p-2 tw-text-gray-400 hover:tw-text-gray-600 hover:tw-bg-gray-200 tw-rounded-lg tw-transition-all tw-duration-200"
        (click)="closePopup()"
      >
        <i class="fas fa-times tw-text-lg"></i>
      </button>
    </div>

    <!-- Content Area -->
    <div class="tw-flex-1 tw-flex tw-flex-col tw-overflow-hidden">
      <!-- Lead Title Section -->
      <div
        class="tw-px-4 tw-py-2 md:tw-p-6 md:tw-py-4 tw-border-b tw-border-gray-100"
      >
        <div *ngIf="isLoading" class="tw-p-2">
          <!-- shimmer effect -->
          <div
            class="tw-w-full tw-h-8 tw-bg-gradient-to-r tw-from-gray-200 tw-to-gray-300 tw-rounded-lg tw-animate-pulse tw-mb-2"
          ></div>
        </div>
        
        <!-- Editable Title -->
        <div class="tw-mb-2 tw-relative" *ngIf="!isLoading">
          <div
            *ngIf="!isEditingTitle"
            class="tw-group tw-cursor-pointer tw-py-[9px] tw-px-[13px] tw-rounded-lg hover:tw-bg-gray-50 tw-transition-colors tw-duration-200"
            (click)="startEditingTitle()"
          >
            <div class="tw-flex tw-items-center tw-justify-between">
              <h2
                class="tw-text-xl md:tw-text-2xl tw-font-bold tw-text-gray-900 tw-flex-1 tw-pr-2"
              >
                {{ lead.title || "Untitled Lead" }}
              </h2>
              <i
                class="fas fa-edit tw-text-gray-400 group-hover:tw-text-gray-600 tw-text-sm tw-opacity-0 tw-transition-all tw-duration-200 group-hover:tw-opacity-100"
              ></i>
            </div>
          </div>

          <!-- Title Edit Mode -->
          <div *ngIf="isEditingTitle" class="">
            <input
              id="editTitleInput"
              type="text"
              [(ngModel)]="editTitle"
              (keydown)="onTitleKeydown($event)"
              class="tw-w-full tw-text-xl md:tw-text-2xl tw-font-bold tw-text-gray-900 tw-bg-white tw-border tw-border-gray-300 tw-rounded-lg tw-outline-none tw-px-3 tw-py-2 focus:tw-border-blue-500 tw-transition-all tw-duration-200"
              placeholder="Enter lead title..."
              autofocus
            />

            <div
              class="tw-flex tw-justify-end tw-items-center tw-space-x-2 tw-absolute tw-left-0 tw-right-0 tw-top-full tw-z-10 tw-bg-white tw-py-3 tw-px-4 tw-border-t tw-border-gray-200 tw-rounded-b-lg"
            >
              <button
                type="button"
                (click)="saveTitle()"
                [disabled]="!editTitle.trim() || isSavingTitle"
                class="tw-px-4 tw-py-2 tw-bg-blue-600 tw-text-white tw-text-sm tw-font-medium tw-rounded-lg hover:tw-bg-blue-700 disabled:tw-bg-gray-300 disabled:tw-cursor-not-allowed tw-transition-colors tw-duration-200 tw-flex tw-items-center tw-space-x-2"
              >
                <i *ngIf="isSavingTitle" class="fas fa-spinner fa-spin"></i>
                <span>{{ isSavingTitle ? "Saving..." : "Save" }}</span>
              </button>
              <button
                type="button"
                (click)="cancelTitleEdit()"
                [disabled]="isSavingTitle"
                class="tw-px-4 tw-py-2 tw-bg-gray-100 tw-text-gray-700 tw-text-sm tw-font-medium tw-rounded-lg hover:tw-bg-gray-200 disabled:tw-opacity-50 tw-transition-colors tw-duration-200"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>

        <!-- shimmer effect for this section -->
        <div *ngIf="isLoading" class="tw-flex tw-justify-between">
          <div class="tw-flex tw-gap-4">
            <div
              class="tw-w-full tw-h-[39px] tw-bg-gradient-to-r tw-from-gray-200 tw-to-gray-300 tw-rounded-lg tw-animate-pulse tw-min-w-[140px] tw-max-w-[140px]"
            ></div>
            <div
              class="tw-w-full tw-h-[39px] tw-bg-gradient-to-r tw-from-gray-200 tw-to-gray-300 tw-rounded-lg tw-animate-pulse tw-min-w-[130px] tw-max-w-[130px]"
            ></div>
          </div>
          <div
            class="tw-w-full tw-h-[39px] tw-bg-gradient-to-r tw-from-gray-200 tw-to-gray-300 tw-rounded-lg tw-animate-pulse tw-min-w-[180px] tw-max-w-[180px]"
          ></div>
        </div>

        <!-- Status, Priority, Category, and Assignment Row -->
        <div
          *ngIf="!isLoading"
          class="tw-flex tw-flex-col md:tw-flex-row tw-items-start md:tw-items-center tw-justify-between tw-space-y-3 md:tw-space-y-0 md:tw-space-x-4"
        >
          <!-- Left Side: Priority, Category, and Closing Date -->
          <div
            class="tw-flex tw-flex-col sm:tw-flex-row tw-items-start sm:tw-items-center tw-space-y-3 sm:tw-space-y-0 sm:tw-space-x-4"
          >
            <!-- Priority Select -->
            <div class="tw-relative">
              <select
                [(ngModel)]="lead.priority"
                (change)="updatePriority(lead.priority)"
                class="tw-appearance-none tw-bg-white tw-border tw-border-gray-300 tw-rounded-lg tw-px-3 tw-py-2 tw-text-sm tw-font-medium tw-text-gray-700 focus:tw-ring-2 focus:tw-ring-blue-500 focus:tw-border-blue-500 tw-transition-all tw-duration-200 tw-cursor-pointer tw-pr-8 hover:tw-border-gray-400"
              >
                <option
                  *ngFor="let option of priorityOptions"
                  [value]="option.value"
                >
                  {{ option.label }}
                </option>
              </select>
              <i
                class="fas fa-chevron-down tw-absolute tw-right-2 tw-top-1/2 tw-transform tw--translate-y-1/2 tw-text-gray-400 tw-text-xs tw-pointer-events-none"
              ></i>
            </div>

            <!-- Category Select -->
            <div class="tw-relative">
              <select
                [(ngModel)]="lead.category"
                (change)="updateCategory(lead.category || '')"
                class="tw-appearance-none tw-bg-white tw-border tw-border-gray-300 tw-rounded-lg tw-px-3 tw-py-2 tw-text-sm tw-font-medium tw-text-gray-700 focus:tw-ring-2 focus:tw-ring-blue-500 focus:tw-border-blue-500 tw-transition-all tw-duration-200 tw-cursor-pointer tw-pr-8 hover:tw-border-gray-400"
              >
                <option value="">No Category</option>
                <option
                  *ngFor="let category of availableCategories"
                  [value]="category._id"
                >
                  {{ category.name }}
                </option>
              </select>
              <i
                class="fas fa-chevron-down tw-absolute tw-right-2 tw-top-1/2 tw-transform tw--translate-y-1/2 tw-text-gray-400 tw-text-xs tw-pointer-events-none"
              ></i>
            </div>

            <!-- Closing Date -->
            <div class="tw-relative">
              <ng-container *ngIf="lead.closingDate; else noClosingDateTemplate">
                <div
                  class="tw-bg-blue-50 tw-text-blue-700 tw-px-3 tw-py-2 tw-rounded-lg tw-text-sm tw-font-medium tw-inline-flex tw-items-center tw-space-x-2 tw-cursor-pointer tw-border tw-border-blue-200 hover:tw-bg-blue-100 hover:tw-text-blue-800 tw-transition-colors tw-duration-200"
                  (click)="toggleDatePicker()"
                >
                  <i class="fas fa-calendar-check tw-text-xs"></i>
                  <span>Closing: {{ formatDate(lead.closingDate) }}</span>
                </div>
              </ng-container>

              <ng-template #noClosingDateTemplate>
                <div
                  class="tw-bg-gray-50 tw-text-gray-700 tw-px-3 tw-py-2 tw-rounded-lg tw-text-sm tw-font-medium tw-inline-flex tw-items-center tw-space-x-2 tw-cursor-pointer tw-border tw-border-gray-200 hover:tw-bg-gray-100 tw-transition-colors tw-duration-200"
                  (click)="toggleDatePicker()"
                >
                  <i class="fas fa-calendar-plus tw-text-xs"></i>
                  <span>Set closing date</span>
                </div>
              </ng-template>

              <!-- Date Picker Popup -->
              <div
                *ngIf="showCustomDatePicker"
                class="tw-absolute tw-top-full tw-left-0 tw-mt-2 tw-bg-white tw-border tw-border-gray-200 tw-rounded-lg tw-shadow-lg tw-p-4 tw-w-80 tw-z-50"
                (click)="$event.stopPropagation()"
              >
                <div class="tw-flex tw-items-center tw-justify-between tw-mb-4">
                  <button
                    type="button"
                    (click)="currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1)"
                    class="tw-p-1 tw-text-gray-600 hover:tw-text-gray-800 tw-rounded"
                  >
                    <i class="fas fa-chevron-left tw-text-sm"></i>
                  </button>

                  <h3 class="tw-text-sm tw-font-semibold tw-text-gray-900">
                    {{ currentCalendarDate | date : "MMMM yyyy" }}
                  </h3>

                  <button
                    type="button"
                    (click)="currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1)"
                    class="tw-p-1 tw-text-gray-600 hover:tw-text-gray-800 tw-rounded"
                  >
                    <i class="fas fa-chevron-right tw-text-sm"></i>
                  </button>
                </div>

                <div class="tw-grid tw-grid-cols-7 tw-gap-1 tw-mb-3">
                  <div
                    *ngFor="let day of dayHeaders"
                    class="tw-text-center tw-text-xs tw-font-medium tw-text-gray-500 tw-py-1"
                  >
                    {{ day }}
                  </div>
                  
                  <button
                    *ngFor="let day of getCalendarDays()"
                    type="button"
                    (click)="selectDate(day.date)"
                    [disabled]="!day.isCurrentMonth"
                    [class]="getDateButtonClass(day)"
                    class="tw-w-8 tw-h-8 tw-text-sm tw-rounded tw-flex tw-items-center tw-justify-center tw-transition-colors tw-duration-150"
                  >
                    {{ day.date.getDate() }}
                  </button>
                </div>

                <div class="tw-flex tw-items-center tw-justify-between tw-pt-3 tw-border-t tw-border-gray-200">
                  <button
                    type="button"
                    (click)="updateClosingDate(null)"
                    class="tw-text-xs tw-text-red-600 hover:tw-text-red-800 tw-px-2 tw-py-1 tw-rounded hover:tw-bg-red-50 tw-transition-colors tw-duration-150"
                  >
                    NO DATE
                  </button>

                  <button
                    type="button"
                    (click)="setClosingDate()"
                    class="tw-text-xs tw-text-blue-600 hover:tw-text-blue-800 tw-px-2 tw-py-1 tw-rounded hover:tw-bg-blue-50 tw-transition-colors tw-duration-150"
                  >
                    TODAY
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Side: Assignment -->
          <div class="tw-flex tw-items-center tw-space-x-2">
            <span class="tw-text-sm tw-font-medium tw-text-gray-700">Assigned to:</span>
            <div class="tw-flex tw-items-center tw-space-x-1">
              <div
                *ngFor="let member of lead.assignedTo.slice(0, 2); trackBy: trackByMemberId"
                class="tw-w-8 tw-h-8 tw-rounded-full tw-bg-gray-200 tw-flex tw-items-center tw-justify-center tw-text-sm tw-font-medium tw-text-gray-700"
                [title]="member.name"
              >
                <img
                  *ngIf="member.profileImage"
                  [src]="imageBaseUrl + member.profileImage"
                  [alt]="member.name"
                  class="tw-w-8 tw-h-8 tw-rounded-full tw-object-cover"
                />
                <span *ngIf="!member.profileImage">{{ member.name.charAt(0).toUpperCase() }}</span>
              </div>

              <span
                *ngIf="lead.assignedTo.length > 2"
                class="tw-text-xs tw-text-gray-500 tw-ml-1 tw-p-2 tw-bg-gray-100 tw-rounded-full"
              >
                +{{ lead.assignedTo.length - 2 }}
              </span>
              <!-- <button
                type="button"
                class="tw-w-8 tw-h-8 tw-rounded-full tw-bg-blue-100 tw-text-blue-600 tw-flex tw-items-center tw-justify-center hover:tw-bg-blue-200 tw-transition-colors tw-duration-200"
                (click)="addMembersDropdown?.toggleDropdown()"
                title="Add/Remove members"
              >
                <i class="fas fa-plus tw-text-xs"></i>
              </button> -->

            </div>
            
            <!-- Member Dropdown -->
            <crm-team-member-dropdown
              #addMembersDropdown
              [leadId]="leadId"
              [allignment]="'right'"
              [isModernMemberSelect]="true"
              (onMemberAdded)="onMembersUpdated($event)"
            ></crm-team-member-dropdown>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tw-border-b tw-border-gray-200 tw-bg-white">
        <nav class="tw-flex tw-space-x-0">
          <button
            *ngFor="
              let tab of ['description', 'attachments'];
              let i = index
            "
            (click)="setTab(tab)"
            [class.tw-border-blue-500]="currentTab === tab"
            [class.tw-text-blue-600]="currentTab === tab"
            [class.tw-text-gray-500]="currentTab !== tab"
            class="tw-flex-1 tw-py-3 tw-px-4 tw-text-sm tw-font-medium tw-border-b-2 tw-border-transparent hover:tw-text-gray-700 hover:tw-border-gray-300 tw-transition-all tw-duration-200 tw-capitalize"
          >
            {{ tab }}
            <span
              *ngIf="tab === 'attachments'"
              class="tw-ml-2 tw-bg-gray-100 tw-text-gray-600 tw-text-xs tw-px-2 tw-py-0.5 tw-rounded-full"
            >
              {{ lead.attachments.length || 0 }}
            </span>
          </button>
        </nav>
      </div>

      <!-- loader for tabs content with full height and width and centered -->
      <div
        *ngIf="isLoading"
        class="tw-flex tw-items-center tw-justify-center tw-h-full tw-w-full"
      >
        <div
          class="tw-w-8 tw-h-8 tw-border-4 tw-border-blue-500 tw-border-t-transparent tw-rounded-full tw-animate-spin"
        ></div>
      </div>

      <!-- Tab Content -->
      <div *ngIf="!isLoading && lead._id" class="tw-flex-1 tw-overflow-hidden">
        <!-- Description Tab -->
        <div
          *ngIf="currentTab === 'description'"
          class="tw-h-full tw-overflow-y-auto"
        >
          <div class="tw-p-4 md:tw-p-6">
            <!-- Description Section -->
            <div class="tw-mb-6">
              <div
                *ngIf="!isEditingDescription"
                class="tw-group tw-cursor-pointer tw-p-4 tw--m-4 tw-rounded-lg hover:tw-bg-gray-50 tw-transition-colors tw-duration-200 tw-min-h-[200px]"
                (click)="startEditingDescription()"
              >
                <div class="tw-flex tw-items-start tw-justify-between tw-mb-3">
                  <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">
                    Description
                  </h3>
                  <i
                    class="fas fa-edit tw-text-gray-400 group-hover:tw-text-gray-600 tw-text-sm tw-opacity-0 tw-transition-all tw-duration-200 group-hover:tw-opacity-100"
                  ></i>
                </div>

                <div
                  class="tw-text-gray-700 tw-leading-relaxed"
                  [innerHTML]="
                    lead.description
                      ? lead.description
                      : '<p class=&quot;tw-text-gray-500 tw-italic&quot;>Click to add a description...</p>'
                  "
                ></div>
              </div>

              <!-- Description Edit Mode -->
              <div *ngIf="isEditingDescription" class="tw-space-y-4">
                <div class="tw-flex tw-items-center tw-justify-between">
                  <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">
                    Edit Description
                  </h3>
                  <div class="tw-flex tw-items-center tw-space-x-2">
                    <button
                      type="button"
                      (click)="saveDescription()"
                      [disabled]="isSavingDescription"
                      class="tw-px-4 tw-py-2 tw-bg-blue-600 tw-text-white tw-text-sm tw-font-medium tw-rounded-lg hover:tw-bg-blue-700 disabled:tw-bg-gray-300 disabled:tw-cursor-not-allowed tw-transition-colors tw-duration-200 tw-flex tw-items-center tw-space-x-2"
                    >
                      <i
                        *ngIf="isSavingDescription"
                        class="fas fa-spinner fa-spin"
                      ></i>
                      <span>{{
                        isSavingDescription ? "Saving..." : "Save"
                      }}</span>
                    </button>

                    <button
                      type="button"
                      (click)="cancelDescriptionEdit()"
                      [disabled]="isSavingDescription"
                      class="tw-px-4 tw-py-2 tw-bg-gray-100 tw-text-gray-700 tw-text-sm tw-font-medium tw-rounded-lg hover:tw-bg-gray-200 disabled:tw-opacity-50 tw-transition-colors tw-duration-200"
                    >
                      Cancel
                    </button>
                  </div>
                </div>

                <div
                  class="tw-border tw-border-gray-300 tw-rounded-lg tw-overflow-hidden"
                >
                  <ngx-editor-menu
                    [editor]="editor!"
                    [toolbar]="toolbar"
                  ></ngx-editor-menu>
                  <ngx-editor
                    [editor]="editor!"
                    [(ngModel)]="lead.description"
                    [placeholder]="'Add lead description...'"
                    class="tw-min-h-[300px]"
                  >
                  </ngx-editor>
                </div>
              </div>
            </div>

            <!-- Contact Details Section -->
            <div class="tw-mb-6">
              <div
                *ngIf="!isEditingContactDetails"
                class="tw-group tw-cursor-pointer tw-p-4 tw--m-4 tw-rounded-lg hover:tw-bg-gray-50 tw-transition-colors tw-duration-200"
                (click)="startEditingContactDetails()"
              >
                <div class="tw-flex tw-items-start tw-justify-between tw-mb-3">
                  <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">
                    Contact Details
                  </h3>
                  <i
                    class="fas fa-edit tw-text-gray-400 group-hover:tw-text-gray-600 tw-text-sm tw-opacity-0 tw-transition-all tw-duration-200 group-hover:tw-opacity-100"
                  ></i>
                </div>

                <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-4">
                  <div>
                    <label class="tw-block tw-text-sm tw-font-medium tw-text-gray-700">Name</label>
                    <span class="tw-text-sm tw-text-gray-900">{{ lead.contactDetails.name || 'Not specified' }}</span>
                  </div>
                  <div>
                    <label class="tw-block tw-text-sm tw-font-medium tw-text-gray-700">Phone</label>
                    <span class="tw-text-sm tw-text-gray-900">{{ lead.contactDetails.phone || 'Not specified' }}</span>
                  </div>
                  <div>
                    <label class="tw-block tw-text-sm tw-font-medium tw-text-gray-700">Email</label>
                    <span class="tw-text-sm tw-text-gray-900">{{ lead.contactDetails.email || 'Not specified' }}</span>
                  </div>
                  <div>
                    <label class="tw-block tw-text-sm tw-font-medium tw-text-gray-700">Address</label>
                    <span class="tw-text-sm tw-text-gray-900">{{ lead.contactDetails.address || 'Not specified' }}</span>
                  </div>
                </div>
              </div>

              <!-- Contact Details Edit Mode -->
              <div *ngIf="isEditingContactDetails" class="tw-space-y-4">
                <div class="tw-flex tw-items-center tw-justify-between">
                  <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">
                    Edit Contact Details
                  </h3>
                  <div class="tw-flex tw-items-center tw-space-x-2">
                    <button
                      type="button"
                      (click)="saveContactDetails()"
                      [disabled]="isSavingContactDetails"
                      class="tw-px-4 tw-py-2 tw-bg-blue-600 tw-text-white tw-text-sm tw-font-medium tw-rounded-lg hover:tw-bg-blue-700 disabled:tw-bg-gray-300 disabled:tw-cursor-not-allowed tw-transition-colors tw-duration-200 tw-flex tw-items-center tw-space-x-2"
                    >
                      <i
                        *ngIf="isSavingContactDetails"
                        class="fas fa-spinner fa-spin"
                      ></i>
                      <span>{{
                        isSavingContactDetails ? "Saving..." : "Save"
                      }}</span>
                    </button>

                    <button
                      type="button"
                      (click)="cancelContactDetailsEdit()"
                      [disabled]="isSavingContactDetails"
                      class="tw-px-4 tw-py-2 tw-bg-gray-100 tw-text-gray-700 tw-text-sm tw-font-medium tw-rounded-lg hover:tw-bg-gray-200 disabled:tw-opacity-50 tw-transition-colors tw-duration-200"
                    >
                      Cancel
                    </button>
                  </div>
                </div>

                <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-4">
                  <div>
                    <label class="tw-block tw-text-sm tw-font-medium tw-text-gray-700">Name</label>
                    <input
                      type="text"
                      [(ngModel)]="editContactDetails.name"
                      class="tw-mt-1 tw-block tw-w-full tw-rounded-md tw-border-gray-300 tw-shadow-sm focus:tw-border-blue-500 focus:tw-ring-blue-500 sm:tw-text-sm"
                      placeholder="Enter name"
                    />
                  </div>
                  <div>
                    <label class="tw-block tw-text-sm tw-font-medium tw-text-gray-700">Phone</label>
                    <input
                      type="tel"
                      [(ngModel)]="editContactDetails.phone"
                      class="tw-mt-1 tw-block tw-w-full tw-rounded-md tw-border-gray-300 tw-shadow-sm focus:tw-border-blue-500 focus:tw-ring-blue-500 sm:tw-text-sm"
                      placeholder="Enter phone number"
                    />
                  </div>
                  <div>
                    <label class="tw-block tw-text-sm tw-font-medium tw-text-gray-700">Email</label>
                    <input
                      type="email"
                      [(ngModel)]="editContactDetails.email"
                      class="tw-mt-1 tw-block tw-w-full tw-rounded-md tw-border-gray-300 tw-shadow-sm focus:tw-border-blue-500 focus:tw-ring-blue-500 sm:tw-text-sm"
                      placeholder="Enter email"
                    />
                  </div>
                  <div>
                    <label class="tw-block tw-text-sm tw-font-medium tw-text-gray-700">Address</label>
                    <input
                      type="text"
                      [(ngModel)]="editContactDetails.address"
                      class="tw-mt-1 tw-block tw-w-full tw-rounded-md tw-border-gray-300 tw-shadow-sm focus:tw-border-blue-500 focus:tw-ring-blue-500 sm:tw-text-sm"
                      placeholder="Enter address"
                    />
                  </div>
                </div>
              </div>
            </div>

            <!-- Amount Section -->
            <div class="tw-mb-6">
              <div
                *ngIf="!isEditingAmount"
                class="tw-group tw-cursor-pointer tw-p-4 tw--m-4 tw-rounded-lg hover:tw-bg-gray-50 tw-transition-colors tw-duration-200"
                (click)="startEditingAmount()"
              >
                <div class="tw-flex tw-items-start tw-justify-between tw-mb-3">
                  <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">
                    Amount
                  </h3>
                  <i
                    class="fas fa-edit tw-text-gray-400 group-hover:tw-text-gray-600 tw-text-sm tw-opacity-0 tw-transition-all tw-duration-200 group-hover:tw-opacity-100"
                  ></i>
                </div>

                <span class="tw-text-2xl tw-font-bold tw-text-gray-900">{{ lead.amount || 'Not specified' }}</span>
              </div>

              <!-- Amount Edit Mode -->
              <div *ngIf="isEditingAmount" class="tw-space-y-4">
                <div class="tw-flex tw-items-center tw-justify-between">
                  <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">
                    Edit Amount
                  </h3>
                  <div class="tw-flex tw-items-center tw-space-x-2">
                    <button
                      type="button"
                      (click)="saveAmount()"
                      [disabled]="isSavingAmount"
                      class="tw-px-4 tw-py-2 tw-bg-blue-600 tw-text-white tw-text-sm tw-font-medium tw-rounded-lg hover:tw-bg-blue-700 disabled:tw-bg-gray-300 disabled:tw-cursor-not-allowed tw-transition-colors tw-duration-200 tw-flex tw-items-center tw-space-x-2"
                    >
                      <i
                        *ngIf="isSavingAmount"
                        class="fas fa-spinner fa-spin"
                      ></i>
                      <span>{{
                        isSavingAmount ? "Saving..." : "Save"
                      }}</span>
                    </button>

                    <button
                      type="button"
                      (click)="cancelAmountEdit()"
                      [disabled]="isSavingAmount"
                      class="tw-px-4 tw-py-2 tw-bg-gray-100 tw-text-gray-700 tw-text-sm tw-font-medium tw-rounded-lg hover:tw-bg-gray-200 disabled:tw-opacity-50 tw-transition-colors tw-duration-200"
                    >
                      Cancel
                    </button>
                  </div>
                </div>

                <input
                  type="text"
                  [(ngModel)]="editAmount"
                  class="tw-block tw-w-full tw-rounded-md tw-border-gray-300 tw-shadow-sm focus:tw-border-blue-500 focus:tw-ring-blue-500 sm:tw-text-2xl tw-font-bold"
                  placeholder="Enter amount"
                />
              </div>
            </div>

            <!-- Product Section -->
            <div class="tw-mb-6">
              <div
                *ngIf="!isEditingProduct"
                class="tw-group tw-cursor-pointer tw-p-4 tw--m-4 tw-rounded-lg hover:tw-bg-gray-50 tw-transition-colors tw-duration-200"
                (click)="startEditingProduct()"
              >
                <div class="tw-flex tw-items-start tw-justify-between tw-mb-3">
                  <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">
                    Products
                  </h3>
                  <i
                    class="fas fa-edit tw-text-gray-400 group-hover:tw-text-gray-600 tw-text-sm tw-opacity-0 tw-transition-all tw-duration-200 group-hover:tw-opacity-100"
                  ></i>
                </div>

                <div *ngIf="!lead.product || lead.product.length === 0" class="tw-text-gray-500 tw-italic">
                  No products added
                </div>
                <div *ngIf="lead.product && lead.product.length > 0" class="tw-space-y-2">
                  <div *ngFor="let item of lead.product; trackBy: trackByProductId" class="tw-flex tw-items-center tw-space-x-4 tw-p-2 tw-bg-gray-50 tw-rounded">
                    <span class="tw-font-medium">{{ item.name }}</span>
                    <span class="tw-text-gray-600">{{ item.prise }}</span>
                    <span class="tw-text-gray-600">Qty: {{ item.quantity }}</span>
                  </div>
                </div>
              </div>

              <!-- Product Edit Mode -->
              <div *ngIf="isEditingProduct" class="tw-space-y-4">
                <div class="tw-flex tw-items-center tw-justify-between">
                  <h3 class="tw-text-lg tw-font-semibold tw-text-gray-900">
                    Edit Products
                  </h3>
                  <div class="tw-flex tw-items-center tw-space-x-2">
                    <button
                      type="button"
                      (click)="saveProduct()"
                      [disabled]="isSavingProduct"
                      class="tw-px-4 tw-py-2 tw-bg-blue-600 tw-text-white tw-text-sm tw-font-medium tw-rounded-lg hover:tw-bg-blue-700 disabled:tw-bg-gray-300 disabled:tw-cursor-not-allowed tw-transition-colors tw-duration-200 tw-flex tw-items-center tw-space-x-2"
                    >
                      <i
                        *ngIf="isSavingProduct"
                        class="fas fa-spinner fa-spin"
                      ></i>
                      <span>{{
                        isSavingProduct ? "Saving..." : "Save"
                      }}</span>
                    </button>

                    <button
                      type="button"
                      (click)="cancelProductEdit()"
                      [disabled]="isSavingProduct"
                      class="tw-px-4 tw-py-2 tw-bg-gray-100 tw-text-gray-700 tw-text-sm tw-font-medium tw-rounded-lg hover:tw-bg-gray-200 disabled:tw-opacity-50 tw-transition-colors tw-duration-200"
                    >
                      Cancel
                    </button>
                  </div>
                </div>

                <div class="tw-space-y-3">
                  <div *ngFor="let item of editProduct; trackBy: trackByProductId; let i = index" class="tw-flex tw-items-center tw-space-x-2 tw-p-3 tw-bg-gray-50 tw-rounded">
                    <input
                      type="text"
                      [(ngModel)]="item.name"
                      placeholder="Product name"
                      class="tw-flex-1 tw-rounded-md tw-border-gray-300 tw-shadow-sm focus:tw-border-blue-500 focus:tw-ring-blue-500 sm:tw-text-sm"
                    />
                    <input
                      type="text"
                      [(ngModel)]="item.prise"
                      placeholder="Price"
                      class="tw-w-24 tw-rounded-md tw-border-gray-300 tw-shadow-sm focus:tw-border-blue-500 focus:tw-ring-blue-500 sm:tw-text-sm"
                    />
                    <input
                      type="text"
                      [(ngModel)]="item.quantity"
                      placeholder="Qty"
                      class="tw-w-20 tw-rounded-md tw-border-gray-300 tw-shadow-sm focus:tw-border-blue-500 focus:tw-ring-blue-500 sm:tw-text-sm"
                    />
                    <button
                      type="button"
                      (click)="removeProductItem(i)"
                      class="tw-p-1 tw-text-red-600 hover:tw-text-red-800"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                  <button
                    type="button"
                    (click)="addProductItem()"
                    class="tw-px-3 tw-py-2 tw-bg-green-100 tw-text-green-700 tw-rounded-md hover:tw-bg-green-200 tw-transition-colors tw-duration-200"
                  >
                    <i class="fas fa-plus tw-mr-2"></i>Add Product
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Attachments Tab -->
        <div
          *ngIf="currentTab === 'attachments'"
          class="tw-h-full tw-flex tw-flex-col"
        >
          <!-- Attachments List -->
          <div
            class="tw-flex-1 tw-overflow-y-auto tw-p-4 md:tw-p-6 tw-space-y-4"
          >
            <!-- No Attachments State -->
            <div
              *ngIf="!lead.attachments || lead.attachments.length === 0"
              class="tw-text-center tw-py-12"
            >
              <div
                class="tw-w-16 tw-h-16 tw-bg-gray-100 tw-rounded-full tw-flex tw-items-center tw-justify-center tw-mx-auto tw-mb-4"
              >
                <i class="fas fa-paperclip tw-text-gray-400 tw-text-xl"></i>
              </div>
              <h3 class="tw-text-lg tw-font-medium tw-text-gray-900 tw-mb-2">
                No attachments yet
              </h3>
              <p class="tw-text-gray-500">
                Upload files to keep them organized with this lead.
              </p>
            </div>

            <!-- Attachments -->
            <div
              *ngFor="let attachment of lead.attachments; trackBy: trackByProductId"
              class="tw-flex tw-items-center tw-justify-between tw-p-3 tw-bg-gray-50 tw-rounded-lg"
            >
              <div class="tw-flex tw-items-center tw-space-x-3">
                <i class="fas fa-file tw-text-gray-400"></i>
                <div>
                  <p class="tw-text-sm tw-font-medium tw-text-gray-900">{{ attachment.fileName }}</p>
                  <p class="tw-text-xs tw-text-gray-500">
                    Uploaded by {{ attachment.uploadedBy.name }} on {{ formatDate(attachment.createdAt) }}
                  </p>
                </div>
              </div>
              <a
                [href]="attachment.fileUrl"
                target="_blank"
                class="tw-p-2 tw-text-blue-600 hover:tw-text-blue-800 tw-transition-colors tw-duration-200"
              >
                <i class="fas fa-download"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
