<!-- Public Chat Modal -->
<div
  class="tw-fixed tw-inset-0 tw-bg-black tw-bg-opacity-50 tw-flex tw-items-center tw-justify-center tw-z-50 tw-p-4 md:tw-p-6"
  (click)="closePopup()"
>
  <!-- Modal Container - Fixed size on desktop, full screen on mobile -->
  <div
    class="tw-bg-white tw-rounded-none md:tw-rounded-2xl tw-shadow-2xl tw-w-full tw-h-full md:tw-w-[600px] md:tw-h-[700px] tw-flex tw-flex-col tw-overflow-hidden tw-animate-scale-in"
    (click)="$event.stopPropagation()"
  >
    <!-- Header -->
    <div
      class="tw-flex tw-items-center tw-justify-between tw-p-4 md:tw-p-6 tw-border-b tw-border-gray-200 tw-bg-gray-50"
    >
      <div class="tw-flex tw-items-center tw-space-x-3">
        <div
          class="tw-w-8 tw-h-8 tw-bg-blue-500 tw-rounded-lg tw-flex tw-items-center tw-justify-center"
        >
          <i class="fas fa-comments tw-text-white tw-text-sm"></i>
        </div>
        <div>
          <span class="tw-text-lg tw-font-semibold tw-text-gray-900">Board Chat</span>
          <div class="tw-text-sm tw-text-gray-500">
            {{ getActiveCommentsCount() }} message{{ getActiveCommentsCount() !== 1 ? 's' : '' }}
          </div>
        </div>
      </div>

      <button
        type="button"
        class="tw-p-2 tw-text-gray-400 hover:tw-text-gray-600 hover:tw-bg-gray-200 tw-rounded-lg tw-transition-all tw-duration-200"
        (click)="closePopup()"
      >
        <i class="fas fa-times tw-text-lg"></i>
      </button>
    </div>

    <!-- Loading State -->
    <div
      *ngIf="isLoading"
      class="tw-flex tw-items-center tw-justify-center tw-h-full tw-w-full"
    >
      <div
        class="tw-w-8 tw-h-8 tw-border-4 tw-border-blue-500 tw-border-t-transparent tw-rounded-full tw-animate-spin"
      ></div>
    </div>

    <!-- Chat Content -->
    <div *ngIf="!isLoading" class="tw-flex-1 tw-flex tw-flex-col tw-overflow-hidden">
      <!-- Messages List -->
      <div
        id="chatCommentsList"
        class="tw-flex-1 tw-overflow-y-auto tw-p-4 md:tw-p-6 tw-space-y-4"
      >
        <!-- No Messages State -->
        <div
          *ngIf="comments.length === 0"
          class="tw-text-center tw-py-12"
        >
          <div
            class="tw-w-16 tw-h-16 tw-bg-gray-100 tw-rounded-full tw-flex tw-items-center tw-justify-center tw-mx-auto tw-mb-4"
          >
            <i class="fas fa-comments tw-text-gray-400 tw-text-xl"></i>
          </div>
          <h3 class="tw-text-lg tw-font-medium tw-text-gray-900 tw-mb-2">
            No messages yet
          </h3>
          <p class="tw-text-gray-500">
            Start the conversation by sending a message below.
          </p>
        </div>

        <!-- Messages -->
        <div
          *ngFor="let comment of comments; trackBy: trackByCommentId"
          class="tw-group"
        >
          <div
            *ngIf="!comment.isDeleted"
            style="display: flex"
            [ngClass]="{
              'tw-justify-end':
                comment.createdBy._id ===
                taskPermissionsService.getCurrentUser()?._id,
              'tw-justify-start':
                comment.createdBy._id !==
                taskPermissionsService.getCurrentUser()?._id
            }"
          >
            <img
              *ngIf="
                comment.createdBy._id !==
                taskPermissionsService.getCurrentUser()?._id
              "
              class="tw-w-10 tw-h-10 tw-rounded-full tw-mr-2 tw-mt-1"
              [src]="imageBaseUrl + comment.createdBy.profileImage"
              alt="User Avatar"
            />
            <div
              [ngClass]="{
                'tw-bg-blue-100 tw-text-black':
                  comment.createdBy._id ===
                  taskPermissionsService.getCurrentUser()?._id,
                'tw-bg-gray-100 tw-text-gray-900':
                  comment.createdBy._id !==
                  taskPermissionsService.getCurrentUser()?._id
              }"
              class="tw-max-w-xs md:tw-max-w-md tw-px-4 tw-py-3 tw-rounded-2xl tw-relative tw-shadow-sm"
            >
              <div
                class="tw-flex tw-items-center tw-space-x-2 tw-mb-2 tw-w-full tw-text-gray-600"
                *ngIf="
                  comment.createdBy._id !==
                  taskPermissionsService.getCurrentUser()?._id
                "
              >
                <span class="tw-font-medium tw-text-sm">
                  {{ comment.createdBy.name }}
                </span>
              </div>
              <!-- Message content -->
              <div
                class="tw-text-sm tw-leading-relaxed tw-break-words"
                [innerHTML]="
                  formatComment(
                    comment._id,
                    comment.text,
                    comment.mentionedMembers,
                    comment.createdBy._id
                  )
                "
              ></div>

              <!-- Message footer -->
              <div
                class="tw-flex tw-items-center tw-justify-between tw-mt-2 tw-pt-2 tw-border-t tw-border-opacity-20"
                [ngClass]="{
                  'tw-border-white':
                    comment.createdBy._id ===
                    taskPermissionsService.getCurrentUser()?._id,
                  'tw-border-gray-300':
                    comment.createdBy._id !==
                    taskPermissionsService.getCurrentUser()?._id
                }"
              >
                <div class="tw-flex tw-items-center tw-space-x-2">
                  <span class="tw-text-xs tw-opacity-75">
                    {{ formatDate(comment.createdAt) }}
                  </span>
                </div>

                <!-- Delete button on hover -->
                <button
                  *ngIf="
                    comment.createdBy._id ===
                    taskPermissionsService.getCurrentUser()?._id
                  "
                  (click)="deleteComment(comment._id)"
                  title="Delete Message"
                  class="tw-opacity-0 group-hover:tw-opacity-100 tw-p-1 tw-rounded tw-transition-all tw-duration-200 hover:tw-bg-white hover:tw-bg-opacity-20 tw-text-gray-500 hover:tw-text-red-600"
                >
                  <i class="fas fa-trash tw-text-xs"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Deleted message -->
          <div *ngIf="comment.isDeleted" class="tw-flex tw-justify-center">
            <div
              class="tw-bg-gray-50 tw-text-gray-500 tw-px-4 tw-py-2 tw-rounded-lg tw-text-sm tw-italic"
            >
              <i class="fas fa-ban tw-mr-2"></i>
              Deleted message
            </div>
          </div>
        </div>
      </div>

      <!-- Add Message Section -->
      <div class="tw-border-t tw-border-gray-200 tw-p-4 tw-bg-gray-50">
        <app-add-comments
          [boardId]="boardId"
          [type]="'board'"
          [taskPermissions]="chatPermissions"
          (messageSent)="onCommentAdded($event)"
        >
        </app-add-comments>
      </div>
    </div>
  </div>
</div>

<!-- Mobile-specific styles -->
<style>
  @media (max-width: 768px) {
    .tw-animate-scale-in {
      animation: none;
    }
  }

  .tw-animate-scale-in {
    animation: scaleIn 0.2s ease-out;
  }

  @keyframes scaleIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
</style>